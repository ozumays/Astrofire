{% extends "layout.html" %}

{% block content %}

<div class="library-container" id="libraryContainer">
    
    <div class="library-sidebar" id="librarySidebar">
    
    <div style="padding: 10px; border-bottom: 1px solid #eee;">
        <button onclick="openSearchModal()" class="btn-advanced-search">
        <i class="fas fa-search"></i> Gelişmiş Arama / Filtrele
        </button>
    </div>
    
    <div class="sidebar-tree">
        <details class="main-category">
    <summary class="main-summary">
        <i class="fas fa-users"></i> Tüm Haritalar
    </summary>
    <div class="main-content">
        {% set flat_list = [] %}
        
        {# Önce ağaçtaki tüm haritaları tek bir listede toplayalım #}
        {% if chart_tree %}
            {% for asc_key, sun_dict in chart_tree.items() %}
                {% for sun_key, charts in sun_dict.items() %}
                    {% for chart in charts %}
                        {% if chart not in flat_list %}
                            {% do flat_list.append(chart) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        {% endif %}

        {# Şimdi bu listeyi alfabetik isim sırasına göre yazdıralım #}
        {% if flat_list %}
            {% for chart in flat_list|sort(attribute='name') %}
                <a href="{{ url_for('page_data', id=chart.id) }}"
                   class="chart-link {% if selected_chart and selected_chart.id == chart.id %}active{% endif %}">
                    <i class="fas fa-user-circle"></i> 
                    <div style="display: flex; flex-direction: column;">
                        <span class="chart-name">{{ chart.name }}</span>
                        <span style="font-size: 10px; opacity: 0.6;">{{ chart.year }}</span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <p style="padding:10px; font-size:11px; color:#999;">Görüntülenecek veri yok.</p>
        {% endif %}
    </div>
</details>

        <details class="main-category" open> <summary class="main-summary">
                <i class="fas fa-star"></i> Yükselene Göre
            </summary>
            <div class="main-content">
                {% if chart_tree %}
                    {% for asc_name in zodiac_order %}
                        {% set asc_key = "Yükselen " + asc_name %}
                        {% if chart_tree[asc_key] %}
                        <details class="folder-level-1">
                            <summary>
                                <span style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-folder" style="color: #f39c12;"></i> {{ asc_key }}
                                </span>
                            </summary>
                            <div class="folder-content-1">
                                {% for sun_name in zodiac_order %}
                                    {% set sun_key = "Güneş " + sun_name %}
                                    {% if chart_tree[asc_key][sun_key] %}
                                    <details class="folder-level-2">
                                        <summary>
                                            <span style="display: flex; align-items: center; gap: 6px;">
                                                <i class="fas fa-folder-open" style="color: #3498db;"></i> {{ sun_key }}
                                            </span>
                                        </summary>
                                        <div class="folder-content-2">
                                    {% for chart in chart_tree[asc_key][sun_key] %}
                                        <a href="{{ url_for('page_data', id=chart.id) }}"
                                    class="chart-link {% if selected_chart and selected_chart.id == chart.id %}active{% endif %}">
                                        <i class="fas fa-user-tag"></i> 
                                        <div style="display: flex; flex-direction: column;">
                                            <span class="chart-name">{{ chart.name }}</span>
                                            <span style="font-size: 10px; opacity: 0.6;">{{ chart.year }}</span>
                                            </div>
                                            </a>
                                        {% endfor %}
                                        </div>
                                    </details>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </details>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </details>
    </div>
</div>

<div id="lib-toggle" onclick="toggleLibrarySidebar()">
    <i class="fas fa-chevron-left" id="toggleIcon"></i>
</div>
<div class="library-content-wrapper">
        {% if selected_chart %}
            
            <div class="profile-card-sticky">
    <div class="header-row">
        <h1 class="chart-title">{{ selected_chart.name }}</h1>
        <a href="{{ url_for('load_public_chart', id=selected_chart.id) }}" class="btn-open-active">
            AKTİF BÖLÜMDE AÇ <i class="fas fa-external-link-alt"></i>
        </a>
    </div>
                <div class="birth-details-row">
                    <span><i class="far fa-calendar-alt"></i> {{ selected_chart.day }}.{{ selected_chart.month }}.{{ selected_chart.year }}</span>
                    <span class="separator">|</span>
                    <span><i class="far fa-clock"></i> {{ "%02d:%02d"|format(selected_chart.hour, selected_chart.minute) }}</span>
                    <span class="separator">|</span>
                    <span><i class="fas fa-map-marker-alt"></i> {{ selected_chart.location_name }}</span>
                    <span style="font-size: 13px; color: #e6d8d8; margin-bottom: 10px; margin-left: 2px;">(UTC {{ selected_chart.tz }})</span>
                </div>

                <div class="chart-wheel-box">
                     <svg id="astroChart" viewBox="0 0 400 400" style="width: 100%; height: 100%;"></svg>
                </div>

            </div>

            <div class="biography-panel">
                <div class="bio-header-row">
                    <h1 class="bio-title">
                        <i class="fas fa-book-open" style="color: #3498db; font-size: 18px; margin-right: 8px;"></i>
                        Hayat Hikayesi
                    </h1>
                </div>
                
                {% if selected_chart.bio_images %}
                    <div class="bio-gallery">
                        {% for img in selected_chart.bio_images %}
                            {% if img %}
                                <div class="gallery-item">
                                    <img src="{{ url_for('static', filename='uploads/charts/' + img) }}" onclick="window.open(this.src)">
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="story-text">
                    {% if selected_chart.bio %}
                        {{ selected_chart.bio | replace('\n', '<br>') | safe }}
                    {% else %}
                        <div style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-feather-alt" style="font-size: 30px; margin-bottom: 10px;"></i>
                            <p>Bu kişi için henüz bir biyografi girilmemiş.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        {% else %}
            <div class="empty-state-container">
                <div class="empty-state-box">
                    <i class="fas fa-folder-open" style="font-size: 50px; color: #dcdcdc; margin-bottom: 20px;"></i>
                    <h2 style="font-size: 20px; margin-bottom: 10px; color: #556677;">Veri Bankası</h2>
                    <p style="font-size: 14px; color: #999;">Sol menüden bir kişi seçerek profilini ve haritasını görüntüleyebilirsiniz.</p>
                </div>
            </div>
        {% endif %}
    </div>

</div>

<div id="searchModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:#2c3e50;"><i class="fas fa-filter text-blue-600"></i> Gelişmiş Arama</h3>
            <span onclick="closeSearchModal()" style="cursor:pointer; font-size:20px; color:#999;">✕</span>
        </div>
        <div id="filterContainer" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="addFilterRow()" style="margin-top:10px; background:#f0f9ff; color:#0284c7; border:1px dashed #0284c7; padding:8px; width:100%; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;">+ YENİ KRİTER EKLE</button>
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="resetFilters()" style="background:#f1f5f9; color:#64748b; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Temizle</button>
            <button onclick="runSearch()" style="background:#2563eb; color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer;">ARA</button>
        </div>
        <div id="searchResults" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <p style="text-align:center; color:#999; font-size:13px;">Kriterleri girip ARA butonuna basın.</p>
        </div>
    </div>
</div>

<script src="https://cdn.tailwindcss.com"></script>
<script>
    // --- SIDEBAR TOGGLE ---
    function toggleLibrarySidebar() {
        const container = document.getElementById('libraryContainer');
        const icon = document.getElementById('toggleIcon');
        container.classList.toggle('sidebar-closed');
        if (container.classList.contains('sidebar-closed')) {
            icon.classList.remove('fa-chevron-left'); icon.classList.add('fa-chevron-right');
        } else {
            icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-left');
        }
    }

    // --- ARAMA MODALI JS ---
    const PLANETS = ["Hepsi", "Güneş", "Ay", "Merkür", "Venüs", "Mars", "Jüpiter", "Satürn", "Uranüs", "Neptün", "Plüton", "Kuzey Düğümü", "Chiron", "Lilith (Asteroid)"];
    const SIGNS = ["Hepsi", "Koç", "Boğa", "İkizler", "Yengeç", "Aslan", "Başak", "Terazi", "Akrep", "Yay", "Oğlak", "Kova", "Balık"];

    function openSearchModal() {
        document.getElementById('searchModal').style.display = 'flex';
        if(document.getElementById('filterContainer').children.length === 0) addFilterRow();
    }
    function closeSearchModal() { document.getElementById('searchModal').style.display = 'none'; }

    function addFilterRow() {
        const container = document.getElementById('filterContainer');
        const row = document.createElement('div');
        row.className = "filter-row";
        row.style.display = "flex"; row.style.gap = "10px"; row.style.alignItems = "center"; row.style.background = "#f8fafc"; row.style.padding = "10px"; row.style.borderRadius = "6px";

        let planetOpts = PLANETS.map(p => `<option value="${p}">${p}</option>`).join('');
        let signOpts = SIGNS.map(s => `<option value="${s}">${s}</option>`).join('');

        row.innerHTML = `
            <select class="filter-planet" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">${planetOpts}</select>
            <span style="font-size:12px; color:#999;">burcu</span>
            <select class="filter-sign" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">${signOpts}</select>
            <input type="number" class="filter-deg" placeholder="Derece (Opsiyonel)" min="0" max="29" style="width:120px; padding:8px; border:1px solid #ddd; border-radius:4px;">
            <button onclick="this.parentElement.remove()" style="color:#ef4444; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(row);
    }

    function resetFilters() {
        document.getElementById('filterContainer').innerHTML = '';
        document.getElementById('searchResults').innerHTML = '';
        addFilterRow();
    }

    function runSearch() {
        const rows = document.querySelectorAll('.filter-row');
        let filters = [];
        rows.forEach(row => {
            const p = row.querySelector('.filter-planet').value;
            const s = row.querySelector('.filter-sign').value;
            const d = row.querySelector('.filter-deg').value;
            if(p === 'Hepsi' && s === 'Hepsi' && d === '') return;
            filters.push({ planet: p, sign: s, degree: d });
        });

        const resArea = document.getElementById('searchResults');
        resArea.innerHTML = '<div style="text-align:center; padding:20px; color:#3498db;"><i class="fas fa-spinner fa-spin"></i> Taranıyor...</div>';

        fetch('/api/search_database', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filters: filters })
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                if(data.count === 0) {
                    resArea.innerHTML = '<p style="text-align:center; color:#999;">Sonuç bulunamadı.</p>';
                    return;
                }
                let html = `<p style="color:#16a34a; font-weight:bold; margin-bottom:10px;">${data.count} kişi bulundu.</p>`;
                html += '<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">';
                data.results.forEach(c => {
                    let imgPath = c.image ? `/static/uploads/charts/${c.image}` : null;
                    let avatarHtml = imgPath ? `<img src="${imgPath}" class="w-full h-full object-cover">` : `<span class="text-lg font-bold text-slate-400">${c.name.charAt(0)}</span>`;
                    html += `
                    <div onclick="window.location.href='/page_data?id=${c.id}'"
                         style="background:white; border:1px solid #eee; padding:10px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:10px; transition:0.2s;"
                         onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                        <div style="width:30px; height:30px; background:#eee; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#999;">${avatarHtml}</div>
                        <div>
                            <div style="font-weight:bold; font-size:13px;">${c.name}</div>
                            <div style="font-size:10px; color:#888;">${c.year}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                resArea.innerHTML = html;
            } else {
                resArea.innerHTML = `<p style="color:red;">Hata: ${data.error}</p>`;
            }
        });
    }

    // =============================================================
    // HARİTA ÇİZİM MOTORU
    // =============================================================
    {% if last_chart %}
        const chartDataRaw = '{{ last_chart | tojson | safe }}';
        const chartData = chartDataRaw && chartDataRaw !== 'null' ? JSON.parse(chartDataRaw) : null;
        
        const PLANET_IMAGE_MAP = { "Güneş": "{{ url_for('static', filename='images/semboller/gunes.svg') }}", "Ay": "{{ url_for('static', filename='images/semboller/ay.svg') }}", "Merkür": "{{ url_for('static', filename='images/semboller/merkur.svg') }}", "Venüs": "{{ url_for('static', filename='images/semboller/venus.svg') }}", "Mars": "{{ url_for('static', filename='images/semboller/mars.svg') }}", "Jüpiter": "{{ url_for('static', filename='images/semboller/jupiter.svg') }}", "Satürn": "{{ url_for('static', filename='images/semboller/saturn.svg') }}", "Uranüs": "{{ url_for('static', filename='images/semboller/uranus.svg') }}", "Neptün": "{{ url_for('static', filename='images/semboller/neptun.svg') }}", "Plüton": "{{ url_for('static', filename='images/semboller/pluton.svg') }}", "Kuzey Düğümü": "{{ url_for('static', filename='images/semboller/kuzey_dugumu.svg') }}", "Güney Düğümü": "{{ url_for('static', filename='images/semboller/guney_dugumu.svg') }}", "Şans Noktası": "{{ url_for('static', filename='images/semboller/sans_noktasi.svg') }}", "Chiron": "{{ url_for('static', filename='images/semboller/chiron.svg') }}", "Ceres": "{{ url_for('static', filename='images/semboller/ceres.svg') }}", "Pallas": "{{ url_for('static', filename='images/semboller/pallas.svg') }}", "Juno": "{{ url_for('static', filename='images/semboller/juno.svg') }}", "Vesta": "{{ url_for('static', filename='images/semboller/vesta.svg') }}", "Eris": "{{ url_for('static', filename='images/semboller/eris.svg') }}", "Makemake": "{{ url_for('static', filename='images/semboller/makemake.svg') }}", "Haumea": "{{ url_for('static', filename='images/semboller/haumea.svg') }}" };
        const ZODIAC_IMAGE_MAP = { "Koç": "{{ url_for('static', filename='images/semboller/koc.svg') }}", "Boğa": "{{ url_for('static', filename='images/semboller/boga.svg') }}", "İkizler": "{{ url_for('static', filename='images/semboller/ikizler.svg') }}", "Yengeç": "{{ url_for('static', filename='images/semboller/yengec.svg') }}", "Aslan": "{{ url_for('static', filename='images/semboller/aslan.svg') }}", "Başak": "{{ url_for('static', filename='images/semboller/basak.svg') }}", "Terazi": "{{ url_for('static', filename='images/semboller/terazi.svg') }}", "Akrep": "{{ url_for('static', filename='images/semboller/akrep.svg') }}", "Yay": "{{ url_for('static', filename='images/semboller/yay.svg') }}", "Oğlak": "{{ url_for('static', filename='images/semboller/oglak.svg') }}", "Kova": "{{ url_for('static', filename='images/semboller/kova.svg') }}", "Balık": "{{ url_for('static', filename='images/semboller/balik.svg') }}" };
        const SYMBOL_SIZE = 13; const PLANET_SIGN_SYMBOL_SIZE = 13; const CUSP_SIGN_SYMBOL_SIZE = 11; const CUSP_TEXT_OFFSET = 15; const svg = document.getElementById('astroChart'); const cx = 200; const cy = 200; const R_ZODIAC_OUTER = 195; const R_ZODIAC_INNER = 175; const R_HOUSE_LABELS = 25; const R_CUSP_SYMBOL_CENTER = 185; const R_PLANETS_AVG = 160; const R_PLANET_DEGREES = 140; const R_PLANET_SIGN = 122; const R_PLANET_MINUTE = 105; const R_PLANET_RETRO = 87; const R_INNER_RING = 32; const R_EXPANDED_BG = 80; const R_EXPANDED_PLANETS = 210; const R_PLANETS_INNER = 260; const R_PLANETS_OUTER = 345; const SVG_NS = "http://www.w3.org/2000/svg";
        
        let ascDegree = 0;
        if (chartData) {
            if (chartData.cusps) ascDegree = chartData.cusps['ASC'];
            else if (chartData.houses) ascDegree = chartData.houses['CUSP1'];
        }

        function getCoords(r, a) { const rad = (-((a - ascDegree + 360) % 360) + 180) * (Math.PI / 180); return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) }; }
        function createSvgElement(t, a) { const e = document.createElementNS(SVG_NS, t); for (let k in a) e.setAttribute(k, a[k]); return e; }
        function getAngleDiff(a, b) { let d = Math.abs(a - b); return Math.min(d, 360 - d); }
        function drawZodiac() { svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_OUTER, fill: 'white', stroke: 'none' })); svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_OUTER, fill: 'none', class: 'chart-line' })); svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_INNER, fill: 'none', class: 'chart-line' })); }
        
        function calculateDetails(absDeg, startDeg, signName) { let relDeg = absDeg - startDeg; if (relDeg < 0) relDeg += 360; const degrees = Math.floor(relDeg); const minutesDecimal = (relDeg - degrees) * 60; const minutes = Math.round(minutesDecimal); if (minutes === 60) { return { signName: signName, deg: degrees + 1, min: 0 }; } return { signName: signName, deg: degrees, min: minutes }; }
        function getRelativeDegreeJS(absDeg) { absDeg %= 360; let boundaries = []; if (typeof chartData !== 'undefined' && chartData.boundaries) { boundaries = chartData.boundaries; } else { boundaries = [ {name:"Koç", start:0, end:30}, {name:"Boğa", start:30, end:60}, {name:"İkizler", start:60, end:90}, {name:"Yengeç", start:90, end:120}, {name:"Aslan", start:120, end:150}, {name:"Başak", start:150, end:180}, {name:"Terazi", start:180, end:210}, {name:"Akrep", start:210, end:240}, {name:"Yay", start:240, end:270}, {name:"Oğlak", start:270, end:300}, {name:"Kova", start:300, end:330}, {name:"Balık", start:330, end:360} ]; } for (let i = 0; i < boundaries.length; i++) { const b = boundaries[i]; if (b.start < b.end) { if (absDeg >= b.start && absDeg < b.end) return calculateDetails(absDeg, b.start, b.name); } else { if (absDeg >= b.start || absDeg < b.end) return calculateDetails(absDeg, b.start, b.name); } } return { signName: "Bilinmeyen", deg: 0, min: 0 }; }
        
        let houseOverflowMap = {};
        function calculateHouseOverflows(planetsByHouse, hBounds) { const DEG_PER_PLANET = 8.0; houseOverflowMap = {}; for(let i=1; i<=12; i++) { let housePlanets = planetsByHouse[i] || []; let count = housePlanets.length; if (count === 0) continue; let bounds = hBounds[i-1]; let houseWidth = (bounds.end - bounds.start + 360) % 360; let requiredWidth = count * DEG_PER_PLANET; if (requiredWidth > houseWidth) { let extraSpace = requiredWidth - houseWidth + 2.0; houseOverflowMap[i] = extraSpace; } else { houseOverflowMap[i] = 0; } } }

        function drawHouses(hBounds) { const houses = chartData.houses; if (!houses) return []; svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_INNER_RING, fill: 'none', stroke: '#ff0000', 'stroke-width': '1', class: 'chart-line' })); if (!hBounds) { hBounds = []; for (let i = 1; i <= 12; i++) { const s = houses[`CUSP${i}`]; const e = houses[`CUSP${(i % 12) + 1}`]; if (s !== undefined) hBounds.push({ id: i, start: s, end: e }); } } for (let i = 1; i <= 12; i++) { const cuspDeg = houses[`CUSP${i}`]; if (cuspDeg === undefined) continue; const nextCusp = houses[`CUSP${(i % 12) + 1}`]; let overflow = houseOverflowMap[i] || 0; if (overflow > 0) { let pStart = getCoords(R_INNER_RING, cuspDeg); let pMidIn = getCoords(150, cuspDeg); let shiftedAngle = (cuspDeg - overflow + 360) % 360; let pMidOut = getCoords(150, shiftedAngle); let pEnd = getCoords(R_ZODIAC_INNER, shiftedAngle); let d = `M ${pStart.x} ${pStart.y} L ${pMidIn.x} ${pMidIn.y} L ${pMidOut.x} ${pMidOut.y} L ${pEnd.x} ${pEnd.y}`; svg.appendChild(createSvgElement('path', { d: d, class: 'house-cusp-stepped' })); } else { const p1 = getCoords(0, cuspDeg); const p2 = getCoords(R_ZODIAC_INNER, cuspDeg); svg.appendChild(createSvgElement('line', { x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y, class: 'house-cusp' })); } let diff = (nextCusp - cuspDeg + 360) % 360; let midAngle = (cuspDeg + diff / 2) % 360; if (getAngleDiff(cuspDeg, nextCusp) > 180) midAngle = (cuspDeg + diff / 2 + 180) % 360; const pLabelCoords = getCoords(R_HOUSE_LABELS, midAngle); const labelEl = createSvgElement('text', { x: pLabelCoords.x, y: pLabelCoords.y, class: 'house-label', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); labelEl.textContent = i; svg.appendChild(labelEl); const degreeInfo = getRelativeDegreeJS(cuspDeg); const signImageUrl = ZODIAC_IMAGE_MAP[degreeInfo.signName]; const mInt = degreeInfo.min; const minStr = (mInt < 10 ? '0' + mInt : '' + mInt); const pCuspSign = getCoords(R_CUSP_SYMBOL_CENTER, cuspDeg); const rotatedAngle = (cuspDeg - ascDegree + 360) % 360; const visualAngleRad = (-rotatedAngle + 180) * (Math.PI / 180); const perpAngleRad = visualAngleRad + (Math.PI / 2); const dx = CUSP_TEXT_OFFSET * Math.cos(perpAngleRad); const dy = CUSP_TEXT_OFFSET * Math.sin(perpAngleRad); let pCuspDegree, pCuspMinute; if (rotatedAngle > 180) { pCuspDegree = { x: pCuspSign.x - dx, y: pCuspSign.y - dy }; pCuspMinute = { x: pCuspSign.x + dx, y: pCuspSign.y + dy }; } else { pCuspDegree = { x: pCuspSign.x + dx, y: pCuspSign.y + dy }; pCuspMinute = { x: pCuspSign.x - dx, y: pCuspSign.y - dy }; } const cuspDegreeEl = createSvgElement('text', { x: pCuspDegree.x, y: pCuspDegree.y, class: 'cusp-degree', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); cuspDegreeEl.textContent = degreeInfo.deg + '°'; svg.appendChild(cuspDegreeEl); const cuspMinuteEl = createSvgElement('text', { x: pCuspMinute.x, y: pCuspMinute.y, class: 'cusp-minute', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); cuspMinuteEl.textContent = minStr + "'"; svg.appendChild(cuspMinuteEl); if (signImageUrl) { const cuspSignEl = createSvgElement('image', { href: signImageUrl, x: pCuspSign.x - (CUSP_SIGN_SYMBOL_SIZE/2), y: pCuspSign.y - (CUSP_SIGN_SYMBOL_SIZE/2), width: CUSP_SIGN_SYMBOL_SIZE, height: CUSP_SIGN_SYMBOL_SIZE }); svg.appendChild(cuspSignEl); } } return hBounds; }
        
        function drawSingleChartPlanets() { const planets = chartData.planets; const stars = chartData.fixed_stars || {}; let hBounds = []; for(let i=1; i<=12; i++) { let s = chartData.houses['CUSP'+i]; let e = chartData.houses['CUSP'+(i%12+1)]; if(s!==undefined) hBounds.push({id:i, start:s, end:e}); } let planetsByHouse = {}; for(let i=1; i<=12; i++) planetsByHouse[i] = []; for (const name of Object.keys(planets)) { const p_data = planets[name]; if (!PLANET_IMAGE_MAP[name]) continue; const houseNumber = parseInt(p_data[6], 10); planetsByHouse[houseNumber].push({ name, p_data, visualDeg: p_data[0], realDeg: p_data[0], type: 'planet', houseNum: houseNumber }); } calculateHouseOverflows(planetsByHouse, hBounds); drawHouses(hBounds); const planetsGroup = createSvgElement('g', { id: 'planets-group' }); svg.appendChild(planetsGroup); for (let i = 1; i <= 12; i++) { let housePlanets = planetsByHouse[i]; if (housePlanets.length === 0) continue; let bounds = hBounds[i-1]; let overflow = houseOverflowMap[i] || 0; let visualStart = (bounds.start - overflow + 360) % 360; let totalVisualWidth = ((bounds.end - bounds.start + 360) % 360) + overflow; housePlanets.sort((a, b) => a.realDeg - b.realDeg); let padding = 5.0; let step = (totalVisualWidth - (2 * padding)) / (housePlanets.length > 1 ? housePlanets.length - 1 : 1); if (housePlanets.length === 1) { housePlanets[0].visualDeg = (visualStart + totalVisualWidth / 2) % 360; } else { housePlanets.forEach((p, idx) => { p.visualDeg = (visualStart + padding + (idx * step)) % 360; }); } housePlanets.forEach(p => drawSinglePlanetDetailed(p, planetsGroup, R_PLANETS_AVG, false)); } }
        
        function drawSinglePlanetDetailed(item, container, radius, forceGuideline) { 
    const { name, p_data, visualDeg, realDeg, type } = item; 
    const rx = p_data[5]; 
    const signName = p_data[3]; 
    const signImageUrl = ZODIAC_IMAGE_MAP[signName]; 
    const planetGroup = createSvgElement('g', { class: 'planet-group', style: 'cursor: pointer;' }); 
    container.appendChild(planetGroup); 
    
    const pImage = getCoords(radius, visualDeg); 

    // Çizgi çeken (guideline) if bloğu buradan kaldırıldı.

    if (type === 'planet' && PLANET_IMAGE_MAP[name]) { 
        const imageUrl = PLANET_IMAGE_MAP[name]; 
        const imageEl = createSvgElement('image', { 
            href: imageUrl, 
            x: pImage.x - (SYMBOL_SIZE/2), 
            y: pImage.y - (SYMBOL_SIZE/2), 
            width: SYMBOL_SIZE, 
            height: SYMBOL_SIZE 
        }); 
        planetGroup.appendChild(imageEl); 
    } 
    
    const degText = p_data[4]; 
    let degStr = '0°'; 
    let minStr = "00'"; 
    if (degText && degText.includes('°')) { 
        const parts = degText.split('°'); 
        degStr = parts[0].trim() + '°'; 
        if (parts.length > 1 && parts[1].trim()) { 
            minStr = parts[1].trim(); 
            if (!minStr.includes("'")) minStr += "'"; 
        } 
    } 
    
    const pDegree = getCoords(R_PLANET_DEGREES, visualDeg); 
    const degreeEl = createSvgElement('text', { 
        x: pDegree.x, 
        y: pDegree.y, 
        class: 'planet-degree', 
        'text-anchor': 'middle', 
        'dominant-baseline': 'middle' 
    }); 
    degreeEl.textContent = degStr; 
    planetGroup.appendChild(degreeEl); 

    if (signImageUrl) { 
        const pSign = getCoords(R_PLANET_SIGN, visualDeg); 
        const signImageEl = createSvgElement('image', { 
            href: signImageUrl, 
            x: pSign.x - (PLANET_SIGN_SYMBOL_SIZE/2), 
            y: pSign.y - (PLANET_SIGN_SYMBOL_SIZE/2), 
            width: PLANET_SIGN_SYMBOL_SIZE, 
            height: PLANET_SIGN_SYMBOL_SIZE 
        }); 
        svg.appendChild(signImageEl); 
    } 
    
    const pMinute = getCoords(R_PLANET_MINUTE, visualDeg); 
    const minuteEl = createSvgElement('text', { 
        x: pMinute.x, 
        y: pMinute.y, 
        class: 'planet-minute', 
        'text-anchor': 'middle', 
        'dominant-baseline': 'middle' 
    }); 
    minuteEl.textContent = minStr; 
    planetGroup.appendChild(minuteEl); 

    if (rx) { 
        const pRetro = getCoords(R_PLANET_RETRO, visualDeg); 
        const retroEl = createSvgElement('text', { 
            x: pRetro.x, 
            y: pRetro.y, 
            class: 'planet-retrograde', 
            'text-anchor': 'middle', 
            'dominant-baseline': 'middle' 
        }); 
        retroEl.textContent = rx; 
        planetGroup.appendChild(retroEl); 
    } 
}
        if (chartData) { drawZodiac(); drawSingleChartPlanets(); }

        // Sayfa yüklendiğinde klasör durumlarını geri yükle
document.addEventListener("DOMContentLoaded", function() {
    // Kayıtlı durumları al
    const openFolders = JSON.parse(localStorage.getItem('openFolders') || '[]');
    
    // Her bir klasörü kontrol et, listede varsa aç
    document.querySelectorAll('details').forEach((details, index) => {
        if (openFolders.includes(index)) {
            details.open = true;
        }
    });

    // Klasör açılıp kapandığında durumu kaydet
    document.querySelectorAll('details').forEach((details, index) => {
        details.addEventListener('toggle', function() {
            let currentOpen = JSON.parse(localStorage.getItem('openFolders') || '[]');
            if (details.open) {
                if (!currentOpen.includes(index)) currentOpen.push(index);
            } else {
                currentOpen = currentOpen.filter(i => i !== index);
            }
            localStorage.setItem('openFolders', JSON.stringify(currentOpen));
        });
    });
});

    {% endif %}
</script>

<style>
    /* GENEL KONTEYNER VE ŞEFFAFLIK */
    .library-container {
        display: flex;
        background: rgba(0, 0, 0, 0);
        border: 1px solid rgba(0, 0, 0, 0.904) !important;
        border-radius: 0px;
        backdrop-filter: blur(10px);  
        position: fixed;
        top: 62px;
        bottom: 10px;
        left: 5px;
        right: 5px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        z-index: 1;
    }

    /* SOL PANEL (SIDEBAR) */
    .library-sidebar {
        width: 290px;
        min-width: 290px;
        background: transparent !important; /* Sidebar renginden bir ton koyu, daha belirgin */
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        transition: all 0.3s ease;
        overflow: hidden;
        box-sizing: border-box !important;
    }

    .main-summary { 
        list-style: none; 
        padding: 12px 10px; 
        background: transparent !important; /* Sidebar şeffaflığını bozmaması için */
        cursor: pointer; 
        font-weight: bold; 
        font-size: 13px; 
        color: #000000de; 
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }

    .profile-card-sticky {
    width: 510px;
    min-width: 510px;
    display: flex;
    flex-direction: column;
    align-items: center;      /* Yatayda (ortada) tutar */
    justify-content: flex-end; /* İçindeki her şeyi en alta iter */
    position: sticky;
    top: 0;
    padding-top: 20px;
    padding-right: 10px;
    padding-bottom: 0px;
    padding-left: 10px;
    background: rgba(0, 0, 0, 0.158) !important;
    border: 2px solid rgb(255, 255, 255) !important;
    z-index: 10;
}

    /* ÜST BÖLÜM HİZALAMA (İSİM SOLDA, BUTON SAĞDA) */
    .header-row {
        display: flex;
        justify-content: space-between; /* Sağa ve sola yaslar */
        align-items: center;
        width: 100%;
        margin-bottom: 15px;
    }

    .chart-title { 
        margin: 0; 
        font-size: 22px; 
        color: #f8f8f8; 
        font-weight: 800;
        margin-left: 5px !important;
    }

    /* DOĞUM BİLGİLERİ */
    .birth-details-row { 
        width: 100%; 
        display: flex; 
        justify-content: flex-start; 
        gap: 12px; 
        font-size: 13px; 
        color: #dbd4d4f1; 
        margin-bottom: 20px; /* Haritayı aşağı itmek için boşluk artırıldı */
        margin-left: 5px !important;
    }

    /* HARİTA KUTUSU VE KONUMU */
.chart-wheel-box {
    width: 100% !important;
    max-width: 500px; /* Panelin genişliğine (600px) uyum sağlaması için artırdık */
    aspect-ratio: 1 / 1;
    
    /* DİKEYDE EN ALTA İTMEK İÇİN: */
    margin-top: auto;   /* Üstteki tüm boşluğu doldurur ve kutuyu aşağı iter */
    margin-bottom: 1px !important; /* En alta tamamen sıfır yapışmasın diye küçük pay */
    
    /* YATAYDA ORTALAMAK İÇİN: */
    margin-left: auto;
    margin-right: auto;
    
    background: transparent !important;
    display: flex;
    justify-content: center;
    align-items: center;
}

    #astroChart {
        width: 100% !important;
        height: auto !important;
    }

    /* SAĞ TARAF (BİYOGRAFİ) */
    .biography-panel {
        flex: 1;
        background: rgba(255, 255, 255, 0.90) !important; /* Yazı okunurluğu için biraz daha koyu şeffaf */
        padding: 40px;
        height: 100%;
        overflow-y: auto;
    }
    /* Sidebar Kapalıyken İçeriği Gizle */
.library-container.sidebar-closed .library-sidebar { 
    width: 0 !important; 
    min-width: 0 !important; 
    border-right: none; 
    padding: 0; 
    margin: 0;
    opacity: 0;
}

/* İçerik alanının sidebar kapandığında genişlemesi */
.library-container.sidebar-closed .library-content-wrapper {
    width: 100% !important;
}

/* Toggle Tuşu Görünürlüğü */
#lib-toggle { 
    width: 25px; 
    background: #3498db; 
    color: white; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    border-right: 1px solid #2980b9; 
    font-size: 14px; 
    z-index: 100;
}

    /* DİĞER CSS ÖZELLİKLERİ (DEĞİŞMEDİ) */
    .main-category { border-bottom: 1px solid #8b8b8b36; margin-bottom: 2px; }
    /* Klasör başlıklarını (Summary) kutu haline getiriyoruz */
.main-summary {
    display: flex !important;
    align-items: center;
    gap: 10px;
    padding: 10px 12px !important;
    margin-bottom: 5px !important;
    background: rgb(140, 70, 30) !important;
    color: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 0px !important;
    cursor: pointer;
    font-size: 12px !important;
    transition: all 0.2s ease;
    list-style: none !important; /* Varsayılan oku gizle */
}

.folder-level-1 summary {
    display: flex !important;
    align-items: center;
    justify-content: center; 
    gap: 10px;
    width: 180px !important;
    min-width: 180px;
    
    /* SAĞA YASLAMA KURALI: */
    margin-left: auto !important;   /* Sol boşluğu otomatik yaparak sağa iter */
    margin-right: 5px !important;  /* Sağ kenara tamamen yapışmaması için küçük bir boşluk */
    
    padding: 10px 12px !important;
    margin-bottom: 5px !important;
    background: rgba(241, 178, 142, 0.829) !important;
    backdrop-filter: blur(5px) !important;
    color: #000000 !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 20px !important;
    font-weight: 500 !important;
    cursor: pointer;
    font-size: 12px !important;
    transition: all 0.2s ease;
    list-style: none !important;
}

.folder-level-2 summary {
    display: flex !important;
    align-items: center;
    justify-content: center; 
    gap: 10px;
    width: 150px !important;
    min-width: 150px;

    /* SAĞA YASLAMA KURALI: */
    margin-left: auto !important;   /* Sol boşluğu otomatik yaparak sağa iter */
    margin-right: 5px !important;  /* Sağ kenara tamamen yapışmaması için küçük bir boşluk */
    
    padding: 10px 12px !important;
    margin-bottom: 5px !important;
    background: rgba(255, 211, 185, 0.863) !important;
    backdrop-filter: blur(5px) !important;
    color: #000000 !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 20px !important;
    font-weight: 500 !important;
    cursor: pointer;
    font-size: 12px !important;
    transition: all 0.2s ease;
    list-style: none !important;
}

/* --- 1. ANA SUMMARY (Tüm Haritalar / Yükselene Göre) --- */
.main-summary {
    transition: all 0.3s ease;
}
.main-summary:hover {
    background: rgba(255, 255, 255, 0) !important;
    color: rgba(255, 255, 255, 1) !important;
    text-shadow: 0px 0px 8px #fff !important;
}

/* Hover Hali */
.folder-level-1 > summary:hover {
    background: rgba(202, 131, 90, 0.829) !important;
    color: #000 !important;
    transform: translateX(8px);
    display: inline-flex; /* transformun çalışması için gerekli */
}
/* AÇIK (Seçili) Hali */
details.folder-level-1[open] > summary {
    background: rgba(202, 131, 90, 0.829) !important;
    color: #000 !important;
    transform: translateX(8px);
    display: inline-flex; /* transformun çalışması için gerekli */
    font-weight: bold;
}

/* Hover Hali */
.folder-level-2 > summary:hover {
    background: rgba(248, 194, 162, 0.788) !important;
    transform: translateX(15px);
    color: #000 !important;
}
/* AÇIK (Seçili) Hali */
details.folder-level-2[open] > summary {
    background: rgba(248, 194, 162, 0.788) !important;
    color: #000 !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    transform: translateX(15px);
    display: inline-flex; /* transformun çalışması için gerekli */
}

/* Genel summary oku gizleme */
summary::-webkit-details-marker,
summary::marker {
    display: none;
}

/* Klasör açıkken rengini değiştirelim */
details[open] > summary {
    background: rgb(140, 70, 30) !important;
    color: #f8f8f8 !important;
}
    .main-content { padding-left: 5px; padding: 5px !important; display: flex; flex-direction: column; }
    .filter-row { display: flex; gap: 10px; align-items: center; background: #00000079; padding: 10px; border-radius: 0px; }
    .library-container.sidebar-closed .library-sidebar { width: 0; border-right: none; padding: 0; }
    /* Sidebar Açma-Kapama Butonu */
#lib-toggle { 
    width: 20px; /* Biraz genişlettik */
    background: rgb(140, 70, 30) !important;
    color: rgb(255, 255, 255); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    border-right: 1px solid rgb(140, 70, 30) !important;
    border-left: 1px solid rgb(140, 70, 30) !important;
    font-size: 11px; 
    transition: all 0.3s ease; 
    z-index: 100;
}

/* Hover durumunda buton rengi */
#lib-toggle:hover { 
    background: transparent !important;
    border-right: 1px solid rgba(0, 0, 0, 0);
    border-left: 1px solid rgba(0, 0, 0, 0); 
    color: #fff; 
}

/* Sidebar İçerik Alanı */
.sidebar-tree { 
    flex: 1; 
    width: 290px !important; /* Genişlettiğimiz yeni ölçü */
    background: transparent !important; /* Sidebar renginden bir ton koyu, daha belirgin */
    overflow-x: hidden; 
    overflow-y: auto; /* Dikey kaydırma aktif */
    padding: 8px; 
    box-sizing: border-box;
}
    .btn-open-active { background-color: #27ae60; color: white; text-decoration: none; font-size: 10px; font-weight: bold; padding: 6px 12px; border-radius: 0px; white-space: nowrap; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
    .btn-open-active:hover {
    background: #27ae5f00 !important;
    text-shadow: #0000009d 0px 0px 4px !important;
    color: rgba(0, 0, 0, 0.87) !important;
    }
    .bio-header-row { border-bottom: 2px solid #f0f2f5; margin-bottom: 20px; padding-bottom: 10px; }
    .bio-title { font-size: 22px; color: #fafafa !important; font-weight: 700; display: flex; align-items: center; }
    .bio-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 25px; }
    .gallery-item { height: 120px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; cursor: pointer; transition: transform 0.2s; }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .story-text { font-size: 15px; line-height: 1.8; color: #fafafa !important; text-align: justify; }
    
    /* SVG içindeki TÜM çizgileri (daire ve ev çizgileri) kapsar */
#astroChart circle, 
#astroChart line, 
#astroChart path,
#astroChart > circle {
    stroke: #030303b2 !important;   /* Hepsi aynı renk */
    stroke-width: 1px !important; /* Hepsi aynı incelik */
}
    .house-label { font-size: 8px; fill: #3b3b3ba6 !important}
    .planet-degree { font-size: 10px; fill: #272727;}
    .planet-minute { font-size: 9px; fill: #666;}
    .cusp-degree { font-size: 9.2px; fill: #202020 !important }
    .cusp-minute { font-size: 9px; fill: #777 !important }

    /* Kişi Listesi Kutu Tasarımı */
.chart-link {
    display: flex !important;
    align-items: center;
    gap: 10px;
    padding: 12px 15px !important; /* Kutunun iç genişliği */
    margin-bottom: 8px !important; /* Kutular arası boşluk */
    background: rgba(248, 194, 162, 0) !important;
    color: #fcfcfc !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 0px !important;
    text-decoration: none !important;
    font-size: 12px !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

/* Üzerine gelince kutunun rengi değişsin */
.chart-link:hover {
    background: rgba(0, 0, 0, 0.363) !important;
    color: #eeeeee !important;
    text-shadow: #e0e0e0 0px 0px 4px !important;
    border-color: #00000000 !important;
    transform: translateX(8px);
    display: inline-flex; /* transformun çalışması için gerekli */
}

/* Aktif (Seçili) Kişi Kutusu */
.chart-link.active {
    background: rgba(0, 0, 0, 0.363) !important;
    color: #eeeeee !important;
    text-shadow: #e0e0e0 0px 0px 4px !important;
    border-color: #00000000 !important;
    font-weight: bold !important;
    transform: translateX(8px);
    display: inline-flex; /* transformun çalışması için gerekli */
}

/* Kutu içindeki ikonların rengi */
.chart-link i {
    font-size: 14px;
    color: inherit;
}

.btn-advanced-search {
    width: 100%;
    background: #27ae5f00 !important;
    border: 1px solid #27ae5f00 !important;
    padding: 8px !important;
    border-radius: 0px !important;
    font-size: 12px !important;
    font-weight: 700 !important;
    color: #fcfcfc !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
    margin-top: 7px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.329) !important;
    margin-bottom: 5px;
}

.btn-advanced-search:hover {
    background: #27ae5f00 !important;
    border:none !important;
    text-shadow: #e0e0e0 0px 0px 4px !important;
    color: #ffffff !important;
}

.btn-advanced-search i {
    color: rgb(255, 255, 255) !important;
    font-size: 14px;
}

/* Genişleyen ev çizgilerinin içindeki siyah dolguyu kaldırır */
.house-cusp-stepped {
    fill: none !important;      /* İşte o siyahlığı silen komut bu! */
    stroke: #030303b2 !important; /* Çizginin kendisi kalsın */
    stroke-width: 1px !important;
}

.planet-retrograde {
    font-size: 9px !important;        /* R harfinin büyüklüğü */
    font-weight: bold !important;      /* Daha kalın görünmesi için */
    fill: #770a0a !important;           /* Genelde retro dikkat çeksin diye kırmızı yapılır */
    font-family: Arial, sans-serif !important;   /* Yazı tipi */
}

</style>

{% endblock %}
