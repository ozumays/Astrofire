<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro-Fire</title>
    <!-- Meta refresh kaldÄ±rÄ±ldÄ± - otomatik yenileme kapatÄ±ldÄ± -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style_modern.css') }}" onerror="console.log('CSS yÃ¼klenemedi')">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
    <style>
    /* =========================================
       1. SIFIRLAMA VE TEMEL AYARLAR
       ========================================= */
    * { 
        box-sizing: border-box; 
    }

    .video-overlay { 
        display: none; 
    }

    html, body { 
        margin: 0 !important; 
        padding: 0 !important;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: 'Segoe UI', sans-serif; 
        
        /* Arka Plan */
        background-image: url("{{ url_for('static', filename='images/backgrounds/bg-main.svg') }}");
        background-color: #f1f5f9;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        color: #1e293b;
    }

    /* =========================================
       2. HEADER VE NAVÄ°GASYON (Ãœst MenÃ¼)
       ========================================= */
    .main-header { 
        position: fixed;
        top: 0; left: 0; right: 0;
        height: 50px; 
        background: rgba(0, 0, 0, 0); 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid hsla(0, 0%, 100%, 0.116);
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 10px;
        z-index: 20;
        box-shadow: 0 4px 30px hsla(0, 0%, 0%, 0.1);
    }

    .logo-container {
        display: flex;
        align-items: center;
        height: 100%;
    }

    .logo-link {
        display: flex;
        align-items: center;
        text-decoration: none;
    }

    .logo-svg-main {
        height: 50px; 
        width: auto; 
        display: block;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        transition: opacity 0.3s ease;
    }

    .logo-svg-main:hover {
        opacity: 0.9; 
    }

    .main-nav { padding-top: 10px; }

    .nav-link { 
        margin-left: 13px; 
        text-decoration: none; 
        color: #ffffff; 
        font-size: 12px; 
        font-weight: 500; 
        transition: all 0.3s; 
        opacity: 0.8;
    }
    .nav-link:hover { 
        opacity: 1; color: #ffffff;
        border-bottom: 2px solid #ffffff;
        text-shadow: 
            0 0 1px rgb(230, 230, 230),    /* Keskin hat */
            0 0 5px rgb(230, 230, 230),    /* Orta parlama */
            0 0 15px rgba(255, 255, 255, 0.5),   /* GeniÅŸ yayÄ±lÄ±m */
            0 0 30px rgba(255, 255, 255, 0.3);   /* Uzak atmosfer */
    }
    
    .nav-link.active { 
        opacity: 1; 
        color: #ffffff; 
        border-bottom: 2px solid #ffffff; 
        padding-bottom: 5px; 
        font-weight: 700; 
    }

    /* KullanÄ±cÄ± Dropdown MenÃ¼ */
    .user-dropdown-menu {
        position: absolute;
        top: 43px;
        right: 0;
        background: rgba(26, 26, 26, 0.90) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 0px;
        box-shadow: 0 15px 35px rgba(255, 255, 255, 0.2);
        min-width: 200px;
        z-index: 10000;
        overflow: hidden;
    }

    .user-dropdown-menu a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        color: #ffffff;
        text-decoration: none;
        font-size: 13px;
        transition: background 0.3s;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .user-dropdown-menu a:last-child { border-bottom: none; }
    .user-dropdown-menu a:hover {
        background: rgba(228, 228, 228, 0.658);
        color: #ffffff;
    }
    .user-dropdown-menu a i {
        width: 18px;
        text-align: center;
        font-size: 14px;
        color: #ffffffcc;
    }

    /* Premium Ãœyelik Butonu */
    .premium-menu-item {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.8), rgba(217, 119, 6, 0.8)) !important;
        backdrop-filter: blur(4px);
        color: white !important;
        font-weight: bold;
    }
    .premium-menu-item:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    }
    .dropdown-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0;
    }

    /* =========================================
       3. ANA Ä°SKELET (LAYOUT & GRID)
       ========================================= */
    .main-container { 
        position: absolute;
        top: 45px; /* DÃœZELTÄ°LDÄ°: Header boyu kadar boÅŸluk */
        left: 10px;   
        right: 15px; 
        height: calc(100vh - 75px);
        display: flex; 
        align-items: stretch; 
        gap: 10px; 
        overflow: hidden; 
        z-index: 10;
        padding: 0;
    }

    .chart-content { 
        flex: 1; 
        min-width: 0; /* Flexbox sÄ±kÄ±ÅŸmasÄ±nÄ± Ã¶nler */
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        background: transparent; 
        position: relative; 
        overflow: hidden; 
        height: 100%;
        /* EKLEMEN GEREKEN KODLAR: */
        justify-content: flex-start !important; /* Ä°Ã§eriÄŸi dikeyde en tepeye yasla */
        padding-top: 0px !important;            /* Ãœst boÅŸluÄŸu sÄ±fÄ±rla */
    }

    .right-sidebar-wrapper { 
        display: flex; 
        flex-direction: row; 
        align-items: flex-start; 
        height: 100%; 
        flex-shrink: 0;
        transition: all 0.2s ease; 
        position: relative; 
        z-index: 50;
    }

    /* =========================================
       4. SOL PANEL GENEL YAPISI VE KUTULAR
       ========================================= */
    
    /* 1. ANA SOL PANEL (DIÅž TAÅžIYICI) */
    .sidebar-left { 
        width: 210px !important;
        min-width: 210px !important;
        max-width: 210px !important;
        height: 100%; 
        background: transparent !important; 
        border: none !important;
        backdrop-filter: none !important;
        padding: 10px; 
        overflow-y: auto; 
        flex-shrink: 0;
        
        display: flex;
        flex-direction: column;
        gap: 15px; /* Kutular arasÄ± boÅŸluk */
    }

    .sidebar-left > *:first-child {
        margin-top: 0 !important;
    }

    /* 2. TÃœM KUTULAR Ä°Ã‡Ä°N ORTAK "ZAMAN KAPSÃœLÃœ" TASARIMI */
    /* Time Capsule, Info Box ve Bottom Menu birebir aynÄ± gÃ¶rÃ¼nÃ¼r */
    .time-capsule-container,
    .transit-info-card-box, 
    .transit-info-container,
    .bottom-menu-container {
        /* Senin verdiÄŸin kodlar: */
        background: rgba(0, 0, 0, 0.274) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 12px;
        margin-bottom: 0; /* Parent gap kullanÄ±ldÄ±ÄŸÄ± iÃ§in margin'e gerek yok */
        display: flex;
        flex-direction: column;
        gap: 5px; 
        box-shadow: 1px 0px 3px rgba(138, 71, 17, 0.616);
        border-radius: 0px; /* Ä°Ã§eriklerle uyumlu olmasÄ± iÃ§in kÃ¶ÅŸeli */

        /* GENÄ°ÅžLEME Ä°Ã‡Ä°N EKLENEN KRÄ°TÄ°K KODLAR: */
        width: 100% !important;        /* Ä°Ã§inde bulunduÄŸu 250px'in tamamÄ±nÄ± kapla */
        box-sizing: border-box;       /* Padding (iÃ§ boÅŸluk) geniÅŸliÄŸi bozmasÄ±n */
        align-self: stretch;          /* Flex yapÄ±sÄ± iÃ§inde kendini sona kadar gerer */
    }

    /* =========================================
       5. Ä°Ã‡ERÄ°K DETAYLARI VE ZAMAN KAPSÃœLÃœ Ã–ZEL
       ========================================= */

    /* --- A. ZAMAN KAPSÃœLÃœ Ä°Ã‡ ELEMANLARI --- */
    .time-control-row {
        display: flex;
        justify-content: space-between;
        gap: 5px;
        margin-bottom: 5px; /* Alt satÄ±rla (form) arasÄ±nÄ± aÃ§ar */
    }

    .time-btn {
        background: rgba(0, 0, 0, 0.61) !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 25px;
        height: 25px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0px; /* KÃ¶ÅŸeli */
    }
    .time-btn:hover {
        color: #ffffff; 
        background: rgb(196, 92, 7) !important; 
        box-shadow: 0 0 15px rgb(196, 92, 7);
        
        /* DÃœZELTME: Sondaki fazladan virgÃ¼l kaldÄ±rÄ±ldÄ± */
        box-shadow: 
            0 0 1px rgb(230, 230, 230),    /* Keskin hat */
            0 0 3px rgb(230, 230, 230),    /* Orta parlama */
            0 0 7px rgba(255, 255, 255, 0.5),   /* GeniÅŸ yayÄ±lÄ±m */
    }

    .time-select {
        flex: 1;
        background: rgba(0, 0, 0, 0.61) !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        height: 25px;
        text-align: center;
        text-align-last: center; 
        outline: none;
        font-size: 11px;
        cursor: pointer;
        appearance: none; 
        border-radius: 0px;
    }

    .time-select:hover {
        color: #fffffff6; 
        background: rgb(196, 92, 7) !important; 
        box-shadow: 0 0 15px rgb(196, 92, 7);
        
        /* DÃœZELTME: Sondaki fazladan virgÃ¼l kaldÄ±rÄ±ldÄ± */
        text-shadow: 
            0 0 8px rgba(230, 230, 230, 0.884),    /* Keskin hat */
    }

    /* 1. KapsayÄ±cÄ± Form DÃ¼zenlemesi */
    .time-form-group {
        display: flex !important;
        flex-direction: row !important;
        gap: 5px;               /* Tarih alanÄ± ile buton arasÄ±ndaki boÅŸluk */
        width: 100%;            /* Kutunun tam geniÅŸliÄŸi */
        align-items: center;    /* Dikeyde tam hizalama */
        justify-content: space-between; /* Tarih alanÄ±nÄ± sola, butonu saÄŸa yaslar ama paylaÅŸtÄ±rÄ±r */
    }

    /* 2. Tarih GiriÅŸ AlanÄ± */
    .date-jump-input {
        flex: 1;                /* Kalan boÅŸluÄŸu kaplamasÄ±nÄ± saÄŸlar */
        background: rgba(0, 0, 0, 0.61) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: rgb(228, 218, 218);
        padding: 0 5px;
        outline: none;
        font-family: 'Segoe UI', sans-serif;
        font-size: 10px;
        font-weight: 720 !important;
        text-align: center; 
        border-radius: 0; 
        height: 24px;
        box-sizing: border-box;
        min-width: 0;           /* Esneklik iÃ§in gerekli */
        text-shadow: 
            0 0 2px rgba(0, 0, 0, 0.74),    /* Keskin hat */
    }

    .date-jump-input:hover { 
        color: #fffffff6; 
        background: rgb(196, 92, 7) !important; 
        box-shadow: 0 0 15px rgb(196, 92, 7);
        
        /* DÃœZELTME: Sondaki fazladan virgÃ¼l kaldÄ±rÄ±ldÄ± */
        text-shadow: 
            0 0 8px rgba(230, 230, 230, 0.884),    /* Keskin hat */
    }

    /* 3. GÄ°T Butonu (Tam OrtalanmÄ±ÅŸ Hali) */
    .btn-jump {
        background: rgba(196, 92, 7, 0.747) !important;  
        color: rgb(236, 236, 230);
        border: none;
        padding: 0; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 900;
        font-size: 10px;
        letter-spacing: 1px;
        width: 35px;            /* Sabit geniÅŸlik */
        height: 24px;           /* Input ile aynÄ± */
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        border-radius: 0; 
        flex-shrink: 0;         /* DaralmasÄ±nÄ± engeller */

        /* Ä°Ã‡ERÄ°K ORTALAMA */
        display: flex;
        align-items: center;
        justify-content: center;

        /* DIÅž ORTALAMA (Tarih ve SaÄŸ Kenar ArasÄ±) */
        margin-left: 5px;       /* Tarih kutusundan 5px uzaklÄ±k */
        margin-right: 2px;      /* SaÄŸ Ã§erÃ§eveden 2px uzaklÄ±k (GÃ¶rsel denge iÃ§in) */
    }

    .btn-jump:hover {
        background: rgb(196, 92, 7) !important; 
        box-shadow: 0 0 15px rgb(196, 92, 7); 
    }

    /* --- B. BÄ°LGÄ° KARTI Ä°Ã‡ ELEMANLARI (GÃœNCELLENDÄ°) --- */
    
    /* 1. YENÄ°: Ä°lk 3 bilgiyi saran BEYAZ KARE */
    .info-group-wrapper {
        border: 0.5px solid rgba(255, 255, 255, 0.25); /* Beyaz Ã‡erÃ§eve */
        background: rgba(0, 0, 0, 0.233);      /* Ã‡ok hafif iÃ§ dolgu */
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 10px;                              /* Ä°Ã§ boÅŸluk */
        border-radius: 0px;                         /* KÃ¶ÅŸeler */
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    /* 2. SatÄ±r AyarlarÄ± */
    .info-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: #ffffff;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1); /* SatÄ±r arasÄ± Ã§izgi */
        opacity: 0.9;
    }
    
    /* Karenin iÃ§indeki son satÄ±rÄ±n alt Ã§izgisini kaldÄ±r */
    .info-group-wrapper .info-row:last-child { 
        border-bottom: none; 
    }
    
    /* Genel Ä°kon AyarÄ± */
    .info-row i {
        width: 15px;
        text-align: center;
    }

    /* 1. ANLIK ZAMAN Ä°KONU (AÃ§Ä±k Mavi/Buz Rengi) */
    .info-row[title="AnlÄ±k Zaman"] i {
        color: #108383 !important; 
    }

    /* 2. KONUM Ä°KONU (KÄ±rmÄ±zÄ±/Harita Rengi) */
    .info-row[title="Konum"] i {
        color: #af1c1c !important; 
    }

    /* 3. ASC Ä°KONU (AltÄ±n/GÃ¼neÅŸ Rengi) */
    .info-row[title="ASC"] i {
        color: #beb30d !important; 
    }
    
    /* 3. Transit MenÃ¼sÃ¼ AlanÄ± (Karenin AltÄ±nda) */
    .info-card-menu-area {
        margin-top: 3px;       /* Kare ile arasÄ± boÅŸluk */
        padding-top: 5px;
        border-top: none;      /* Ãœst Ã§izgiyi kaldÄ±rdÄ±k, Ã§Ã¼nkÃ¼ karenin Ã§erÃ§evesi var */
    }

    /* TÄ±klanabilir Konum YazÄ±sÄ± Efekti */
    .info-clickable {
        cursor: pointer; /* Mouse el iÅŸareti olsun */
        transition: all 0.3s ease;
        position: relative;
        z-index: 10; /* TÄ±klamayÄ± garantiye al */
    }

    .info-clickable:hover {
        color: #ffffff; 
        background: transparent !important;
        transform: translateX(4px); /* Hafif kayma */
        
        /* DÃœZELTME: Sondaki fazladan virgÃ¼l kaldÄ±rÄ±ldÄ± */
        text-shadow: 
            0 0 1px rgb(230, 230, 230),    /* Keskin hat */
            0 0 5px rgb(230, 230, 230),    /* Orta parlama */
            0 0 15px rgba(255, 255, 255, 0.5),   /* GeniÅŸ yayÄ±lÄ±m */
            0 0 30px rgba(255, 255, 255, 0.3);   /* Uzak atmosfer */
    }

    /* --- C. MENÃœ LÄ°NKLERÄ° (KUTUSUZ) --- */
    .sidebar-link { 
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0; 
        color: rgb(255, 255, 255); 
        text-decoration: none; 
        font-size: 12px; 
        font-weight: 500; 
        transition: all 0.3s; 
        cursor: pointer; 
        
        /* Kutusuz gÃ¶rÃ¼nÃ¼m ayarlarÄ± */
        background: transparent !important;
        border: none !important;
        border-radius: 0;
        margin: 0;
    } 

    .sidebar-link:hover { 
        color: #ffffff; 
        background: transparent !important;
        transform: translateX(4px); /* Hafif kayma */
        
        /* DÃœZELTME: Sondaki fazladan virgÃ¼l kaldÄ±rÄ±ldÄ± */
        text-shadow: 
            0 0 1px rgb(230, 230, 230),    /* Keskin hat */
            0 0 5px rgb(230, 230, 230),    /* Orta parlama */
            0 0 15px rgba(255, 255, 255, 0.5),   /* GeniÅŸ yayÄ±lÄ±m */
            0 0 30px rgba(255, 255, 255, 0.3);   /* Uzak atmosfer */
    }
    
    .sidebar-link i {
        color: rgb(196, 92, 7) !important;
        width: 16px;
        text-align: center;
        transition: color 0.2s;
        text-shadow: none !important;
    }
    .sidebar-link:hover i { color: #ff9f43 !important; }

    .sidebar-link.active { 
        color: rgb(196, 92, 7) !important;
        font-weight: 700; 
    }
    
    /* Yan BaÅŸlÄ±klar */
    .sidebar-title { 
        font-size: 11px; 
        font-weight: 800; 
        color: #ffffff; 
        text-transform: uppercase; 
        margin: 5px 0; 
        letter-spacing: 1px; 
        opacity: 0.9; 
    }

    /* 1. SÄ°NASTRÄ° MODALÄ° */
#synastryModal .synastry-modal-box {
    background-image: url('/static/images/synastry-bg.svg') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

/* 2. GÃ–KYÃœZÃœ OLAYLARI MODALÄ° */
#celestialEventsModal .synastry-modal-box {
    background-image: url('/static/images/celestial-bg.svg') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

/* 3. SEÃ‡Ä°M MODALÄ° */
#selectionModal .modal-box {
    background-image: url('/static/images/selection-bg.svg') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

/* 4. RETURN MODALÄ° */
#returnModal .synastry-modal-box { /* Class ismi dÃ¼zeltildi */
    background-image: url('/static/images/return-bg.svg') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

/* 5. PROGRESSION (Ä°LERLETÄ°M) MODALÄ° - YENÄ° EKLENDÄ° */
#progressionModal .synastry-modal-box {
    background-image: url('/static/images/progression-bg.svg') !important; /* GÃ¶rsel ismini kontrol et */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

/* ============================================================
   1. ANA KUTU (Sadece Resim ve Ã‡erÃ§eve)
   ============================================================ */
#synastryModal .synastry-modal-box, 
#celestialEventsModal .synastry-modal-box, 
#selectionModal .modal-box,             /* <-- VirgÃ¼l eklendi */
#returnModal .synastry-modal-box,       /* <-- Class ismi dÃ¼zeltildi ve virgÃ¼l eklendi */
#progressionModal .synastry-modal-box { /* <-- YENÄ° EKLENDÄ° */

    /* Boyutlar */
    width: 700px !important; 
    height: 60vh !important;
    max-width: 95vw; 
    
    /* YerleÅŸim */
    display: flex;
    flex-direction: column;
    position: relative; /* Sanal katman buna gÃ¶re hizalanacak */
    overflow: hidden;   /* TaÅŸmalarÄ± gizle */

    /* RESÄ°M AYARLARI */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;

    /* DÄ±ÅŸ Ã‡erÃ§eve ve GÃ¶lge */
    border: 1px solid rgba(100, 99, 99, 0.377) !important;
    box-shadow: 0 10px 40px rgba(250, 246, 246, 0.3) !important;
}

/* ============================================================
   2. SANAL CAM KATMANI (BEYAZ RENK + BLUR)
   ============================================================ */
#synastryModal .synastry-modal-box::before, 
#celestialEventsModal .synastry-modal-box::before, 
#selectionModal .modal-box::before, 
#returnModal .synastry-modal-box::before,      /* <-- VirgÃ¼l var */
#progressionModal .synastry-modal-box::before { /* <-- YENÄ° EKLENDÄ° */
    
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0; 
    
    /* Rengi ayarladÄ±k (Koyu tonlu cam) */
    background-color: rgba(5, 0, 0, 0.233) !important; 
    
    /* BLUR (BulanÄ±klÄ±k) */
    backdrop-filter: blur(1px) !important;        
    -webkit-backdrop-filter: blur(1px) !important; 
    
    z-index: 0; 
    pointer-events: none; 
}

/* ============================================================
   Ã–NEMLÄ°: Ä°Ã‡ERÄ°KLERÄ° CAMIN ÃœSTÃœNE Ã‡IKAR
   ============================================================ */
#synastryModal .synastry-modal-box > *, 
#celestialEventsModal .synastry-modal-box > *, 
#selectionModal .modal-box > *,
#returnModal .synastry-modal-box > *,      /* <-- VirgÃ¼l var */
#progressionModal .synastry-modal-box > * { /* <-- YENÄ° EKLENDÄ° */
    position: relative !important;
    z-index: 1 !important; 
}

    /* =========================================
       6. ORTA ALAN (Harita ve Rapor)
       ========================================= */
    .chart-scroll-container {
        /* GeniÅŸliÄŸi daraltÄ±yoruz ki Scroll Ã§ubuÄŸu iÃ§eriÄŸin hemen yanÄ±nda Ã§Ä±ksÄ±n */
        width: 800px; 
        max-width: 98%; /* Mobilde taÅŸmasÄ±n */
        height: 100%; 
    
        /* ðŸ”¥ KRÄ°TÄ°K AYARLAR BURADA */
        overflow-y: auto;       /* Scroll bu kutuda olsun */
        overflow-x: hidden;     /* Yan scroll'u engelle */
        display: flex;
        flex-direction: column; /* âœ… YAN YANA DEÄžÄ°L, ALT ALTA DÄ°Z */
        align-items: center;    /* Ä°Ã§erikleri ortala */
    
        /* ScrollbarÄ±n iÃ§erikle yapÄ±ÅŸÄ±k durmasÄ± iÃ§in padding */
        padding-right: 5px;
        /* EKLEMEN GEREKEN KODLAR: */
        justify-content: flex-start !important; /* Ä°Ã§eriÄŸi en baÅŸtan baÅŸlat */
        margin-top: 0 !important;
    }

    /* 3. HARÄ°TA SARMALAYICI (Ä°Ã§erideki yapÄ±) */
    .chart-inner-wrapper {
        width: 100%; /* Ãœstteki 650px'i doldur */
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0; /* BÃ¼zÃ¼ÅŸmeyi engelle */
    }

    /* DÃœZELTÄ°LMÄ°Åž HARÄ°TA KUTUSU (Tek ve SaÄŸlam) */
    .chart-wheel-placeholder { 
        width: 100%; 
        height: 610px;      
        min-height: 610px;  
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0);
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 0px;
        backdrop-filter: blur(10px);            
        position: relative;
        outline: none !important;
    }

    #astroChart { 
        width: 580px !important; 
        height: 580px !important; 
        display: block;
    }

    #hesaplama_raporu {
        width: 100% !important; 
        display: block;
        margin-top: 20px;       
        margin-bottom: 50px;    
        background: transparent; 
    }

    /* =========================================
       7. BÄ°LGÄ° KUTUCUKLARI (Overlay)
       ========================================= */
    .chart-info-overlay {
        position: absolute !important; 
        top: 10px !important;
        left: 10px !important;
        z-index: 20;
        height: auto !important;      
        width: auto !important;        
        max-width: 250px !important;   
        white-space: normal !important; 
        word-wrap: break-word !important; 
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border: none !important;
        display: flex !important;
        flex-direction: column !important; 
        gap: 4px !important; 
        align-items: flex-start !important;
        padding: none !important;
    }

    .chart-info-name-row {
        font-size: 13px !important;
        font-weight: 800 !important;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        font-style: normal !important;
    }

    .chart-type-label {
        font-size: 10px !important;
        font-weight: 700 !important;
        color: rgb(196, 92, 7) !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
        font-style: normal !important;
    }

    .chart-info-row {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        font-size: 11px !important;
        color: #ffffff !important;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        line-height: 1.5 !important;
        white-space: normal !important; 
        word-break: keep-all !important;
        font-style: normal !important;
        margin-bottom: 4px !important; 
    }

    .chart-info-row i {
        flex-shrink: 0 !important; 
        width: 14px !important;
        color: rgb(196, 92, 7) !important;
        text-align: center;
    }

    .chart-action-container {
        position: absolute !important;
        top: 15px !important;
        right: 15px !important; 
        z-index: 25; 
    }

    .glass-change-btn {
        background: #0d8abb !important;
        border: 1px solid #0d8abb !important;
        color: #ffffff;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        font-weight: 900;
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
    }

    /* =========================================
   8. SAÄž PANEL (Formlar)
   ========================================= */
.right-sidebar-wrapper.collapsed .sidebar-form-card {
    width: 0px !important;       
    padding: 0px !important;    
    border: none !important;    
    opacity: 0;                  
    overflow: hidden;            
    margin: 0 !important;
}

.sidebar-form-card { 
    width: 235px; 
    height: 100%; 
    background: rgba(148, 181, 194, 0.281);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(85, 120, 138, 0.2);
    border-radius: 0px !important; 
    padding: 10px; 
    overflow-y: auto; 
    overflow-x: hidden; 
    white-space: normal; 
    transition: all 0.3s ease; 
    color: #ffffff;
    box-shadow: 2px 2px 32px rgba(255, 255, 255, 0.63);
    /* HATA DÃœZELTÄ°LDÄ°: VirgÃ¼l kaldÄ±rÄ±ldÄ±, noktalÄ± virgÃ¼l eklendi */
    text-shadow: 0 0 1px rgba(0, 0, 0, 0.74);
}

#right-panel-toggle { 
    width: 20px; 
    height: 50px; 
    background: rgba(0, 0, 0, 0); 
    backdrop-filter: blur(13px);
    color: rgb(0, 0, 0); 
    border: 1px solid rgba(255, 255, 255, 0.733);
    border-right: none; 
    border-radius: 4px 0 0 4px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    margin-top: 40vh; 
    z-index: 100; 
    transition: all 0.2s ease;
}

.sidebar-form-card input, 
.sidebar-form-card select {
    background: rgba(255, 255, 255, 0.295) !important;
    color: rgb(24, 24, 24) !important;                    
    border: 1px solid rgba(48, 48, 48, 0.2) !important; 
    padding: 8px !important;
    margin-bottom: 0px !important;
    width: 100% !important;
    border-radius: 0px !important;
}

.sidebar-form-card label {
    color: rgb(24, 24, 24) !important;   
    font-weight: bold;
    font-size: 11px;
}

/* --- HARÄ°TA KARTLARI LÄ°STESÄ° --- */

/* Liste Konteyneri */
.synastry-list {
    list-style: none; 
    padding: 0; 
    margin: 0;
    border: none; /* Ã‡erÃ§eveyi kaldÄ±rdÄ±m, kartlar konuÅŸsun */
    background: transparent !important;
    display: flex;
    flex-direction: column;
    gap: 10px; /* Kartlar arasÄ± genel boÅŸluk */
}

/* KARTIN KENDÄ°SÄ° (Alt alta dizilim iÃ§in Flex Column) */
.chart-list-item { 
    display: flex !important;           
    flex-direction: column !important;  /* Ä°sim, Tarih, Tip alt alta */
    justify-content: center;
    align-items: flex-start;            /* Sola yasla */
    gap: 4px;                           /* SatÄ±rlar arasÄ± ince boÅŸluk */
    
    padding: 6px 10px;                 /* Ä°Ã§erisi ferah olsun */
    margin-bottom: 5px !important;                   /* Gap kullandÄ±ÄŸÄ±mÄ±z iÃ§in margin'e gerek yok */
    
    background: rgba(207, 225, 233, 0.24) !important;
    border: 1px solid rgba(255, 255, 255, 0.548) !important;
    border-radius: 0px;
    backdrop-filter: blur(10px);  
    text-decoration: none; 
    transition: all 0.3s ease; 
    cursor: pointer;
    
    /* KartÄ±n YÃ¼ksekliÄŸi Ä°Ã§eriÄŸe GÃ¶re Uzayabilsin */
    height: auto !important;
    min-height: 70px; 
}

/* HOVER */
.chart-list-item:hover { 
    background: rgba(15, 45, 56, 0.4) !important; /* Biraz daha koyulaÅŸtÄ±rdÄ±m */
    border: 1px solid rgba(3, 23, 31, 0.4) !important; /* Biraz daha koyulaÅŸtÄ±rdÄ±m *
    transform: translateY(-2px); /* Hafif yukarÄ± kalkma efekti */
    box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
} 

/* SEÃ‡Ä°LÄ° (SELECTED) */
.chart-list-item.selected { 
    background: rgba(15, 45, 56, 0.6) !important; /* SeÃ§ilince iyice belirgin olsun */
    border: 1px solid rgba(3, 23, 31, 0.4) !important;
    border-left: 5px solid rgba(3, 23, 31, 0.4) !important;
    padding-left: 10px; /* Ã‡izgi gelince yazÄ± kaymasÄ±n */
}

/* --- Ä°Ã‡ METÄ°NLER --- */

/* 1. Ä°SÄ°M */
.chart-list-name { 
    font-size: 13px;
    color: #1a2e35 !important; /* Koyu renk (okunabilirlik iÃ§in) */
    font-weight: 550; 
    display: block; 
    width: 100%;
    line-height: 1.5 !important; /* SatÄ±r yÃ¼ksekliÄŸini artÄ±rarak metni ferahlatÄ±r */
}

/* Hover ve SeÃ§ilide Ä°sim Rengi */
.chart-list-item:hover .chart-list-name,
.chart-list-item.selected .chart-list-name {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* 2. TARÄ°H */
.chart-list-date {
    font-size: 11px;
    font-weight: 500;
    color: #192a33 !important; 
    display: flex;
    align-items: center;
    width: 100%;
    margin-top: 2px;
    line-height: 1.5 !important; /* SatÄ±r yÃ¼ksekliÄŸini artÄ±rarak metni ferahlatÄ±r */
}

/* Hover ve SeÃ§ilide Tarih Rengi */
.chart-list-item:hover .chart-list-date,
.chart-list-item.selected .chart-list-date {
    color: #e0e0e0 !important;
}

/* 3. TÄ°P (Alt satÄ±r) */
.chart-list-type {
    display: block;
    font-size: 10px;
    color: #546e7a !important; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
    margin-top: 4px;
    border-top: 1px solid rgba(0,0,0,0.1); /* Tip ile tarih arasÄ±na ince Ã§izgi */
    width: 100%;
    padding-top: 3px;
    line-height: 1.5 !important; /* SatÄ±r yÃ¼ksekliÄŸini artÄ±rarak metni ferahlatÄ±r */
}

/* Hover ve SeÃ§ilide Tip Rengi */
.chart-list-item:hover .chart-list-type,
.chart-list-item.selected .chart-list-type {
    color: #bbbbbb !important;
    border-top: 1px solid #bbbbbb !important;
}

.tab-button {
    flex: 1;
    text-align: center;
    padding: 8px 5px;      /* Kutuyu daralttÄ±k */
    text-decoration: none;
    font-size: 12px !important; /* Ä°stediÄŸin 13px boyutu */
    font-weight: bold;
    color: rgba(255, 255, 255, 0.863); /* Pasifken hafif sÃ¶nÃ¼k */
    transition: all 0.3s ease;
    border-radius: 0px !important;
}

.tab-button:hover {
    /* Arka planÄ± tamamen temizledik */
    background: transparent !important; 
    
    /* YazÄ± rengini parlamayÄ± taÅŸÄ±yabilmesi iÃ§in saf beyaza Ã§ekiyoruz */
    color: rgba(1, 13, 17, 0.863); /* Pasifken hafif sÃ¶nÃ¼k */
    
    /* Senin ana rengine uyumlu (soÄŸuk beyaz ve petrol Ä±ÅŸÄ±ltÄ±lÄ±) yanma efekti */
    text-shadow: 0 0 1px rgb(11, 77, 88),       /* Keskin harf hattÄ± */
                 0 0 7px rgb(179, 206, 211),     /* Orta parlama */
                 4 4 20px rgba(1, 13, 17, 0.863); /* Pasifken hafif sÃ¶nÃ¼k */        /* Ana petrol renginin derin gÃ¶lgesi */
                 0 0 30px rgba(134, 239, 255, 0.4);    /* DÄ±ÅŸa vuran Ã§ok hafif turkuaz/petrol Ä±ÅŸÄ±ÄŸÄ± */
                 
    transition: all 0.2s ease-in-out;
    cursor: pointer;
    font-weight: 700; /* Parlama anÄ±nda harfler daha dolgun dursun */
}

/* AKTÄ°F (SEÃ‡Ä°LÄ°) SEKME */
.tab-button.active {
    color: rgba(1, 13, 17, 0.863); /* Pasifken hafif sÃ¶nÃ¼k */
    border-bottom: 2px solid rgba(1, 13, 17, 0.863); /* Pasifken hafif sÃ¶nÃ¼k */
}

    /* Profil Form ElemanlarÄ± */
    .profile-form-group {
        margin-bottom: 15px !important; 
    }
    .profile-form-group label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 4px;
        text-transform: uppercase;
        opacity: 0.9;
        text-shadow: 1px 1px 1px rgb(184, 184, 184);
    }
    .profile-form-group input {
        width: 100%;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.425) !important; /* Okunabilirlik iÃ§in biraz kararttÄ±m */
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 5px 5px 20px rgba(0,0,0,0.5);
        border-radius: 0px;
        font-size: 12px;
        color: rgb(255, 255, 255);
        outline: none;
    }
    .profile-form-group input:focus {
        border-color: #ffffff;
    }
    .profile-image-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ffffff;
        margin: 10px auto;
        display: block;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    .support-link-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: rgba(26, 26, 26, 0.90) !important;
        border-radius: 0px; 
        margin-bottom: 10px;
        border: 1px solid rgba(26, 26, 26, 0.90) !important; 
        color: #ffffff;
        transition: all 0.3s;
    }
    .support-link-item:hover {
        background: rgba(26, 26, 26, 0.90) !important;
        border-color: rgba(26, 26, 26, 0.90) !important;
        color: #ffffff;
        transform: translateX(5px);
    }

    /* =========================================
       9. SVG VE HARÄ°TA Ã‡Ä°ZGÄ°LERÄ°
       ========================================= */
    .cusp-degree, .planet-degree { 
        font-size: 15px; 
        font-weight: 500; 
        fill: #292929 !important; 
        font-family: Helvetica, Arial, sans-serif; 
    } 
    .cusp-minute, .planet-minute { 
        font-size: 13px; 
        font-weight: 400; 
        fill: #707174 !important; 
        font-family: Helvetica, Arial, sans-serif; 
    }

    .house-cusp {
        stroke: #292929 !important; 
        stroke-width: 1px !important;
        opacity: 0.8;
    }

    .asc-line, .ic-line, .dsc-line, .mc-line {
        stroke: #292929 !important; 
        stroke-width: 2.2px !important; 
        opacity: 1 !important;
    }

    .house-cusp-stepped {
        stroke: #64748b !important;
        stroke-width: 1px !important;
        stroke-dasharray: 2,2; 
    }

    .chart-line, 
    svg circle.chart-line {
        stroke: #334155 !important;    
        stroke-width: 1.5px !important; 
        stroke-dasharray: none !important; 
        opacity: 1 !important;
        fill: none !important;
    }
    
    .house-label { font-size: 10px; fill: #292929 !important; font-weight: bold; } 
    .planet-retrograde { font-size: 12px; fill: #dc2626; font-weight: bold; } 

    .intercepted-sign-glyph {
        font-size: 22px !important;
        fill: rgb(196, 92, 7) !important; 
        font-family: "Arial", sans-serif;
        font-weight: bold;
        text-anchor: middle;
        dominant-baseline: middle;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
    }
    .intercepted-sign-glyph.highlight {
        fill: rgb(196, 92, 7) !important; 
    }
    
/* =========================================
   SAÄž TIK VE CONTEXT MENU TASARIMI
========================================= */

/* MenÃ¼lerin Ortak SÄ±nÄ±fÄ± */
.transit-context-menu {
    display: none;
    position: fixed !important; 
    background: rgba(26, 26, 26, 0.95) !important;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    z-index: 999999 !important; 
    padding: 5px 0;
    min-width: 180px;
    pointer-events: all;
}

/* MenÃ¼ Ä°Ã§eriÄŸi */
.transit-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    color: #ffffff !important;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
}

.transit-menu-item:last-child {
    border-bottom: none;
}

.transit-menu-item:hover {
    background: rgba(196, 92, 7, 0.8) !important;
    color: #ffffff !important;
    padding-left: 20px;
}

.transit-menu-item i {
    width: 18px;
    text-align: center;
    font-size: 14px;
}

/* Harita AlanÄ±nÄ± Sabitleyen ve GÃ¶rÃ¼nÃ¼r KÄ±lan Ek */
.chart-wheel-placeholder {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important; /* Fixed olmamalÄ± */
}

#astroChart {
    display: block !important;
    visibility: visible !important;
}

    /* =========================================
       10. EKSTRALAR VE MODALLAR (En Alt)
       ========================================= */
    
    /* Dikey Buton Åžeridi (Sol) */
    .vertical-action-strip {
        width: 35px; 
        background: rgba(0, 0, 0, 0) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-right: 1px solid rgba(255, 255, 255, 0.15);
        margin-left: -5px; 
        margin-right: 8px; 
        display: flex !important;
        flex-direction: column !important; 
        align-items: center !important;
        justify-content: flex-start !important;
        padding-top: 20px;
        gap: 15px;
        height: 100%;
        flex-shrink: 0;
    }

    .v-strip-btn {
        width: 28px;
        height: 28px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        transition: all 0.3s;
    }
    .v-strip-btn:hover { color: #ffffff; transform: scale(1.1); }

    /* Modallar */
    .modal-overlay {
        display: none; 
        position: fixed; 
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4); 
        z-index: 20000; 
        align-items: center; 
        justify-content: center; 
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .modal-box {
        background: rgba(26, 26, 26, 0.90) !important;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        width: 90%;
        max-width: 600px; 
        max-height: 85vh; 
        border-radius: 0px; 
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
        padding: 25px;
        position: relative;
        overflow-y: auto; 
        display: flex;
        flex-direction: column;
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-box h4 {
        margin-top: 0; margin-bottom: 15px;
        font-size: 16px; color: #ffffff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
        text-transform: uppercase;
        font-weight: 800;
        letter-spacing: 1px;
    }

    .modal-close {
        position: absolute !important;
        top: 15px !important;
        right: 15px !important;
        background: none !important;
        border: none !important;
        color: #ffffff !important;
        font-size: 24px !important;
        cursor: pointer !important;
        opacity: 0.7;
        transition: all 0.3s;
        line-height: 1;
        z-index: 999;
    }
    .modal-close:hover {
        opacity: 1;
        color: #ef4444 !important; 
        transform: rotate(90deg);
    }

    .chart-select-item {
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.05);
        color: #ffffff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chart-select-item:hover {
        background: rgba(255, 255, 255, 0.2); 
        padding-left: 20px; 
    }

    .close-modal-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: rgba(239, 68, 68, 0.8); 
        backdrop-filter: blur(4px);
        color: white;
        border: none;
        border-radius: 0px; 
        cursor: pointer;
        font-weight: bold;
        align-self: flex-end;
        transition: all 0.2s;
    }
    .close-modal-btn:hover { background: #ef4444; transform: scale(1.05); }

    .back-btn { color: #ffffff; opacity: 0.8; font-size: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }
    .back-btn:hover { opacity: 1; text-decoration: underline; }

    /* Primary Buton */
    .btn-primary {
        background: rgb(196, 92, 7) !important;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 0px;
        font-weight: bold;
        cursor: pointer;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .btn-primary:hover {
        background: rgb(59, 139, 6) !important;
        box-shadow: 0 6px 20px rgba(21, 121, 1, 0.3);
        transform: translateY(-1px);
    }
    .btn-primary:active {
        transform: translateY(0px);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 13px; }
    ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    ::-webkit-scrollbar-thumb { 
        background: rgba(255, 253, 253, 0.87); 
        border-radius: 0px; 
        border: 2px solid rgb(255, 255, 255); 
        background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.63); }

    /* Tooltip */
    .custom-tooltip {
        display: none;
        position: fixed;
        background: rgba(15, 23, 42, 0.75) !important; 
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: #000000;
        padding: 4px 8px;
        border-radius: 0px;
        font-size: 10px;
        font-weight: 500;
        pointer-events: none;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .tooltip-title {
        display: block;
        font-weight: bold;
        font-size: 10px;
        margin-bottom: 2px;
        color: #fbbf24; 
    }
    .tooltip-detail {
        display: block;
        font-size: 10px;
        color: rgba(19, 19, 19, 0.9);
    }
    
    /* --- SOL MENÃœ POP-UP TASARIMI --- */

/* 1. DÄ±ÅŸ TaÅŸÄ±yÄ±cÄ± (GÃ¶rÃ¼nmez Katman) */
#sidebarLocationModal {
    z-index: 999999 !important;
    background: transparent !important;
    backdrop-filter: none !important;
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
}

/* 2. Kutu TasarÄ±mÄ± (170px Sabit) */
#sidebarLocationModal .modal-box {
    position: absolute !important;
    width: 170px !important;       /* SABÄ°T 170PX */
    background: rgba(0, 0, 0, 0.822) !important; /* Okunabilirlik iÃ§in biraz kararttÄ±m */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 5px 5px 20px rgba(0,0,0,0.5);
    margin: 0 !important;
    border-radius: 0px;            /* Keskin kÃ¶ÅŸe */
    padding: 10px !important;      /* Ä°Ã§erik kenarlara yapÄ±ÅŸmasÄ±n */
    box-sizing: border-box !important; /* Padding geniÅŸliÄŸe dahil olsun */
}

/* Kapatma Butonu (SaÄŸ Ã¼st kÃ¶ÅŸe) */
#sidebarLocationModal .modal-close {
    top: 2px !important;
    right: 5px !important;
    font-size: 16px !important;
    color: #ccc !important;
}

/* BaÅŸlÄ±k */
#sidebarLocationModal h4 {
    font-size: 13px !important;
    margin: 0 0 8px 0 !important; /* Sadece alta boÅŸluk */
    letter-spacing: 0.5px;
    white-space: nowrap;          /* BaÅŸlÄ±k alt satÄ±ra kaymasÄ±n */
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 15px;
    padding-bottom: 3px;          /* Kapatma butonuyla Ã§akÄ±ÅŸmasÄ±n */
}

/* Arama AlanÄ± KapsayÄ±cÄ±sÄ± (Yan Yana Dizme) */
#sidebarLocationModal .modal-box > div {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 3px !important;          /* Input ve buton arasÄ± 3px */
    width: 100% !important;
}

/* Åžehir AdÄ± Input (Otomatik Kalan Yeri Kaplar) */
#sidebar_city_input {
    flex: 1 !important;           /* Kalan tÃ¼m boÅŸluÄŸu doldurur */
    min-width: 0 !important;      /* Dar alanda sÄ±kÄ±ÅŸabilmesini saÄŸlar */
    font-size: 11px !important;
    padding: 0 5px !important;
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    height: 24px !important;      /* YÃ¼kseklik */
    outline: none !important;
    border-radius: 0 !important;
}

/* BUL Butonu (Sabit GeniÅŸlik) */
#sidebarLocationModal .btn-primary {
    width: 35px !important;       /* Sabit 35px */
    flex-shrink: 0 !important;    /* Asla daralmasÄ±n */
    font-size: 10px !important;
    height: 24px !important;      /* Input ile aynÄ± boy */
    padding: 0 !important;        /* Ä°Ã§ boÅŸluk sÄ±fÄ±r */
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ff9f43 !important; /* Turuncu */
    border: none !important;
    cursor: pointer;
}

#sidebarLocationModal .btn-primary:hover {
    background: #ffb167 !important; /* Biraz daha aÃ§Ä±k turuncu */
    box-shadow: 0 0 10px rgba(255, 159, 67, 0.6); /* Turuncu parlama */
    transform: scale(1.02); /* Ã‡ok hafif bÃ¼yÃ¼me */
    transition: all 0.2s ease;
}

/* SonuÃ§ Listesi */
#sidebarResultList {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 5px !important;   /* Input ile arasÄ± */
}

/* Liste ElemanlarÄ± */
#sidebarResultList li {
    padding: 6px 4px !important;
    font-size: 11px !important;
    line-height: 1.2;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #ddd;
    word-wrap: break-word;        /* Uzun ÅŸehir isimleri alt satÄ±ra geÃ§sin */
}

#sidebarResultList li:hover {
    background: rgba(255, 159, 67, 0.2);
    color: #fff;
}

</style>
</head>
<body>
    <header class="main-header">
        <div class="logo-container">
    <a href="{{ url_for('home') }}" class="logo-link">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" 
             alt="AstroFire" 
             class="logo-svg-main" 
             onerror="this.style.display='none'">
    </a>
</div>
        
        <nav class="main-nav">
            <a href="{{ url_for('page_data') }}" class="nav-link {% if active_page == 'data' %}active{% endif %}">DATA</a>
            <a href="{{ url_for('home') }}" class="nav-link {% if not active_page %}active{% endif %}">Harita AÃ§</a>
            <a href="{{ url_for('kayitli_haritalar') }}" class="nav-link {% if request.endpoint == 'kayitli_haritalar' %}active{% endif %}">KayÄ±tlÄ± Haritalar</a>
            <a href="{{ url_for('page_education') }}" class="nav-link {% if active_page == 'egitimler' %}active{% endif %}">EÄŸitimler</a>
            <a href="{{ url_for('page_consultations') }}" class="nav-link {% if active_page == 'danismanliklar' %}active{% endif %}">DanÄ±ÅŸmanlÄ±klar</a>
            <a href="{{ url_for('page_contact') }}" class="nav-link {% if active_page == 'iletisim' %}active{% endif %}">Ä°letiÅŸim</a>
        </nav>
        
        <div class="user-area" style="position:relative;">
            {% if is_logged_in %} 
                <div class="user-dropdown-trigger" onclick="toggleUserMenu(event)" style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:5px 10px; border-radius:4px; transition:background 0.2s;">
                    {% if user_profile_image %}
                        <img src="{{ url_for('static', filename='uploads/profiles/' ~ user_profile_image) }}" alt="Profil" style="width:30px; height:30px; border-radius:50%; object-fit:cover; border:2px solid rgb(255, 255, 255)0.00011)0.00011);">
                    {% else %}
                        <div style="width:30px; height:30px; border-radius:50%; background:rgba(212, 208, 208, 0.87); display:flex; align-items:center; justify-content:center; border:2px solid rgb(255, 255, 255);">
                            <i class="fas fa-user" style="color:#666; font-size:14px;"></i>
                        </div>
                    {% endif %}
                    <span style="font-size:13px; font-weight:bold; color:#e7e7e7;">{{ display_name }}</span>
                    <i class="fas fa-chevron-down" style="font-size:10px; color:#666;"></i>
                </div>
                
                <div id="userDropdownMenu" class="user-dropdown-menu" style="display:none;">
                    <a href="javascript:void(0)" onclick="openPremiumModal()" class="premium-menu-item">
                        <i class="fas fa-crown"></i> Premium Ol
                    </a>
                    <a href="javascript:void(0)" onclick="openProfileModal()">
                        <i class="fas fa-user-circle"></i> HesabÄ±m
                    </a>
                    <a href="javascript:void(0)" onclick="openSupportModal()">
                        <i class="fas fa-headset"></i> Destek
                    </a>
                    {% if is_admin and is_admin() %}
                        <a href="{{ url_for('admin_dashboard') }}" style="color:#e67e22;">
                            <i class="fas fa-cog"></i> YÃ¶netim Paneli
                        </a>
                    {% endif %}
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" style="color:#dc2626;">
                        <i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ Yap
                    </a>
                </div>
            {% else %} 
                <a href="{{ url_for('login') }}" class="btn-login" style="font-size:12px; font-weight:bold; color:#1565c0; text-decoration:none;">GÄ°RÄ°Åž YAP</a> 
            {% endif %}
        </div>
    </header>

    {% block content %}
<div class="main-container">

    <aside class="sidebar-left">
    
    {% if current_chart_data and (current_chart_data.type in ['natal', 'transit', 'progression', 'synastry', 'composite'] or 'progression' in current_chart_data.type or 'solar_arc' in current_chart_data.type or 'secondary' in current_chart_data.type) %}
    <div class="time-capsule-container">
        <div class="time-control-row">
            <button class="time-btn" onclick="adjustTime(-1)"><i class="fas fa-chevron-left"></i></button>
            <select id="timeStepSelect" class="time-select" onchange="saveTimeStep()">
                <option value="minute">Dakika</option>
                <option value="hour">Saat</option>
                <option value="day" selected>GÃ¼n</option>
                <option value="week">Hafta</option>
                <option value="month">Ay</option>
                <option value="year">YÄ±l</option>
            </select>
            <button class="time-btn" onclick="adjustTime(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        <form action="/set_active_time" method="POST" class="time-form-group">
            <input type="datetime-local" name="target_date" class="date-jump-input" required 
                   value="{{ current_chart_data.year }}-{{ '%02d'|format(current_chart_data.month) }}-{{ '%02d'|format(current_chart_data.day) }}T{{ '%02d'|format(current_chart_data.hour) }}:{{ '%02d'|format(current_chart_data.minute) }}">
            <button type="submit" class="btn-jump">GÄ°T</button>
        </form>
    </div>
    {% endif %}

    <div class="transit-info-card-box">
        <div class="info-group-wrapper">
            <div class="info-row" title="AnlÄ±k Zaman">
                <i class="far fa-clock"></i>
                <span id="bar_datetime">...</span>
            </div>

            <div class="info-row" title="Konum">
                <i class="fas fa-map-marker-alt"></i>
                <span id="bar_location_display" class="info-clickable" onclick="openSidebarLocationSearch()">Ä°stanbul</span>
            </div>

            <div class="info-row" title="ASC">
                <i class="fas fa-arrow-up"></i>
                <span>ASC: <b id="bar_asc_degree">--</b></span>
            </div>
        </div>
        
        <div class="info-card-menu-area">
            <a href="javascript:void(0)" onclick="openTransitMenu(event)" class="sidebar-link transit-link">
                <i class="fas fa-satellite"></i> Transit MenÃ¼sÃ¼
            </a>
        </div>
    </div>

    <div class="bottom-menu-container">
        <a href="javascript:void(0)" onclick="openProgressionModal()" class="sidebar-link"><i class="fas fa-history"></i> Ä°lerletilmiÅŸ Haritalar</a>
        <a href="javascript:void(0)" onclick="openReturnModal()" class="sidebar-link"><i class="fas fa-redo"></i> DÃ¶nÃ¼ÅŸ HaritalarÄ±</a>
        <a href="javascript:void(0)" onclick="openCelestialModal()" class="sidebar-link"><i class="fas fa-moon"></i> Tutulmalar & Ay Evreleri</a>
        <a href="javascript:void(0)" onclick="openSynastryModal()" class="sidebar-link {% if active_tab == 'sinastri' %}active{% endif %}"><i class="fas fa-user-friends"></i> Sinastri</a>
    </div>

</aside>

    <main class="chart-content">
        {% if not is_logged_in %}
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; width:100%; min-height: 500px;">
                <div style="background:rgba(255,255,255,0.95); padding:40px; border:1px solid #e2e8f0; box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center; max-width:500px;">
                    <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="AstroFire" style="width:80px; margin-bottom:20px;">
                    <h2 style="color:#1565c0; margin-bottom:10px;">AstroFire'a HoÅŸ Geldiniz</h2>
                    <p style="color:#556677; margin-bottom:25px; line-height:1.6;">LÃ¼tfen giriÅŸ yapÄ±n.</p>
                    <a href="{{ url_for('login') }}" class="btn-primary" style="text-decoration:none; padding:12px 25px;">GiriÅŸ Yap</a>
                </div>
            </div>
        {% else %}
            <div class="chart-scroll-container">
                <div id="customTooltip" class="custom-tooltip"></div>
                
                <div class="chart-inner-wrapper"> 
                    
                    <div class="chart-wheel-placeholder">
                        {% if last_chart %}
                            {% if current_chart_data %}
                                <div class="chart-info-overlay">
                                    {% if current_chart_data.type in ['synastry', 'synastri', 'composite', 'progression', 'progressed', 'synastry_transit'] and current_chart_data.natal_meta_1 and current_chart_data.natal_meta_2 %}
                                        <div class="chart-info-name-row">
                                            <span>{{ current_chart_data.natal_meta_1.name }}</span>
                                            <span style="color: #fbbf24; font-weight:300; margin: 0 4px;">&</span>
                                            <span>{{ current_chart_data.natal_meta_2.name }}</span>
                                        </div>
                                        <div class="chart-type-label">
                                            {% if current_chart_data.type == 'composite' %}KOMPOZÄ°T
                                            {% elif 'synastr' in current_chart_data.type %}SÄ°NASTRÄ°
                                            {% elif 'progress' in current_chart_data.type %}PROGRESS
                                            {% else %}{{ current_chart_data.type|upper }}{% endif %}
                                        </div>
                                        <div class="chart-info-row">
                                            <i class="fas fa-user person-icon"></i>
                                            <span>1: {{ current_chart_data.natal_meta_1.day }}.{{ current_chart_data.natal_meta_1.month }}.{{ current_chart_data.natal_meta_1.year }}</span>
                                        </div>
                                        <div class="chart-info-row">
                                            <i class="fas fa-user-friends person-icon"></i>
                                            <span>2: {{ current_chart_data.natal_meta_2.day }}.{{ current_chart_data.natal_meta_2.month }}.{{ current_chart_data.natal_meta_2.year }}</span>
                                        </div>
                                    {% else %}
                                        <div class="chart-info-name-row">{{ current_chart_data.name }}</div>
                                        <div class="chart-type-label">{{ current_chart_data.type|upper }}</div>
                                        <div class="chart-info-row">
                                            <i class="far fa-calendar-alt"></i>
                                            <span>{{ current_chart_data.day }}.{{ current_chart_data.month }}.{{ current_chart_data.year }} {{ "%02d"|format(current_chart_data.hour) }}:{{ "%02d"|format(current_chart_data.minute) }}</span>
                                        </div>
                                        <div class="chart-info-row">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>
                                                {% if current_chart_data.location_name %}
                                                    {{ current_chart_data.location_name.split(',')[:2] | join(',') }}
                                                {% else %}Konum Belirsiz{% endif %}
                                            </span>
                                        </div>
                                        <div class="chart-info-row">
                                            <i class="fas fa-globe"></i>
                                            <span>{{ current_chart_data.zodiac_type or 'Tropikal' }} | UTC {{ current_chart_data.tz_offset }}</span>
                                        </div>
                                    {% endif %}
                                </div> 

                                {% if current_chart_data.type in ['synastri', 'synastry', 'synastry_transit'] %}
                                    <div class="chart-action-container">
                                        <button type="button" onclick="swapSynastryCharts(this, '{{ current_chart_data.natal_meta_1.id }}', '{{ current_chart_data.natal_meta_2.id }}')" class="glass-change-btn" title="Ä°Ã§ ve DÄ±ÅŸ HaritanÄ±n Yerini DeÄŸiÅŸtir">
                                            <i class="fas fa-exchange-alt" style="color:#ffffff;"></i> <span>DEÄžÄ°ÅžTÄ°R</span>
                                        </button>
                                    </div>
                                {% endif %}
                            {% endif %}

                            <svg id="astroChart" viewBox="0 0 700 700"></svg>
                        
                        {% else %}
                            <p style="padding: 20px; text-align: center; color: #777; margin-top: 50px;">Harita bekleniyor...</p>
                        {% endif %} 
                    </div> 

                    <div id="hesaplama_raporu" class="tab-content active" style="width: 100%;">
                        {% if report_success %}
                            {% include 'report_output.html' ignore missing %}
                        {% elif report_success == False %}
                            <div class="alert error">âŒ {{ report_error }}</div>
                        {% endif %}
                    </div>

                </div> </div> {% endif %}
    </main>

    <div class="right-sidebar-wrapper" id="rightSidebarWrapper">
        <div id="right-panel-toggle" onclick="toggleRightPanel()"><i class="fas fa-chevron-right"></i></div>
        <aside class="sidebar-form-card" id="rightSidebar">
            <div class="tab-navigation">
                <a href="{{ url_for('home', tab='natal') }}" class="tab-button {% if active_tab == 'natal' %}active{% endif %}">Harita AÃ§</a>
                <a href="{{ url_for('home', tab='aktif') }}" class="tab-button {% if active_tab == 'aktif' %}active{% endif %}">Aktif ({{ active_charts|length }})</a>
            </div>
            
            <div id="natal" class="tab-content {% if active_tab == 'natal' %}active{% endif %}">
                <form id="natalForm" method="POST" action="{{ url_for('home', tab='natal') }}">
                    {% include 'natal_form_fields.html' ignore missing %}
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">HESAPLA</button>
                </form>
            </div>
            
            <div id="aktif" class="tab-content {% if active_tab == 'aktif' %}active{% endif %}">
                {% include 'active_charts_list.html' ignore missing %}
            </div>
        </aside>
    </div>

</div>

<input type="hidden" id="bar_lat" value="41.0082"><input type="hidden" id="bar_lon" value="28.9784"><input type="hidden" id="bar_tz" value="3.0"><input type="hidden" id="bar_loc_name" value="Ä°stanbul, TÃ¼rkiye">
<form id="instantTransitForm" method="POST" action="{{ url_for('home', tab='instant_transit') }}" style="display:none;"><input type="hidden" name="bar_year" id="form_bar_year"><input type="hidden" name="bar_month" id="form_bar_month"><input type="hidden" name="bar_day" id="form_bar_day"><input type="hidden" name="bar_hour" id="form_bar_hour"><input type="hidden" name="bar_minute" id="form_bar_minute"><input type="hidden" name="bar_lat" id="form_bar_lat"><input type="hidden" name="bar_lon" id="form_bar_lon"><input type="hidden" name="bar_tz" id="form_bar_tz"><input type="hidden" name="bar_loc_name" id="form_bar_loc_name"><input type="hidden" name="transit_type" id="form_transit_type"></form>
<form id="timeAdjustForm" method="POST" action="/adjust_active_time" style="display:none;"><input type="hidden" name="unit" id="time_adjust_unit"><input type="hidden" name="amount" id="time_adjust_amount"></form>

<div id="locationModal" class="modal-overlay">
    <div class="modal-box"> 
        
        <h4 id="locationModalTitle">Konum SeÃ§in</h4>
        
        <div class="modal-search-row">
            <input type="text" id="modal_city_input" placeholder="Åžehir adÄ±...">
            <button class="btn-primary" onclick="searchInModal()">BUL</button>
        </div>
        
        <ul id="locationResultList" class="location-list"></ul>
    </div>
</div>

<div id="sidebarLocationModal" class="modal-overlay">
    <div class="modal-box sidebar-modal-custom">
        
        <button class="modal-close" onclick="closeSidebarLocationModal()">&times;</button>
        
        <h4 style="color: #ff9f43; border-color: rgba(255,255,255,0.1);">
            <i class="fas fa-map-marker-alt"></i> CanlÄ± Konum
        </h4>
        
        <div style="display:flex; gap:5px; margin-bottom: 10px;">
            <input type="text" id="sidebar_city_input" placeholder="Åžehir adÄ±..." 
                   style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; outline: none;">
            
            <button onclick="searchSidebarLocation()" class="btn-primary" style="padding: 0 15px; margin:0;">BUL</button>
        </div>

        <div id="sidebar-loading" style="display:none; color: #ff9f43; font-size: 11px; text-align: center; margin-bottom:5px;">AranÄ±yor...</div>

        <ul id="sidebarResultList" class="location-list" style="list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;"></ul>
    </div>
</div>
<!-- TRANSÄ°T MENÃœSÃœ -->
    <div id="transit-context-menu" class="transit-context-menu">
        <div class="transit-menu-item" onclick="submitInstantTransit('Astronomik')">Astronomik Transit</div>
        <div class="transit-menu-item" onclick="submitInstantTransit('Drakonik')">Drakonik Transit</div>
    </div>

    <!-- SÄ°DEBAR SAÄž TIK MENÃœSÃœ -->
    <div id="sidebar-context-menu" class="transit-context-menu" style="width: 150px;">
        <a id="context-save" class="transit-menu-item" href="#">
            <i class="fas fa-save" style="color:#27ae60; width:20px;"></i> ArÅŸive Kaydet
        </a>
        <a id="context-edit" class="transit-menu-item" href="#" style="display:none;">
            <i class="fas fa-edit" style="color:#f39c12; width:20px;"></i> DÃ¼zenle
        </a>
        <a id="context-delete" class="transit-menu-item" href="#" onclick="return confirm('Bu haritayÄ± silmek istediÄŸinize emin misiniz?')">
            <i class="fas fa-trash" style="color:#c0392b; width:20px;"></i> Sil
        </a>
        <div class="transit-menu-item" onclick="toggleBulkDeleteMode()" style="border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px;">
            <i class="fas fa-tasks" style="color:#9b59b6; width:20px;"></i> Toplu Sil
        </div>
    </div>

    <!-- HARÄ°TA SAÄž TIK MENÃœSÃœ -->
    <div id="canvas-context-menu" class="transit-context-menu" style="width: 200px;">
        <div class="transit-menu-item" onclick="openSelectionModal('planets', 'Gezegen SeÃ§imi')">
            <i class="fas fa-globe" style="color:#3498db; width:20px;"></i> Gezegenleri SeÃ§
        </div>
        <div class="transit-menu-item" onclick="openSelectionModal('asteroids', 'Asteroid SeÃ§imi')">
            <i class="fas fa-meteor" style="color:#9b59b6; width:20px;"></i> Asteroidleri SeÃ§
        </div>
        <div class="transit-menu-item" onclick="openSelectionModal('fixedstars', 'Sabit YÄ±ldÄ±z SeÃ§imi')">
            <i class="fas fa-star" style="color:#f1c40f; width:20px;"></i> Sabit YÄ±ldÄ±zlarÄ± SeÃ§
        </div>
        <div class="transit-menu-item" onclick="openSelectionModal('angles', 'KÃ¶ÅŸe NoktalarÄ±')">
            <i class="fas fa-compass" style="color:#e74c3c; width:20px;"></i> KÃ¶ÅŸe NoktalarÄ±
        </div>
    </div>

<div id="celestialEventsModal" class="modal-overlay">
    <div class="synastry-modal-box" style="max-width: 900px; width: 95%; max-height: 85vh; background: #fff; border-radius: 8px; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
        <div class="synastry-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 8px 8px 0 0;">
            <span style="font-weight: bold; color: #2c3e50; font-size: 16px;"><i class="fas fa-moon"></i> GÃ¶kyÃ¼zÃ¼ OlaylarÄ± ArÅŸivi</span>
            <span style="cursor:pointer; font-size:20px; color: #e74c3c;" onclick="document.getElementById('celestialEventsModal').style.display='none'">âœ•</span>
        </div>
        <div class="synastry-body" style="flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto;">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; justify-content: center;">
                <input type="number" id="ce_year" placeholder="YÄ±l" value="2025" style="width: 80px; padding:8px; border:1px solid #ddd; border-radius:4px; font-weight:bold; text-align: center;">
                <select id="ce_zodiac" style="padding:8px; border:1px solid #ddd; border-radius:4px; font-weight:bold; color:#333;"><option value="Tropikal">Tropikal</option><option value="Astronomik">Astronomik</option><option value="Drakonik">Drakonik</option></select>
                <button onclick="searchCelestialEvents()" style="background:#2c3e50; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">LÄ°STELE</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="display:flex; flex-direction:column; height: 100%;">
                    <h5 style="margin:0 0 8px 0; color:#c0392b; font-size:13px; border-bottom:2px solid #c0392b; padding-bottom:4px; text-align: center;"><i class="fas fa-eclipse"></i> TUTULMALAR</h5>
                    <div id="eclipseList" class="synastry-list" style="flex:1; height: 50vh; max-height: 400px; overflow-y: auto; background:#fff5f5; border: 1px solid #fadbd8; border-radius: 4px;"><p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">YÄ±l seÃ§ip arayÄ±n.</p></div>
                </div>
                <div style="display:flex; flex-direction:column; height: 100%;">
                    <h5 style="margin:0 0 8px 0; color:#2980b9; font-size:13px; border-bottom:2px solid #2980b9; padding-bottom:4px; text-align: center;"><i class="far fa-moon"></i> YENÄ° AY & DOLUNAY</h5>
                    <div id="phaseList" class="synastry-list" style="flex:1; height: 50vh; max-height: 400px; overflow-y: auto; background:#ebf5fb; border: 1px solid #d6eaf8; border-radius: 4px;"><p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">YÄ±l seÃ§ip arayÄ±n.</p></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="selectionModal" class="modal-overlay">
    <div class="modal-box" style="width: 450px; height: 500px; position: relative;">
        <button class="modal-close" onclick="closeSelectionModal()">&times;</button>
        <h4 id="selectionModalTitle">GÃ¶rÃ¼nÃ¼rlÃ¼k AyarlarÄ±</h4>
        <div id="backBtnContainer" style="display:none; margin-bottom:10px;"><span class="back-btn" onclick="goBackToFolders()"><i class="fas fa-chevron-left"></i> Kategorilere DÃ¶n</span></div>
        <div style="display:flex; gap:15px; flex:1; overflow:hidden;">
            <div style="flex:1; display:flex; flex-direction:column;">
                <span style="font-size:11px; font-weight:bold; color:#27ae60; margin-bottom:5px; border-bottom:1px solid #eee;">GÃ–ZÃœKENLER</span>
                <ul id="visibleList" class="synastry-list" style="flex:1;"></ul>
            </div>
            <div style="width:1px; background:#eee;"></div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <span id="hiddenTitle" style="font-size:11px; font-weight:bold; color:#c0392b; margin-bottom:5px; border-bottom:1px solid #eee;">GÄ°ZLENENLER</span>
                <ul id="hiddenList" class="synastry-list" style="flex:1;"></ul>
            </div>
        </div>
    </div>
</div>

<div id="profileModal" class="modal-overlay" style="display:none;">
    <div class="modal-box profile-modal" style="position: relative;">
        <button class="modal-close" onclick="document.getElementById('profileModal').style.display='none'">&times;</button>
        <h4><i class="fas fa-user-circle"></i> Hesap Bilgileri</h4>
        <form action="/update_profile" method="POST" enctype="multipart/form-data">
            <div class="profile-form-group"><label>Profil Resmi</label>
                {% if user_profile_image %} <img src="{{ url_for('static', filename='uploads/profiles/' ~ user_profile_image) }}" class="profile-image-preview" alt="Profil">
                {% else %} <img src="{{ url_for('static', filename='images/default-avatar.png') }}" class="profile-image-preview" alt="Profil" onerror="this.src='https://via.placeholder.com/100'"> {% endif %}
                <input type="file" name="profile_image" accept="image/png, image/jpeg, image/jpg" style="margin-top:10px;">
            </div>
            <div class="profile-form-group"><label>Ä°sim Soyisim</label><input type="text" name="name" value="{{ display_name }}" required></div>
            <div class="profile-form-group"><label>E-posta</label><input type="email" value="{{ user_email }}" disabled style="background:#f5f5f5; cursor:not-allowed;"><small style="color:#666; font-size:11px;">Email deÄŸiÅŸtirilemez</small></div>
            <div class="profile-form-group"><label>Telefon</label><input type="tel" name="phone" value="{{ user_phone or '' }}" placeholder="05XX XXX XX XX"></div>
            <div class="profile-form-group"><label>Yeni Åžifre (BoÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez)</label><input type="password" name="new_password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
            <button type="submit" class="btn-primary" style="width:100%;"><i class="fas fa-save"></i> Kaydet</button>
        </form>
    </div>
</div>

<div id="supportModal" class="modal-overlay" style="display:none;">
    <div class="modal-box support-modal" style="position: relative;">
        <button class="modal-close" onclick="document.getElementById('supportModal').style.display='none'">&times;</button>
        <h4><i class="fas fa-headset"></i> Destek & Ä°letiÅŸim</h4>
        <div id="supportLinksContainer">
            {% if support_links %}
                {% for key, link in support_links.items() %}
                    {% if link.enabled %}
                        <a href="{{ link.url }}" target="_blank" class="support-link-item">
                            <div style="display:flex; align-items:center; gap:10px;"><i class="{{ link.icon }}" style="font-size:20px; color:#1565c0;"></i><span style="font-weight:bold;">{{ link.title }}</span></div><i class="fas fa-external-link-alt" style="color:#999;"></i>
                        </a>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#999; padding:20px;">Destek bilgileri yÃ¼kleniyor...</p>
            {% endif %}
        </div>
    </div>
</div>

<form id="loadEventForm" action="/load_celestial_event" method="POST" style="display:none;">
    <input type="hidden" name="title" id="le_title"><input type="hidden" name="year" id="le_year"><input type="hidden" name="month" id="le_month"><input type="hidden" name="day" id="le_day"><input type="hidden" name="hour" id="le_hour"><input type="hidden" name="minute" id="le_minute">
</form>

{% endblock %}
    <script>

    // --- GENEL YARDIMCI FONKSÄ°YONLAR ---

    function openCelestialModal() {
        document.getElementById('celestialEventsModal').style.display = 'flex';
        const now = new Date();
        document.getElementById('ce_year').value = now.getFullYear();
        searchCelestialEvents(); 
    }

    function searchCelestialEvents() {
        const y = document.getElementById('ce_year').value;
        const z = document.getElementById('ce_zodiac').value; // Zodyak tipini al
        
        const eclipseList = document.getElementById('eclipseList');
        const phaseList = document.getElementById('phaseList');
        
        eclipseList.innerHTML = '<p style="text-align:center; color:#666; margin-top:10px;"><i class="fas fa-spinner fa-spin"></i> HesaplanÄ±yor...</p>';
        phaseList.innerHTML = '<p style="text-align:center; color:#666; margin-top:10px;"><i class="fas fa-spinner fa-spin"></i> HesaplanÄ±yor...</p>';
        
        fetch('/api/search_celestial_events', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ year: y, zodiac_type: z }) // Tipi sunucuya gÃ¶nder
        })
        .then(r => r.json())
        .then(data => {
            eclipseList.innerHTML = '';
            phaseList.innerHTML = '';
            
            if (data.success) {
                if (data.eclipses.length > 0) {
                    data.eclipses.forEach(ev => { eclipseList.appendChild(createEventItem(ev, '#c0392b')); });
                } else { eclipseList.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">Bu yÄ±l tutulma yok.</p>'; }

                if (data.phases.length > 0) {
                    data.phases.forEach(ev => { phaseList.appendChild(createEventItem(ev, '#2980b9')); });
                } else { phaseList.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">KayÄ±t bulunamadÄ±.</p>'; }
            } else { alert("Hata: " + data.error); }
        })
        .catch(err => { console.error(err); eclipseList.innerHTML = '<p style="color:red;">BaÄŸlantÄ± hatasÄ±.</p>'; });
    }

    function createEventItem(ev, color) {
        const item = document.createElement('div');
        item.className = "chart-select-item";
        item.style.display = "flex";
        item.style.justifyContent = "space-between";
        
        let icon = 'ðŸŒ‘'; 
        if (ev.title.includes('Dolunay')) icon = 'ðŸŒ•';
        if (ev.title.includes('Tutulma')) icon = 'ðŸŒ“';
        
        item.innerHTML = `
    <div style="display: flex; flex-direction: column; flex: 1;">
        <span class="chart-list-name" style="color:${color};">${icon} ${ev.title}</span>
        <span class="chart-list-date"><i class="far fa-calendar-alt"></i> ${ev.date_str}</span>
        <span class="chart-list-type">ðŸ“ ${ev.sign_info}</span>
    </div>
    <div style="text-align:right;">
        <button class="btn-jump" style="background:${color}; padding:2px 8px; font-size:9px;">AÃ‡</button>
    </div>
`;
        
        item.onclick = function() {
            document.getElementById('le_title').value = ev.title;
            document.getElementById('le_year').value = ev.year;
            document.getElementById('le_month').value = ev.month;
            document.getElementById('le_day').value = ev.day;
            document.getElementById('le_hour').value = ev.hour;
            document.getElementById('le_minute').value = ev.minute;
            document.getElementById('loadEventForm').submit();
        };
        return item;
    }

    function toggleRightPanel() { const wrapper = document.getElementById('rightSidebarWrapper'); const btnIcon = document.querySelector('#right-panel-toggle i'); if (!wrapper || !btnIcon) return; wrapper.classList.toggle('collapsed'); if (wrapper.classList.contains('collapsed')) { btnIcon.classList.remove('fa-chevron-right'); btnIcon.classList.add('fa-chevron-left'); } else { btnIcon.classList.remove('fa-chevron-left'); btnIcon.classList.add('fa-chevron-right'); } }
    function saveLastSelectedChart(index) { localStorage.setItem('lastSelectedChartIndex', index); }
    let searchTarget = 'form'; const ASTEROID_CATEGORY = ["Chiron", "Ceres", "Pallas", "Juno", "Vesta"]; const ANGLE_POINTS = ["ASC", "DSC", "IC", "MC"]; const DEFAULT_HIDDEN = ["GÃ¼ney DÃ¼ÄŸÃ¼mÃ¼", "Åžans NoktasÄ±", "Chiron", "Ceres", "Pallas", "Juno", "Vesta", "Eris", "Haumea", "Makemake", "ASC", "DSC", "IC", "MC"]; let visibilitySettings = JSON.parse(localStorage.getItem('astroVisibilitySettings')) || { hidden: [...DEFAULT_HIDDEN], visible_stars: [] }; if (!visibilitySettings.visible_stars) { visibilitySettings.visible_stars = []; } let selectionData = { planets: { visible: [], hidden: [] }, asteroids: { visible: [], hidden: [] }, angles: { visible: [], hidden: [] }, fixedstars: { visible: [], hidden: [] } }; function saveVisibilitySettings() { localStorage.setItem('astroVisibilitySettings', JSON.stringify(visibilitySettings)); } const ALWAYS_VISIBLE_STARS = ["Sirius", "Spica", "Antares", "Regulus", "Fomalhaut", "Aldebaran", "Vega", "Betelgeuse"];
    document.addEventListener('DOMContentLoaded', function() { var activeTabId = "{{ active_tab }}"; if (activeTabId === 'aktif') { let btn = document.querySelector('.tab-button[href*="aktif"]'); if(btn) btn.classList.add('active'); let tab = document.getElementById('aktif'); if(tab) tab.style.display = 'block'; let natalBtn = document.querySelector('.tab-button[href*="natal"]'); if(natalBtn) natalBtn.classList.remove('active'); let natalTab = document.getElementById('natal'); if(natalTab) natalTab.style.display = 'none'; } else if (activeTabId === 'transit' || activeTabId === 'sinastri' || activeTabId === 'instant_transit') { if(document.getElementById('natal')) document.getElementById('natal').style.display = 'block'; } else if (activeTabId) { var contentToShow = document.getElementById(activeTabId); if (contentToShow) contentToShow.style.display = 'block'; } updateReportVisibility(); restoreState(); setInterval(() => { const now = new Date(); const dateSpan = document.getElementById('bar_datetime'); if(dateSpan) dateSpan.innerText = now.toLocaleString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); const fYear = document.getElementById('form_bar_year'); if(fYear) fYear.value = now.getFullYear(); const fMonth = document.getElementById('form_bar_month'); if(fMonth) fMonth.value = now.getMonth()+1; const fDay = document.getElementById('form_bar_day'); if(fDay) fDay.value = now.getDate(); const fHour = document.getElementById('form_bar_hour'); if(fHour) fHour.value = now.getHours(); const fMin = document.getElementById('form_bar_minute'); if(fMin) fMin.value = now.getMinutes(); if(now.getSeconds() === 0) updateASC(); }, 1000); setTimeout(updateASC, 500); document.addEventListener("wheel", function(e){ if(document.activeElement.type === "number") document.activeElement.blur(); }); const citySearchBtn = document.getElementById('city_search_btn'); if(citySearchBtn) citySearchBtn.addEventListener('click', function(e) { e.preventDefault(); openFormLocationSearch(); }); var cityInput = document.getElementById('city_search_input'); if(cityInput) cityInput.addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); openFormLocationSearch(); } }); var modalInput = document.getElementById('modal_city_input'); if(modalInput) modalInput.addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); searchInModal(); } }); const chartArea = document.querySelector('.chart-wheel-placeholder'); if (chartArea) { chartArea.addEventListener('contextmenu', function(e) { e.preventDefault(); if (document.getElementById('astroChart')) { showCanvasContextMenu(e); } }); } window.addEventListener('click', function() { document.getElementById('transit-context-menu').style.display = 'none'; document.getElementById('sidebar-context-menu').style.display = 'none'; document.getElementById('canvas-context-menu').style.display = 'none'; const tooltip = document.getElementById('customTooltip'); if(tooltip) tooltip.style.display = 'none'; }); });
    // --- TOPLU SÄ°LME FONKSÄ°YONLARI ---
    let bulkDeleteMode = false;
    let selectedCharts = new Set();

    function toggleBulkDeleteMode() {
        bulkDeleteMode = !bulkDeleteMode;
        const controls = document.getElementById('bulkDeleteControls');
        const checkboxes = document.querySelectorAll('.bulk-delete-checkbox');
        
        if (bulkDeleteMode) {
            // Modu aÃ§
            if (controls) controls.style.display = 'block';
            checkboxes.forEach(cb => {
                cb.style.display = 'inline-block';
                cb.checked = false;
            });
            selectedCharts.clear();
        } else {
            // Modu kapat
            if (controls) controls.style.display = 'none';
            checkboxes.forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });
            selectedCharts.clear();
        }
    }

    function toggleChartSelection(index) {
        const checkbox = document.querySelector(`.bulk-delete-checkbox[data-index="${index}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                selectedCharts.add(index);
            } else {
                selectedCharts.delete(index);
            }
        }
    }

    function deleteSelectedCharts() {
        if (selectedCharts.size === 0) {
            alert('LÃ¼tfen en az bir harita seÃ§in!');
            return;
        }
        
        if (!confirm(`${selectedCharts.size} harita silinecek. Emin misiniz?`)) {
            return;
        }
        
        const indices = Array.from(selectedCharts).sort((a, b) => b - a); // BÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
        
        fetch('/bulk_delete_charts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ indices: indices })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('BaÄŸlantÄ± hatasÄ±!');
        });
    }

    // --- SOL MENÃœ Ä°Ã‡Ä°N AKILLI KONUMLANDIRMA ---

    function openSidebarLocationSearch() {
        const modal = document.getElementById('sidebarLocationModal');
        const input = document.getElementById('sidebar_city_input');
        const list = document.getElementById('sidebarResultList');
        
        // TÄ±klanan Ã¶ÄŸeyi referans alalÄ±m (Konum yazÄ±sÄ± veya kutusu)
        const triggerEl = document.getElementById('bar_location_display');
        
        if(modal && triggerEl) {
            modal.style.display = 'block'; // Flex deÄŸil Block yapÄ±yoruz
            
            // --- KOORDÄ°NAT HESAPLAMA SÄ°HRÄ° ---
            // 1. TÄ±klanan kutunun (veya sidebar'Ä±n) yerini bul
            // .closest('.transit-info-card-box') diyerek tÃ¼m kutuyu baz alÄ±yoruz
            const parentBox = triggerEl.closest('.transit-info-card-box') || triggerEl;
            const rect = parentBox.getBoundingClientRect();
            
            // 2. Modal kutusunu bul
            const modalBox = modal.querySelector('.modal-box');
            
            // 3. Konumu ayarla:
            // LEFT: Kutunun saÄŸ kenarÄ± (rect.right) + 5px boÅŸluk
            // TOP: Kutunun Ã¼st kenarÄ± (rect.top)
            if(modalBox) {
                modalBox.style.left = (rect.right + 5) + 'px'; 
                modalBox.style.top = (rect.top) + 'px';
            }

            // Inputu temizle ve odaklan
            if(input) { 
                input.value = ""; 
                input.focus(); 
                // Enter tuÅŸu desteÄŸi
                input.onkeypress = function(e) {
                    if(e.key === "Enter") searchSidebarLocation();
                };
            }
            if(list) list.innerHTML = "";
            
            // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapansÄ±n (Overlay ÅŸeffaf olduÄŸu iÃ§in bu event'i wrapper'a veriyoruz)
            modal.onclick = function(e) {
                if(e.target === modal) closeSidebarLocationModal();
            }
        }
    }

    // 2. Pencereyi KAPAT
    function closeSidebarLocationModal() {
        document.getElementById('sidebarLocationModal').style.display = 'none';
    }

    // 3. ARAMA YAP (Sol menÃ¼ iÃ§in)
    function searchSidebarLocation() {
        const city = document.getElementById('sidebar_city_input').value;
        if(!city) return;

        document.getElementById('sidebar-loading').style.display = 'block';
        const list = document.getElementById('sidebarResultList');
        list.innerHTML = "";

        // API isteÄŸi aynÄ± kalabilir, backend deÄŸiÅŸmiyor
        fetch('/api/search_location', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ city: city, source: 'bar' }) 
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('sidebar-loading').style.display = 'none';
            
            if(data.results && data.results.length > 0) {
                data.results.forEach(loc => {
                    const li = document.createElement('li');
                    li.style.padding = "10px";
                    li.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
                    li.style.cursor = "pointer";
                    li.style.fontSize = "13px";
                    li.innerHTML = `<strong>${loc.address}</strong> <span style="color:#bbb;">(UTC ${loc.tz_offset})</span>`;
                    
                    // TÄ±klayÄ±nca SADECE SOL MENÃœYÃœ GÃœNCELLE
                    li.onclick = function() {
                        applySidebarLocation(loc);
                    };
                    
                    // Hover efekti
                    li.onmouseover = function() { this.style.background = "rgba(255,255,255,0.1)"; };
                    li.onmouseout = function() { this.style.background = "transparent"; };
                    
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = "<li style='padding:10px; color: #ff7675;'>SonuÃ§ bulunamadÄ±.</li>";
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('sidebar-loading').style.display = 'none';
        });
    }

    // 4. SEÃ‡Ä°LEN KONUMU UYGULA (Ã‡akÄ±ÅŸma Ã–nleyici)
    function applySidebarLocation(loc) {
        // Gizli inputlarÄ± gÃ¼ncelle (Transit gÃ¶nderirken bunlar kullanÄ±lÄ±yor)
        if(document.getElementById('bar_lat')) document.getElementById('bar_lat').value = loc.lat;
        if(document.getElementById('bar_lon')) document.getElementById('bar_lon').value = loc.lon;
        if(document.getElementById('bar_tz')) document.getElementById('bar_tz').value = loc.tz_offset;
        if(document.getElementById('bar_loc_name')) document.getElementById('bar_loc_name').value = loc.address;
        
        // GÃ¶rÃ¼nÃ¼r yazÄ±yÄ± gÃ¼ncelle
        const displaySpan = document.getElementById('bar_location_display');
        if(displaySpan) {
            displaySpan.innerText = loc.address;
            displaySpan.style.color = "#ff9f43"; // DeÄŸiÅŸtiÄŸini belli etmek iÃ§in turuncu yap
        }

        // LocalStorage'a kaydet (Sayfa yenilenirse hatÄ±rla)
        localStorage.setItem('astroBarLocation', JSON.stringify({ 
            lat: loc.lat, 
            lon: loc.lon, 
            tz: loc.tz_offset, 
            name: loc.address 
        }));
        
        // ASC derecesini hemen gÃ¼ncelle
        if(typeof updateASC === 'function') updateASC();

        // Pencereyi kapat
        closeSidebarLocationModal();
    }

    function openTransitMenu(event) { event.stopPropagation(); const menu = document.getElementById('transit-context-menu'); const rect = event.currentTarget.getBoundingClientRect(); menu.style.left = (rect.right + 5) + 'px'; menu.style.top = rect.top + 'px'; menu.style.display = 'block'; } function saveTimeStep() { const val = document.getElementById('timeStepSelect').value; localStorage.setItem('astroTimeStep', val); } function restoreState() { const s=localStorage.getItem('astroTimeStep'); if(s) { const el = document.getElementById('timeStepSelect'); if(el) el.value=s; } const l=localStorage.getItem('astroBarLocation'); if(l) { const d=JSON.parse(l); if(document.getElementById('bar_lat')) document.getElementById('bar_lat').value=d.lat; if(document.getElementById('bar_lon')) document.getElementById('bar_lon').value=d.lon; if(document.getElementById('bar_tz')) document.getElementById('bar_tz').value=d.tz; if(document.getElementById('bar_loc_name')) document.getElementById('bar_loc_name').value=d.name; if(document.getElementById('bar_location_display')) document.getElementById('bar_location_display').innerText=d.name; } } function adjustTime(factor) { document.getElementById('time_adjust_unit').value = document.getElementById('timeStepSelect').value; document.getElementById('time_adjust_amount').value = factor; document.getElementById('timeAdjustForm').submit(); } function updateASC() { const latEl = document.getElementById('bar_lat'); if(!latEl) return; const lat = latEl.value; const lon = document.getElementById('bar_lon').value; const tz = document.getElementById('bar_tz').value; const now = new Date(); fetch('/api/get_asc', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ year:now.getFullYear(), month:now.getMonth()+1, day:now.getDate(), hour:now.getHours(), minute:now.getMinutes(), lat:lat, lon:lon, tz:tz }) }).then(r=>r.json()).then(d => { if(d.success && document.getElementById('bar_asc_degree')) document.getElementById('bar_asc_degree').innerText = d.asc; }).catch(err => console.log("ASC Error", err)); }

    // 1. SÄ°DEBAR SAÄž TIK (Aktif Listesi)
function showContextMenu(event, chartIndex) {
    if(!event) return;
    event.preventDefault(); // VarsayÄ±lan saÄŸ tÄ±k menÃ¼sÃ¼nÃ¼ engelle
    
    // DiÄŸer menÃ¼leri kapat
    const canvasMenu = document.getElementById('canvas-context-menu');
    const transitMenu = document.getElementById('transit-context-menu');
    if(canvasMenu) canvasMenu.style.display = 'none';
    if(transitMenu) transitMenu.style.display = 'none';

    const menu = document.getElementById('sidebar-context-menu');
    if(!menu) return;

    // MenÃ¼yÃ¼ gÃ¶rÃ¼nÃ¼r yap ve konumlandÄ±r
    menu.style.display = 'block';
    menu.style.left = event.clientX + 'px';
    menu.style.top = event.clientY + 'px';

    // Link gÃ¼ncellemeleri
    const saveLink = document.getElementById('context-save');
    const deleteLink = document.getElementById('context-delete');
    const editBtn = document.getElementById('context-edit');

    if(saveLink) saveLink.href = "/save_active_chart/" + chartIndex;
    if(deleteLink) deleteLink.href = "/delete_active_chart/" + chartIndex;
    
    // --- Ã–ZEL Ä°STEK: DÃ¼zenle butonu mantÄ±ÄŸÄ± ---
    // Veriyi gÃ¼venli bir ÅŸekilde alÄ±yoruz
    const activeCharts = {{ active_charts | tojson | safe if active_charts else '[]' }};
    const chart = activeCharts[chartIndex];

    if(editBtn) {
        // Senin istediÄŸin ÅŸart: Natal veya Transit ise gÃ¶ster
        if(chart && (chart.type === 'natal' || chart.type === 'transit' || chart.map_type === 'natal' || chart.map_type === 'transit')) {
            editBtn.href = "/edit_active_chart/" + chartIndex;
            editBtn.style.display = 'flex'; // Profil tasarÄ±mÄ±na uygun olmasÄ± iÃ§in flex
        } else {
            editBtn.style.display = 'none'; // Åžart saÄŸlanmazsa gizle
        }
    }
}
    // --- TOOLTIP POZÄ°SYON DÃœZELTMESÄ° (MOUSE Ä°MLECÄ°NÄ°N TAM YANINDA) ---
    function showChartTooltip(e, name, deg, sign, min) { 
        const tooltip = document.getElementById('customTooltip'); 
        if (!tooltip) return; 
        tooltip.innerHTML = `<span class="tooltip-title">${name}</span><span class="tooltip-detail">${deg} ${sign} ${min}</span>`; 
        // Mouse imlecinin TAM yanÄ±nda (0px uzaklÄ±kta, saÄŸ-alt kÃ¶ÅŸede)
        tooltip.style.left = (e.clientX + 2) + 'px'; 
        tooltip.style.top = (e.clientY + 2) + 'px'; 
        tooltip.style.display = 'block'; 
    }

    function showCanvasContextMenu(event) { if(!event) return; event.preventDefault(); document.getElementById('sidebar-context-menu').style.display = 'none'; const menu = document.getElementById('canvas-context-menu'); menu.style.display = 'block'; menu.style.left = event.pageX + 'px'; menu.style.top = event.pageY + 'px'; }
    function calculateDetails(absDeg, startDeg, signName) { let relDeg = absDeg - startDeg; if (relDeg < 0) relDeg += 360; const degrees = Math.floor(relDeg); const minutesDecimal = (relDeg - degrees) * 60; const minutes = Math.round(minutesDecimal); if (minutes === 60) { return { signName: signName, deg: degrees + 1, min: 0 }; } return { signName: signName, deg: degrees, min: minutes }; } function getRelativeDegreeJS(absDeg) { absDeg %= 360; let boundaries = []; if (typeof chartData !== 'undefined' && chartData.boundaries) { boundaries = chartData.boundaries; } else { boundaries = [ {name:"KoÃ§", start:0, end:30}, {name:"BoÄŸa", start:30, end:60}, {name:"Ä°kizler", start:60, end:90}, {name:"YengeÃ§", start:90, end:120}, {name:"Aslan", start:120, end:150}, {name:"BaÅŸak", start:150, end:180}, {name:"Terazi", start:180, end:210}, {name:"Akrep", start:210, end:240}, {name:"Yay", start:240, end:270}, {name:"OÄŸlak", start:270, end:300}, {name:"Kova", start:300, end:330}, {name:"BalÄ±k", start:330, end:360} ]; } for (let i = 0; i < boundaries.length; i++) { const b = boundaries[i]; if (b.start < b.end) { if (absDeg >= b.start && absDeg < b.end) return calculateDetails(absDeg, b.start, b.name); } else { if (absDeg >= b.start || absDeg < b.end) return calculateDetails(absDeg, b.start, b.name); } } return { signName: "Bilinmeyen", deg: 0, min: 0 }; } let houseOverflowMap = {}; function calculateHouseOverflows(planetsByHouse, hBounds) { const DEG_PER_PLANET = 6.0; houseOverflowMap = {}; for(let i=1; i<=12; i++) { let housePlanets = planetsByHouse[i] || []; let count = housePlanets.length; if (count === 0) continue; let bounds = hBounds[i-1]; let houseWidth = (bounds.end - bounds.start + 360) % 360; let requiredWidth = count * DEG_PER_PLANET; if (requiredWidth > houseWidth) { let extraSpace = requiredWidth - houseWidth + 2.0; houseOverflowMap[i] = extraSpace; } else { houseOverflowMap[i] = 0; } } } function describeArc(x, y, radius, startAngle, endAngle){ var start = getCoords(radius, endAngle); var end = getCoords(radius, startAngle); var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1"; var d = [ "M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y ].join(" "); return d; }
    function openFormLocationSearch() { const cityInput = document.getElementById('city_search_input'); const cityVal = cityInput.value; if(!cityVal) { alert("LÃ¼tfen bir ÅŸehir adÄ± girin."); return; } searchTarget = 'form'; document.getElementById('locationModalTitle').innerText = "DoÄŸum Yeri Ara (UTC Hesapla)"; document.getElementById('modal_city_input').value = cityVal; document.getElementById('locationResultList').innerHTML = ""; document.getElementById('locationModal').style.display = 'flex'; document.getElementById('modal_city_input').focus(); searchInModal(); } 
    function searchInModal() {
    const city = document.getElementById('modal_city_input').value;
    if (!city) return;

    const now = new Date();
    let y = now.getFullYear();
    let m = now.getMonth() + 1;
    let d = now.getDate();
    let source = 'unknown';

    if (searchTarget === 'form') {
        source = 'form';
        const yInput = document.getElementById('year');
        const mInput = document.getElementById('month');
        const dInput = document.getElementById('day');
        if (yInput && mInput && dInput && yInput.value && mInput.value && dInput.value) {
            y = yInput.value;
            m = mInput.value;
            d = dInput.value;
        }
    } else {
        source = 'bar';
    }

    document.getElementById('modal-loading').style.display = 'block';
    document.getElementById('locationResultList').innerHTML = '';

    fetch('/api/search_location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ city: city, year: y, month: m, day: d, source: source })
    })
    .then(r => r.json())
    .then(d_resp => {
        document.getElementById('modal-loading').style.display = 'none';
        const ul = document.getElementById('locationResultList');
        ul.innerHTML = '';

        if (d_resp.success && d_resp.results && d_resp.results.length > 0) {
            d_resp.results.forEach(l => {
                const li = document.createElement('li');
                li.className = 'location-item';
                let utcSign = l.tz_offset >= 0 ? "+" : "";
                let utcShow = utcSign + l.tz_offset;

                // TASARIM KODLARI SÄ°LÄ°NDÄ°, TEMÄ°Z YAPI EKLENDÄ°:
                li.innerHTML = `
                    <div class="loc-name">${l.address}</div>
                    <div class="loc-details">
                        <span class="loc-utc">UTC ${utcShow}</span>
                        <span class="loc-coords">(${l.lat.toFixed(1)}, ${l.lon.toFixed(1)})</span>
                    </div>
                `;

                li.onclick = () => { selectLocation(l); };
                ul.appendChild(li);
            });
        } else {
            ul.innerHTML = '<li style="padding:10px; color:red;">SonuÃ§ bulunamadÄ±.</li>';
        }
    })
    .catch(err => {
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('locationResultList').innerHTML = '<li style="padding:10px; color:red;">Sunucu hatasÄ±!</li>';
    });
}

function selectLocation(l) {
    if (searchTarget === 'bar') {
        document.getElementById('bar_lat').value = l.lat;
        document.getElementById('bar_lon').value = l.lon;
        document.getElementById('bar_tz').value = l.tz_offset;
        document.getElementById('bar_loc_name').value = l.address;
        document.getElementById('bar_location_display').innerText = l.address;
        localStorage.setItem('astroBarLocation', JSON.stringify({ lat: l.lat, lon: l.lon, tz: l.tz_offset, name: l.address }));
        updateASC();
    } else {
        if (document.getElementById('lat')) document.getElementById('lat').value = l.lat;
        if (document.getElementById('lon')) document.getElementById('lon').value = l.lon;
        if (document.getElementById('tz_offset')) document.getElementById('tz_offset').value = l.tz_offset;
        if (document.getElementById('location_name')) document.getElementById('location_name').value = l.address;
        if (document.getElementById('city_search_input')) document.getElementById('city_search_input').value = l.address.split(',')[0];
        
        let utcSign = l.tz_offset >= 0 ? "+" : "";
        let utcFormatted = utcSign + l.tz_offset;
        const displayEl = document.getElementById('selected_location_display');
        
        if (displayEl) {
            displayEl.innerHTML = `<i class="fas fa-check-circle"></i> ${l.address} (UTC ${utcFormatted})`;
            displayEl.style.color = "#27ae60";
        }
        
        const utcInp = document.getElementById('tz_offset');
        if (utcInp && typeof validateUtcInput === 'function') validateUtcInput(utcInp);
    }
    closeLocationModal();
}

function submitInstantTransit(type) {
    document.getElementById('form_transit_type').value = type;
    document.getElementById('form_bar_lat').value = document.getElementById('bar_lat').value;
    document.getElementById('form_bar_lon').value = document.getElementById('bar_lon').value;
    document.getElementById('form_bar_tz').value = document.getElementById('bar_tz').value;
    document.getElementById('form_bar_loc_name').value = document.getElementById('bar_loc_name').value;
    document.getElementById('instantTransitForm').submit();
}

let currentStarCategory = null;

function closeSelectionModal() {
    document.getElementById('selectionModal').style.display = 'none';
    currentStarCategory = null;
    if (typeof drawZodiac === "function") drawZodiac();
    if (typeof drawAllPlanets === "function") drawAllPlanets();
}

function openSelectionModal(dataType, title) {
    document.getElementById('canvas-context-menu').style.display = 'none';
    document.getElementById('selectionModalTitle').innerText = title;
    document.getElementById('selectionModal').style.display = 'flex';
    currentStarCategory = null;
    prepareSelectionData();
    renderSelectionLists(dataType);
}

function prepareSelectionData() {
    if (typeof chartData === 'undefined') return;
    selectionData.planets.visible = [];
    selectionData.planets.hidden = [];
    selectionData.asteroids.visible = [];
    selectionData.asteroids.hidden = [];
    selectionData.fixedstars.visible = [];
    selectionData.fixedstars.hidden = [];
    
    for (let pName in chartData.planets) {
        let targetGroup = 'planets';
        if (ASTEROID_CATEGORY.includes(pName)) {
            targetGroup = 'asteroids';
        }
        if (visibilitySettings.hidden.includes(pName)) {
            selectionData[targetGroup].hidden.push({ name: pName });
        } else {
            selectionData[targetGroup].visible.push({ name: pName });
        }
    }
    
    if (chartData.fixed_stars) {
        for (let sName in chartData.fixed_stars) {
            let sData = chartData.fixed_stars[sName];
            let signName = sData[3];
            if (signName === "YÄ±lancÄ±" || signName === "Ophiuchus") signName = "Akrep";
            let item = { name: sName, category: signName };
            let isVisible = false;
            
            if (visibilitySettings.visible_stars.includes(sName)) {
                isVisible = true;
            } else if (ALWAYS_VISIBLE_STARS.includes(sName) && !visibilitySettings.hidden.includes(sName)) {
                isVisible = true;
            }
            
            if (isVisible) {
                selectionData.fixedstars.visible.push(item);
            } else {
                selectionData.fixedstars.hidden.push(item);
            }
        }
    }
}

function renderSelectionLists(dataType) {
    const visibleList = document.getElementById('visibleList');
    const hiddenList = document.getElementById('hiddenList');
    const backBtn = document.getElementById('backBtnContainer');
    const hiddenTitle = document.getElementById('hiddenTitle');
    visibleList.innerHTML = '';
    hiddenList.innerHTML = '';
    
    if (dataType === 'fixedstars') {
        if (currentStarCategory === null) {
            backBtn.style.display = 'none';
            hiddenTitle.innerText = "Gizli (Kategoriler)";
            const signs = ["KoÃ§", "BoÄŸa", "Ä°kizler", "YengeÃ§", "Aslan", "BaÅŸak", "Terazi", "Akrep", "Yay", "OÄŸlak", "Kova", "BalÄ±k"];
            signs.forEach(sign => {
                const li = document.createElement('li');
                li.className = 'chart-select-item folder-item';
                li.innerHTML = `<i class="fas fa-folder"></i> ${sign} TakÄ±myÄ±ldÄ±zÄ±`;
                li.onclick = () => { currentStarCategory = sign; renderSelectionLists('fixedstars'); };
                hiddenList.appendChild(li);
            });
        } else {
            backBtn.style.display = 'block';
            hiddenTitle.innerText = `Gizli (${currentStarCategory})`;
            const starsInFolder = selectionData.fixedstars.hidden.filter(item => item.category === currentStarCategory);
            if (starsInFolder.length === 0) {
                hiddenList.innerHTML = '<li style="padding:10px; color:#999;">Bu kategoride gizli yÄ±ldÄ±z yok.</li>';
            } else {
                starsInFolder.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'chart-select-item';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.innerHTML = `<i class="fas fa-arrow-left" style="color: #27ae60;"></i> <span>${item.name}</span>`;
                    li.onclick = () => toggleVisibility(item.name, dataType);
                    hiddenList.appendChild(li);
                });
            }
        }
        
        selectionData.fixedstars.visible.forEach((item) => {
            const li = document.createElement('li');
            li.className = 'chart-select-item';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.innerHTML = `<span>${item.name}</span> <i class="fas fa-arrow-right" style="color: #c0392b;"></i>`;
            li.onclick = () => toggleVisibility(item.name, dataType);
            visibleList.appendChild(li);
        });
        return;
    }
    
    backBtn.style.display = 'none';
    hiddenTitle.innerText = "Gizli (Ekle)";
    if (!selectionData[dataType]) return;
    
    selectionData[dataType].visible.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'chart-select-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.innerHTML = `<span>${item.name}</span> <i class="fas fa-arrow-right" style="color: #c0392b;"></i>`;
        li.onclick = () => toggleVisibility(item.name, dataType);
        visibleList.appendChild(li);
    });
    
    selectionData[dataType].hidden.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'chart-select-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.innerHTML = `<i class="fas fa-arrow-left" style="color: #27ae60;"></i> <span>${item.name}</span>`;
        li.onclick = () => toggleVisibility(item.name, dataType);
        hiddenList.appendChild(li);
    });
}

function goBackToFolders() {
    currentStarCategory = null;
    renderSelectionLists('fixedstars');
}

function toggleVisibility(name, currentDataType) {
    if (currentDataType === 'fixedstars') {
        if (visibilitySettings.visible_stars.includes(name)) {
            const idx = visibilitySettings.visible_stars.indexOf(name);
            visibilitySettings.visible_stars.splice(idx, 1);
        } else if (ALWAYS_VISIBLE_STARS.includes(name) && !visibilitySettings.hidden.includes(name)) {
            visibilitySettings.hidden.push(name);
        } else {
            const hIdx = visibilitySettings.hidden.indexOf(name);
            if (hIdx > -1) visibilitySettings.hidden.splice(hIdx, 1);
            visibilitySettings.visible_stars.push(name);
        }
    } else {
        const index = visibilitySettings.hidden.indexOf(name);
        if (index > -1) {
            visibilitySettings.hidden.splice(index, 1);
        } else {
            visibilitySettings.hidden.push(name);
        }
    }
    saveVisibilitySettings();
    prepareSelectionData();
    renderSelectionLists(currentDataType);
    updateReportVisibility();
    
    if (typeof drawZodiac === "function" && typeof chartData !== 'undefined') {
        const svg = document.getElementById('astroChart');
        if (svg) {
            while (svg.firstChild) { svg.removeChild(svg.firstChild); }
            drawZodiac();
            drawAllPlanets();
        }
    }
}

function updateReportVisibility() {
    const hiddenList = visibilitySettings.hidden;
    const visibleStars = visibilitySettings.visible_stars;
    const rows = document.querySelectorAll('.report-row');
    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const type = row.getAttribute('data-type');
        if (type === 'star') {
            let shouldShow = false;
            if (visibleStars.includes(name)) {
                shouldShow = true;
            } else if (ALWAYS_VISIBLE_STARS.includes(name) && !hiddenList.includes(name)) {
                shouldShow = true;
            }
            if (shouldShow) {
                row.style.setProperty('display', 'table-row', 'important');
            } else {
                row.style.setProperty('display', 'none', 'important');
            }
        } else {
            if (hiddenList.includes(name)) {
                row.style.display = 'none';
            } else {
                row.style.display = 'table-row';
            }
        }
    });
}

function toggleUserMenu(event) {
    event.stopPropagation();
    const menu = document.getElementById('userDropdownMenu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// DÄ±ÅŸarÄ± tÄ±klandÄ±ÄŸÄ±nda menÃ¼yÃ¼ kapat
window.addEventListener('click', function() {
    const menu = document.getElementById('userDropdownMenu');
    if(menu) menu.style.display = 'none';
});

// Premium modal
function openPremiumModal() {
    alert('Premium Ã¶zellikler yakÄ±nda eklenecek!');
}

// Profil modal
function openProfileModal() {
    document.getElementById('profileModal').style.display = 'flex';
}

// Destek modal  
function openSupportModal() {
    document.getElementById('supportModal').style.display = 'flex';
}

    {% if last_chart %}
        const chartData = JSON.parse('{{ last_chart | tojson | safe }}');

        // --- 1. ASC SABÄ°TLEME ---
        // Ev sistemi nereden geliyorsa (Houses objesi), ASC odur.
        // Bu sayede ASC her zaman sol tarafta (Saat 9) sabit kalÄ±r.
        let ascDegree = 0;
        if (chartData.houses && chartData.houses['CUSP1']) {
            ascDegree = chartData.houses['CUSP1'];
        } else if (chartData.chart1 && chartData.chart1.cusps && chartData.chart1.cusps['ASC']) {
            ascDegree = chartData.chart1.cusps['ASC'];
        }

        const isSynastry = !!(chartData.chart1 && chartData.chart2);
        
        // --- 2. GÃ–RSEL AYARLAR ---
        const PLANET_IMAGE_MAP = { "GÃ¼neÅŸ": "{{ url_for('static', filename='images/semboller/gunes.svg') }}", "Ay": "{{ url_for('static', filename='images/semboller/ay.svg') }}", "MerkÃ¼r": "{{ url_for('static', filename='images/semboller/merkur.svg') }}", "VenÃ¼s": "{{ url_for('static', filename='images/semboller/venus.svg') }}", "Mars": "{{ url_for('static', filename='images/semboller/mars.svg') }}", "JÃ¼piter": "{{ url_for('static', filename='images/semboller/jupiter.svg') }}", "SatÃ¼rn": "{{ url_for('static', filename='images/semboller/saturn.svg') }}", "UranÃ¼s": "{{ url_for('static', filename='images/semboller/uranus.svg') }}", "NeptÃ¼n": "{{ url_for('static', filename='images/semboller/neptun.svg') }}", "PlÃ¼ton": "{{ url_for('static', filename='images/semboller/pluton.svg') }}", "Kuzey DÃ¼ÄŸÃ¼mÃ¼": "{{ url_for('static', filename='images/semboller/kuzey_dugumu.svg') }}", "GÃ¼ney DÃ¼ÄŸÃ¼mÃ¼": "{{ url_for('static', filename='images/semboller/guney_dugumu.svg') }}", "Åžans NoktasÄ±": "{{ url_for('static', filename='images/semboller/sans_noktasi.svg') }}", "Chiron": "{{ url_for('static', filename='images/semboller/chiron.svg') }}", "Ceres": "{{ url_for('static', filename='images/semboller/ceres.svg') }}", "Pallas": "{{ url_for('static', filename='images/semboller/pallas.svg') }}", "Juno": "{{ url_for('static', filename='images/semboller/juno.svg') }}", "Vesta": "{{ url_for('static', filename='images/semboller/vesta.svg') }}", "Eris": "{{ url_for('static', filename='images/semboller/eris.svg') }}", "Makemake": "{{ url_for('static', filename='images/semboller/makemake.svg') }}", "Haumea": "{{ url_for('static', filename='images/semboller/haumea.svg') }}" };
        const ZODIAC_IMAGE_MAP = { "KoÃ§": "{{ url_for('static', filename='images/semboller/koc.svg') }}", "BoÄŸa": "{{ url_for('static', filename='images/semboller/boga.svg') }}", "Ä°kizler": "{{ url_for('static', filename='images/semboller/ikizler.svg') }}", "YengeÃ§": "{{ url_for('static', filename='images/semboller/yengec.svg') }}", "Aslan": "{{ url_for('static', filename='images/semboller/aslan.svg') }}", "BaÅŸak": "{{ url_for('static', filename='images/semboller/basak.svg') }}", "Terazi": "{{ url_for('static', filename='images/semboller/terazi.svg') }}", "Akrep": "{{ url_for('static', filename='images/semboller/akrep.svg') }}", "Yay": "{{ url_for('static', filename='images/semboller/yay.svg') }}", "OÄŸlak": "{{ url_for('static', filename='images/semboller/oglak.svg') }}", "Kova": "{{ url_for('static', filename='images/semboller/kova.svg') }}", "BalÄ±k": "{{ url_for('static', filename='images/semboller/balik.svg') }}" };
        
        const SYMBOL_SIZE = 23; 
        const PLANET_SIGN_SYMBOL_SIZE = 18; 
        const CUSP_SIGN_SYMBOL_SIZE = 18; 
        const CUSP_TEXT_OFFSET = 25; 
        const vg = document.getElementById('astroChart'); 
        const svg = vg; 
        const cx = 350; 
        const cy = 350;
        
        const R_ZODIAC_OUTER = 350; 
        const R_ZODIAC_INNER = 310; 
        const R_DUAL_DIVIDER = 310;
        const R_HOUSE_LABELS = 40; 
        const R_CUSP_SYMBOL_CENTER = 330; 
        const R_PLANETS_AVG = 285; 
        const R_PLANET_DEGREES = 255; 
        const R_PLANET_SIGN = 230; 
        const R_PLANET_MINUTE = 205; 
        const R_PLANET_RETRO = 180; 
        const R_INNER_RING = 30; 
        const SVG_NS = "http://www.w3.org/2000/svg"; 

        // --- KOORDÄ°NAT HESAPLAMA ---
        function getCoords(r, a) { 
            const rad = (-((a - ascDegree + 360) % 360) + 180) * (Math.PI / 180); 
            return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) }; 
        }

        function createSvgElement(t, a) { const e = document.createElementNS(SVG_NS, t); for (let k in a) e.setAttribute(k, a[k]); return e; }
        function getAngleDiff(a, b) { let d = Math.abs(a - b); return Math.min(d, 360 - d); }

        // --- ZODIAC Ã‡Ä°ZÄ°MÄ° ---
        function drawZodiac() { 
            svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_OUTER, fill: 'white', stroke: 'none' })); 
            svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_OUTER, fill: 'none', class: 'chart-line' })); 
            svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_INNER, fill: 'none', class: 'chart-line' })); 
            
            if (isSynastry) { 
                svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_DUAL_DIVIDER, fill: 'none', stroke: '#999', 'stroke-width': '1', 'stroke-dasharray': '2,2' }));
                svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_ZODIAC_OUTER - 5, fill: 'none', stroke: '#eee', 'stroke-width': '1' }));
            } 
        }

        // --- EVLERÄ° Ã‡Ä°ZME ---
        function drawHouses(hBounds) { 
            const houses = chartData.houses; 
            if (!houses) return []; 
            svg.appendChild(createSvgElement('circle', { cx: cx, cy: cy, r: R_INNER_RING, fill: 'none', class: 'chart-line' })); 
            
            if (!hBounds) { 
                hBounds = []; 
                for (let i = 1; i <= 12; i++) { 
                    const s = houses[`CUSP${i}`]; 
                    const e = houses[`CUSP${(i % 12) + 1}`]; 
                    if (s !== undefined) hBounds.push({ id: i, start: s, end: e }); 
                } 
            } 
            
            for (let i = 1; i <= 12; i++) { 
                const cuspDeg = houses[`CUSP${i}`]; 
                if (cuspDeg === undefined) continue; 
                
                const nextCusp = houses[`CUSP${(i % 12) + 1}`];
                const outerRadius = isSynastry ? R_DUAL_DIVIDER : R_ZODIAC_INNER;
                
                // Ev Ã‡izgisi - 1. ve 10. evler iÃ§in Ã¶zel stil
                const lineClass = (i === 1) ? 'asc-line' : (i === 10) ? 'mc-line' : 'house-cusp';
                
                if (!isSynastry) {
                    let overflow = houseOverflowMap[i] || 0;
                    if (overflow > 0 && i !== 1 && i !== 10) {
                        // BasamaklÄ± Ã§izgi (1. ve 10. ev hariÃ§)
                        let pStart = getCoords(R_INNER_RING, cuspDeg); 
                        let pMidIn = getCoords(150, cuspDeg); 
                        let shiftedAngle = (cuspDeg - overflow + 360) % 360; 
                        let pMidOut = getCoords(150, shiftedAngle); 
                        let pEnd = getCoords(outerRadius, shiftedAngle); 
                        let d = `M ${pStart.x} ${pStart.y} L ${pMidIn.x} ${pMidIn.y} L ${pMidOut.x} ${pMidOut.y} L ${pEnd.x} ${pEnd.y}`; 
                        svg.appendChild(createSvgElement('path', { d: d, class: 'house-cusp-stepped' })); 
                    } else { 
                        // DÃ¼z Ã§izgi (1. ve 10. ev iÃ§in her zaman dÃ¼z)
                        const p1 = getCoords(R_INNER_RING, cuspDeg); 
                        const p2 = getCoords(outerRadius, cuspDeg); 
                        svg.appendChild(createSvgElement('line', { x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y, class: lineClass })); 
                    }
                } else {
                    // Sinastri iÃ§in dÃ¼z Ã§izgi
                    const p1 = getCoords(R_INNER_RING, cuspDeg); 
                    const p2 = getCoords(outerRadius, cuspDeg); 
                    svg.appendChild(createSvgElement('line', { x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y, class: lineClass })); 
                }
                
                // Ev NumarasÄ±
                let diff = (nextCusp - cuspDeg + 360) % 360;
                let midAngle = (cuspDeg + diff / 2) % 360; 
                if (getAngleDiff(cuspDeg, nextCusp) > 180) midAngle = (cuspDeg + diff / 2 + 180) % 360; 
                const pLabelCoords = getCoords(R_HOUSE_LABELS, midAngle); 
                const labelEl = createSvgElement('text', { x: pLabelCoords.x, y: pLabelCoords.y, class: 'house-label', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); 
                labelEl.textContent = i; 
                svg.appendChild(labelEl); 
                
                // Ev Derecesi/BurÃ§ Bilgisi
                const degreeInfo = getRelativeDegreeJS(cuspDeg); 
                const signImageUrl = ZODIAC_IMAGE_MAP[degreeInfo.signName]; 
                const mInt = degreeInfo.min; 
                const minStr = (mInt < 10 ? '0' + mInt : '' + mInt); 
                const pCuspSign = getCoords(R_CUSP_SYMBOL_CENTER, cuspDeg); 
                const rotatedAngle = (cuspDeg - ascDegree + 360) % 360; 
                const visualAngleRad = (-rotatedAngle + 180) * (Math.PI / 180); 
                const perpAngleRad = visualAngleRad + (Math.PI / 2); 
                const dx = CUSP_TEXT_OFFSET * Math.cos(perpAngleRad); 
                const dy = CUSP_TEXT_OFFSET * Math.sin(perpAngleRad); 
                let pCuspDegree, pCuspMinute; 
                if (rotatedAngle > 180) { 
                    pCuspDegree = { x: pCuspSign.x - dx, y: pCuspSign.y - dy }; 
                    pCuspMinute = { x: pCuspSign.x + dx, y: pCuspSign.y + dy }; 
                } else { 
                    pCuspDegree = { x: pCuspSign.x + dx, y: pCuspSign.y + dy }; 
                    pCuspMinute = { x: pCuspSign.x - dx, y: pCuspSign.y - dy }; 
                } 
                const cuspDegreeEl = createSvgElement('text', { x: pCuspDegree.x, y: pCuspDegree.y, class: 'cusp-degree', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); 
                cuspDegreeEl.textContent = degreeInfo.deg + 'Â°'; 
                svg.appendChild(cuspDegreeEl); 
                const cuspMinuteEl = createSvgElement('text', { x: pCuspMinute.x, y: pCuspMinute.y, class: 'cusp-minute', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); 
                cuspMinuteEl.textContent = minStr + "'"; 
                svg.appendChild(cuspMinuteEl); 
                
                if (signImageUrl) { 
                    const cuspSignEl = createSvgElement('image', { href: signImageUrl, x: pCuspSign.x - (CUSP_SIGN_SYMBOL_SIZE/2), y: pCuspSign.y - (CUSP_SIGN_SYMBOL_SIZE/2), width: CUSP_SIGN_SYMBOL_SIZE, height: CUSP_SIGN_SYMBOL_SIZE }); 
                    svg.appendChild(cuspSignEl); 
                }
            } 
            return hBounds; 
        }

       // --- SÄ°NASTRÄ° YÃ–NETÄ°CÄ°SÄ° (GÃœNCELLENMÄ°Åž: Ä°Ã‡/DIÅž Ã–ZEL HESAPLAMA) ---
function drawDualWheelPlanets() {
    let hBounds = [];
    if (chartData.houses) {
        for (let i = 1; i <= 12; i++) {
            let s = chartData.houses['CUSP' + i];
            let e = chartData.houses['CUSP' + (i % 12 + 1)];
            if (s !== undefined) hBounds.push({ id: i, start: s, end: e });
        }
    }

    let innerDensity = {}; 
    let outerDensity = {}; 
    for(let i=1; i<=12; i++) { innerDensity[i] = 0; outerDensity[i] = 0; }

    const targetInner = chartData.chart1 ? chartData.chart1.planets : chartData.planets;
    const targetOuter = chartData.chart2 ? chartData.chart2.planets : {};

    // 1. Ä°Ã‡ HARÄ°TA YOÄžUNLUK HESABI
    for (const [name, pData] of Object.entries(targetInner)) {
         if (visibilitySettings.hidden.includes(name)) continue;
         let deg = pData[0];
         for(let h=0; h<hBounds.length; h++) {
             let hb = hBounds[h];
             let isHere = false;
             if(hb.start < hb.end) { if(deg >= hb.start && deg < hb.end) isHere = true; }
             else { if(deg >= hb.start || deg < hb.end) isHere = true; }
             if(isHere) { innerDensity[hb.id]++; break; }
         }
    }

    // 2. DIÅž HARÄ°TA YOÄžUNLUK HESABI
    for (const [name, pData] of Object.entries(targetOuter)) {
         if (visibilitySettings.hidden.includes(name)) continue;
         let deg = pData[0];
         for(let h=0; h<hBounds.length; h++) {
             let hb = hBounds[h];
             let isHere = false;
             if(hb.start < hb.end) { if(deg >= hb.start && deg < hb.end) isHere = true; }
             else { if(deg >= hb.start || deg < hb.end) isHere = true; }
             if(isHere) { outerDensity[hb.id]++; break; }
         }
    }

    houseOverflowMap = {};
    const OUTER_CIRCUMFERENCE = 2 * Math.PI * 290;
    const INNER_CIRCUMFERENCE = 2 * Math.PI * 160;
    
    // --- YENÄ° OPTÄ°MÄ°ZE EDÄ°LMÄ°Åž PAYLAR ---
    // DÄ±ÅŸ Ã§ark (R=290) iÃ§in 45px, Ä°Ã§ Ã§ark (R=160) iÃ§in 35px ideal boÅŸluk saÄŸlar
    const PIXEL_PER_PLANET_OUTER = 45; 
    const PIXEL_PER_PLANET_INNER = 35; 

    const DEG_PER_PLANET_OUTER = (PIXEL_PER_PLANET_OUTER / OUTER_CIRCUMFERENCE) * 360; 
    const DEG_PER_PLANET_INNER = (PIXEL_PER_PLANET_INNER / INNER_CIRCUMFERENCE) * 360; 
    
    const MIN_HOUSE_DEG = 3.0;

    for(let i=1; i<=12; i++) {
        let bounds = hBounds[i-1];
        let houseWidth = (bounds.end - bounds.start + 360) % 360;
        let minWidthReq = houseWidth < MIN_HOUSE_DEG ? MIN_HOUSE_DEG - houseWidth : 0;
        
        // Ä°Ã§ ve dÄ±ÅŸ iÃ§in ayrÄ± gereken alanlar
        let innerRequired = innerDensity[i] * DEG_PER_PLANET_INNER;
        let outerRequired = outerDensity[i] * DEG_PER_PLANET_OUTER;
        
        // Hangi Ã§arkÄ±n gezegenleri o evde daha Ã§ok yer istiyorsa evi o kadar esnet
        let maxRequired = Math.max(innerRequired, outerRequired);
        
        let planetOverflow = 0;
        if (maxRequired > houseWidth) {
            planetOverflow = maxRequired - houseWidth + 1.5; 
        }
        houseOverflowMap[i] = Math.max(minWidthReq, planetOverflow);
    }

    drawHouses(hBounds);
    
    svg.appendChild(createSvgElement('circle', { 
        cx: cx, cy: cy, r: 175, fill: 'none', stroke: '#334155', 'stroke-width': '1', class: 'chart-line' 
    }));
    
    const prepareList = (data, isOuter, stars) => {
        const list = [];
        for (const [name, pData] of Object.entries(data)) {
            if (visibilitySettings.hidden.includes(name)) continue;
            list.push({ name, degree: pData[0], data: pData, isOuter });
        }
        for (const [name, sData] of Object.entries(stars)) {
            if (visibilitySettings.visible_stars.includes(name) || (ALWAYS_VISIBLE_STARS.includes(name) && !visibilitySettings.hidden.includes(name))) {
                list.push({ name, degree: sData[0], data: sData, isOuter, type: 'star' });
            }
        }
        return list;
    };

    const innerStars = (chartData.chart1 && chartData.chart1.fixed_stars) ? chartData.chart1.fixed_stars : (chartData.fixed_stars || {});
    drawSynastryRingDetailed(prepareList(targetInner, false, innerStars), false);

    if (Object.keys(targetOuter).length > 0) {
        const outerStars = (chartData.chart2 && chartData.chart2.fixed_stars) ? chartData.chart2.fixed_stars : {};
        drawSynastryRingDetailed(prepareList(targetOuter, true, outerStars), true);
    }
}

// --- DETAYLI SÄ°NASTRÄ° HALKA Ã‡Ä°ZÄ°MÄ° (ORÄ°JÄ°NAL STÄ°L KORUNDU) ---
function drawSynastryRingDetailed(planets, isOuter) {
    const R_BASE = isOuter ? 290 : 160;

    // 1. Evlere gÃ¶re gruplama ve yatay daÄŸÄ±tÄ±m (Senin orijinal mantÄ±ÄŸÄ±n)
    let hBounds = [];
    if (chartData.houses) {
        for (let i = 1; i <= 12; i++) {
            let s = chartData.houses['CUSP' + i];
            let e = chartData.houses['CUSP' + (i % 12 + 1)];
            if (s !== undefined) hBounds.push({ id: i, start: s, end: e });
        }
    }

    let planetsByHouse = {};
    for (let i = 1; i <= 12; i++) planetsByHouse[i] = [];

    planets.forEach(p => {
        for (let h = 0; h < hBounds.length; h++) {
            let hb = hBounds[h];
            let isHere = (hb.start < hb.end) ? (p.degree >= hb.start && p.degree < hb.end) : (p.degree >= hb.start || p.degree < hb.end);
            if (isHere) {
                planetsByHouse[hb.id].push({ ...p, visualDeg: p.degree, realDeg: p.degree });
                break;
            }
        }
    });

    for (let i = 1; i <= 12; i++) {
        let housePlanets = planetsByHouse[i];
        if (housePlanets.length === 0) continue;
        let bounds = hBounds[i - 1];
        let overflow = houseOverflowMap[i] || 0;
        let visualStart = (bounds.start - overflow + 360) % 360;
        let totalVisualWidth = ((bounds.end - bounds.start + 360) % 360) + overflow;
        housePlanets.sort((a, b) => a.realDeg - b.realDeg);
        let padding = 8.0;
        let step = (totalVisualWidth - (2 * padding)) / (housePlanets.length > 1 ? housePlanets.length - 1 : 1);
        if (housePlanets.length === 1) {
            housePlanets[0].visualDeg = (visualStart + totalVisualWidth / 2) % 360;
        } else {
            housePlanets.forEach((p, idx) => { p.visualDeg = (visualStart + padding + (idx * step)) % 360; });
        }
    }

    const adjustedPlanets = [];
    for (let i = 1; i <= 12; i++) adjustedPlanets.push(...planetsByHouse[i]);

    const group = createSvgElement('g', { class: isOuter ? 'outer-synastry-ring' : 'inner-synastry-ring' });
    svg.appendChild(group);

    adjustedPlanets.forEach((p) => {
        const originalData = p.data;
        const realDeg = p.degree;
        const visualDeg = p.visualDeg;

        // --- KRÄ°TÄ°K TAÅžMA DÃœZELTMESÄ° ---
        let rawOffset = 0;
        if (Array.isArray(originalData) && typeof originalData[originalData.length - 1] === 'number') {
            rawOffset = originalData[originalData.length - 1];
        }
        
        // EÄŸer dÄ±ÅŸ haritadaysak, offset sadece negatif (iÃ§eri) olabilir.
        // EÄŸer iÃ§ haritadaysak, offset sadece negatif (merkeze doÄŸru) olabilir.
        // Bu satÄ±r gezegenin Ã§ember dÄ±ÅŸÄ±na taÅŸmasÄ±nÄ± imkansÄ±z hale getirir.
        let safeOffset = -Math.abs(rawOffset); 

        const MY_R = R_BASE + safeOffset;
        const R_PLANET = MY_R;
        const R_DEGREE = MY_R - 30; // Orijinal aralÄ±klarÄ±n
        const R_SIGN   = MY_R - 55;
        const R_MINUTE = MY_R - 80;
        const R_RETRO  = MY_R - 105;

        // KÄ±lavuz Ã‡izgisi
        if (Math.abs(getAngleDiff(visualDeg, realDeg)) > 3.0) {
            let guideStart = isOuter ? R_BASE - 20 : R_BASE + 20;
            const pReal = getCoords(guideStart, realDeg);
            const pVis = getCoords(R_PLANET, visualDeg);
            group.appendChild(createSvgElement('line', {
                x1: pReal.x, y1: pReal.y, x2: pVis.x, y2: pVis.y,
                class: 'guideline'
            }));
        }

        const planetGroup = createSvgElement('g', { class: 'planet-group', style: 'cursor:pointer' });
        planetGroup.onclick = (e) => {
            e.stopPropagation();
            const degInfo = getRelativeDegreeJS(realDeg);
            showChartTooltip(e, p.name, degInfo.deg + 'Â°', degInfo.signName, degInfo.min + "'");
        };
        group.appendChild(planetGroup);

        // Gezegen Ä°konu (Orijinal 20px)
        const coordP = getCoords(R_PLANET, visualDeg);
        if (PLANET_IMAGE_MAP[p.name]) {
            planetGroup.appendChild(createSvgElement('image', {
                href: PLANET_IMAGE_MAP[p.name],
                x: coordP.x - 10, y: coordP.y - 10, width: 20, height: 20
            }));
        }

        const degInfo = getRelativeDegreeJS(realDeg);
        
        // Derece (Orijinal stil)
        const coordD = getCoords(R_DEGREE, visualDeg);
        const dTxt = createSvgElement('text', {
            x: coordD.x, y: coordD.y, class: 'planet-degree', 'text-anchor': 'middle', 'dominant-baseline': 'middle'
        });
        dTxt.textContent = degInfo.deg + 'Â°';
        planetGroup.appendChild(dTxt);

        // BurÃ§ Ä°konu (Orijinal 16px)
        const coordS = getCoords(R_SIGN, visualDeg);
        if (ZODIAC_IMAGE_MAP[degInfo.signName]) {
            planetGroup.appendChild(createSvgElement('image', {
                href: ZODIAC_IMAGE_MAP[degInfo.signName],
                x: coordS.x - 8, y: coordS.y - 8, width: 16, height: 16
            }));
        }

        // Dakika
        const coordM = getCoords(R_MINUTE, visualDeg);
        const mTxt = createSvgElement('text', {
            x: coordM.x, y: coordM.y, class: 'planet-minute', 'text-anchor': 'middle', 'dominant-baseline': 'middle'
        });
        mTxt.textContent = (degInfo.min < 10 ? '0' + degInfo.min : degInfo.min) + "'";
        planetGroup.appendChild(mTxt);

        // Retro
        if (originalData[5] === 'R') {
            const coordR = getCoords(R_RETRO, visualDeg);
            const rTxt = createSvgElement('text', {
                x: coordR.x, y: coordR.y, class: 'planet-retrograde', 'text-anchor': 'middle', 'dominant-baseline': 'middle'
            });
            rTxt.textContent = 'R';
            planetGroup.appendChild(rTxt);
        }
    });
}

        // --- ANA Ã‡Ä°ZÄ°M BAÅžLATICI ---
        function drawAllPlanets() {
            const checkSynastry = !!(chartData.chart1 && chartData.chart2);
            if (checkSynastry) { 
                drawDualWheelPlanets(); 
            } else { 
                drawSingleChartPlanets(); 
            } 
        }
        
        // --- MEVCUT TEKLÄ° HARÄ°TA FONKSÄ°YONLARI ---
        function drawSingleChartPlanets() { const planets = chartData.planets; const stars = chartData.fixed_stars || {}; let hBounds = []; for(let i=1; i<=12; i++) { let s = chartData.houses['CUSP'+i]; let e = chartData.houses['CUSP'+(i%12+1)]; if(s!==undefined) hBounds.push({id:i, start:s, end:e}); } let planetsByHouse = {}; for(let i=1; i<=12; i++) planetsByHouse[i] = []; for (const name of Object.keys(planets)) { if (visibilitySettings.hidden.includes(name)) continue; const p_data = planets[name]; if (!PLANET_IMAGE_MAP[name]) continue; const houseNumber = parseInt(p_data[6], 10); planetsByHouse[houseNumber].push({ name, p_data, visualDeg: p_data[0], realDeg: p_data[0], type: 'planet', houseNum: houseNumber }); } for (const name of Object.keys(stars)) { let shouldDraw = false; if (visibilitySettings.visible_stars.includes(name)) { shouldDraw = true; } else if (ALWAYS_VISIBLE_STARS.includes(name) && !visibilitySettings.hidden.includes(name)) { shouldDraw = true; } if (shouldDraw) { const s_data = stars[name]; const houseNumber = parseInt(s_data[6], 10); planetsByHouse[houseNumber].push({ name, p_data: s_data, visualDeg: s_data[0], realDeg: s_data[0], type: 'star', houseNum: houseNumber }); } } calculateHouseOverflows(planetsByHouse, hBounds); drawHouses(hBounds); const planetsGroup = createSvgElement('g', { id: 'planets-group' }); svg.appendChild(planetsGroup); for (let i = 1; i <= 12; i++) { let housePlanets = planetsByHouse[i]; if (housePlanets.length === 0) continue; let bounds = hBounds[i-1]; let overflow = houseOverflowMap[i] || 0; let visualStart = (bounds.start - overflow + 360) % 360; let totalVisualWidth = ((bounds.end - bounds.start + 360) % 360) + overflow; housePlanets.sort((a, b) => a.realDeg - b.realDeg); let padding = 5.0; let step = (totalVisualWidth - (2 * padding)) / (housePlanets.length > 1 ? housePlanets.length - 1 : 1); if (housePlanets.length === 1) { housePlanets[0].visualDeg = (visualStart + totalVisualWidth / 2) % 360; } else { housePlanets.forEach((p, idx) => { p.visualDeg = (visualStart + padding + (idx * step)) % 360; }); } housePlanets.forEach(p => drawSinglePlanetDetailed(p, planetsGroup, R_PLANETS_AVG, false)); } }
        function drawSinglePlanetDetailed(item, container, radius, forceGuideline) { const { name, p_data, visualDeg, realDeg, type } = item; const rx = p_data[5]; const signName = p_data[3]; const signImageUrl = ZODIAC_IMAGE_MAP[signName]; const planetGroup = createSvgElement('g', { class: 'planet-group', style: 'cursor: pointer;' }); planetGroup.onclick = function(e) { e.stopPropagation(); let degStr = '0Â°'; let minStr = "00'"; const degText = p_data[4]; if (degText && degText.includes('Â°')) { const parts = degText.split('Â°'); degStr = parts[0].trim() + 'Â°'; if (parts.length > 1 && parts[1].trim()) minStr = parts[1].trim(); } showChartTooltip(e, name, degStr, signName, minStr); }; container.appendChild(planetGroup); const pImage = getCoords(radius, visualDeg); if (Math.abs(getAngleDiff(visualDeg, realDeg)) > 3.0) { const pReal = getCoords(R_INNER_RING, realDeg); const pVis = getCoords(radius, visualDeg); const line = createSvgElement('line', { x1: pReal.x, y1: pReal.y, x2: pVis.x, y2: pVis.y, class: 'guideline' }); container.insertBefore(line, container.firstChild); } if (type === 'planet' && PLANET_IMAGE_MAP[name]) { const imageUrl = PLANET_IMAGE_MAP[name]; const imageEl = createSvgElement('image', { href: imageUrl, x: pImage.x - (SYMBOL_SIZE/2), y: pImage.y - (SYMBOL_SIZE/2), width: SYMBOL_SIZE, height: SYMBOL_SIZE }); planetGroup.appendChild(imageEl); } else if (type === 'star') { const starText = createSvgElement('text', { x: pImage.x, y: pImage.y, 'text-anchor': 'middle', 'dominant-baseline': 'middle', 'font-size': '10px', 'fill': '#e67e22', 'font-weight': 'bold' }); starText.textContent = '*'; planetGroup.appendChild(starText); } const degText = p_data[4]; let degStr = '0Â°'; let minStr = "00'"; if (degText && degText.includes('Â°')) { const parts = degText.split('Â°'); degStr = parts[0].trim() + 'Â°'; if (parts.length > 1 && parts[1].trim()) { minStr = parts[1].trim(); if (!minStr.includes("'")) minStr += "'"; } } const pDegree = getCoords(R_PLANET_DEGREES, visualDeg); const degreeEl = createSvgElement('text', { x: pDegree.x, y: pDegree.y, class: 'planet-degree', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); degreeEl.textContent = degStr; planetGroup.appendChild(degreeEl); if (signImageUrl) { const pSign = getCoords(R_PLANET_SIGN, visualDeg); const signImageEl = createSvgElement('image', { href: signImageUrl, x: pSign.x - (PLANET_SIGN_SYMBOL_SIZE/2), y: pSign.y - (PLANET_SIGN_SYMBOL_SIZE/2), width: PLANET_SIGN_SYMBOL_SIZE, height: PLANET_SIGN_SYMBOL_SIZE }); svg.appendChild(signImageEl); } const pMinute = getCoords(R_PLANET_MINUTE, visualDeg); const minuteEl = createSvgElement('text', { x: pMinute.x, y: pMinute.y, class: 'planet-minute', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); minuteEl.textContent = minStr; planetGroup.appendChild(minuteEl); if (rx) { const pRetro = getCoords(R_PLANET_RETRO, visualDeg); const retroEl = createSvgElement('text', { x: pRetro.x, y: pRetro.y, class: 'planet-retrograde', 'text-anchor': 'middle', 'dominant-baseline': 'middle' }); retroEl.textContent = rx; planetGroup.appendChild(retroEl); } }

        if (chartData) { drawZodiac(); drawAllPlanets(); }
    {% endif %}
    
    // SÄ°NASTRÄ° HARÄ°TALARINI DEÄžÄ°ÅžTÄ°R (SAYFA YENÄ°LEYEREK)
    function swapSynastryCharts() {
        console.log('ðŸ”„ Swap baÅŸlatÄ±ldÄ±...');
        
        fetch('/api/swap_synastry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => {
            console.log('ðŸ“¡ API yanÄ±tÄ± alÄ±ndÄ±:', r.status);
            return r.json();
        })
        .then(data => {
            console.log('ðŸ“¦ Veri:', data);
            
            if(data.success) {
                console.log('âœ… Swap baÅŸarÄ±lÄ±, sayfa yenileniyor...');
                // Basit ve garantili Ã§Ã¶zÃ¼m: SayfayÄ± yenile
                location.reload();
            } else {
                console.error('âŒ Swap hatasÄ±:', data.error);
                alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(err => {
            console.error('âŒ BaÄŸlantÄ± hatasÄ±:', err);
            alert('BaÄŸlantÄ± hatasÄ±: ' + err.message);
        });
    }

    function prepareSelectionData() {
    if (typeof chartData === 'undefined') return;
    
    // TÃ¼m listeleri temizle
    selectionData.planets.visible = [];
    selectionData.planets.hidden = [];
    selectionData.asteroids.visible = [];
    selectionData.asteroids.hidden = [];
    selectionData.angles.visible = [];
    selectionData.angles.hidden = [];
    selectionData.fixedstars.visible = [];
    selectionData.fixedstars.hidden = [];
    
    // Sinastri kontrolÃ¼: chart1 ve chart2 varsa, chart1'den al
    const planetsSource = (chartData.chart1 && chartData.chart1.planets) ? chartData.chart1.planets : chartData.planets;
    const starsSource = (chartData.chart1 && chartData.chart1.fixed_stars) ? chartData.chart1.fixed_stars : chartData.fixed_stars;
    
    // Gezegen ve asteroidleri ekle (kÃ¶ÅŸe noktalarÄ±nÄ± ATLAYARAK)
    for (let pName in planetsSource) {
        // KÃ¶ÅŸe noktalarÄ±nÄ± atla - bunlar ayrÄ± iÅŸlenecek
        if (ANGLE_POINTS.includes(pName)) continue;
        
        let targetGroup = 'planets';
        if (ASTEROID_CATEGORY.includes(pName)) {
            targetGroup = 'asteroids';
        }
        if (visibilitySettings.hidden.includes(pName)) {
            selectionData[targetGroup].hidden.push({name: pName});
        } else {
            selectionData[targetGroup].visible.push({name: pName});
        }
    }
    
    if (starsSource) {
        for (let sName in starsSource) {
            let sData = starsSource[sName];
            let signName = sData[3];
            if (signName === "YÄ±lancÄ±" || signName === "Ophiuchus") signName = "Akrep";
            let item = {name: sName, category: signName};
            let isVisible = false;
            if (visibilitySettings.visible_stars.includes(sName)) {
                isVisible = true;
            } else if (ALWAYS_VISIBLE_STARS.includes(sName) && !visibilitySettings.hidden.includes(sName)) {
                isVisible = true;
            }
            if (isVisible) {
                selectionData.fixedstars.visible.push(item);
            } else {
                selectionData.fixedstars.hidden.push(item);
            }
        }
    }
    
    // KÃ¶ÅŸe noktalarÄ± iÃ§in
    ANGLE_POINTS.forEach(angleName => {
        if (visibilitySettings.hidden.includes(angleName)) {
            selectionData.angles.hidden.push({name: angleName});
        } else {
            selectionData.angles.visible.push({name: angleName});
        }
    });
}

// Bu fonksiyonu en sona ekle, drawChart'Ä± bulmasÄ±na gerek kalmaz
(function() {
    const checkAndRender = () => {
        const svg = document.getElementById('astroChart');
        // Flask'tan gelen veriyi gÃ¼venli alalÄ±m
        const data = {{ last_chart | tojson | safe if last_chart else 'null' }};
        
        if (svg && data && data.cusps) {
            console.log("KÄ±stÄ±rÄ±lmÄ±ÅŸ burÃ§lar Ã§iziliyor...");
            window.renderInterceptedSigns(data.cusps, data.ascendant);
        } else {
            // Harita henÃ¼z oluÅŸmadÄ±ysa 500ms sonra tekrar dene
            setTimeout(checkAndRender, 500);
        }
    };
    checkAndRender();
})();
</script>

    {% include 'return_module.html' ignore missing %}
    {% include 'synastry_module.html' ignore missing %}
    {% include 'progression_module.html' ignore missing %}

</body>
</html>
