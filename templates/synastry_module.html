<style>
    /* =========================================
       1. MODAL ÇERÇEVESİ (GİZLİ KATMAN)
       ========================================= */
    #synastryModal {
        display: none; 
        align-items: center; 
        justify-content: center; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        z-index: 9999;
        /* Arka plan karartması */
        background: rgba(145, 145, 145, 0.13) !important;
        backdrop-filter: blur(2px);
    }

    /* =========================================
       3. HEADER (BAŞLIK)
       ========================================= */
    .synastry-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        flex-shrink: 0; 
        padding: 15px; 
        
        background: rgba(0, 0, 0, 0.568) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2); 
        color: rgb(233, 233, 233); 
    }

    .synastry-header-title { 
        font-weight: 700; 
        font-size: 14px; 
        letter-spacing: 0.5px; 
    }
    
    .synastry-close-btn { 
        cursor: pointer; 
        font-size: 15px; 
        transition: 0.2s; 
    }
    .synastry-close-btn:hover { color: #f87171; }

    /* =========================================
       4. GÖVDE (BODY)
       ========================================= */
    .synastry-body {
        display: flex; 
        flex: 1; 
        padding: 15px; 
        gap: 15px; 
        overflow: hidden; 
    }

    /* --- SOL PANEL (LİSTE) --- */
    .syn-left-panel {
        flex: 1.8; 
        display: flex; 
        flex-direction: column; 
        border-right: 1px solid rgba(255, 255, 255, 0.2);   
        padding-right: 10px;
    }

    /* Liste Başlıkları */
    .syn-list-header {
        display: grid; 
        grid-template-columns: 2fr 1.3fr 0.9fr; 
        padding: 0 10px 5px 10px; 
        margin-bottom: 5px; 
        border-bottom: 1px solid rgba(255,255,255,0.1); 
        flex-shrink: 0;
        position: relative; /* Sayaç için referans */
    }

    .syn-col-header {
        font-size: 11px; /* 10px'ten 11px'e çıkarıldı */
        font-weight: 700; 
        color: rgba(255, 255, 255, 0.979) !important;
        
        /* İSTEDİĞİN GÖLGELER EKLENDİ */
        text-shadow: 
            0 0 1px rgba(0, 0, 0, 0.74), 
            0 0 5px rgba(8, 0, 0, 0.171), 
            0 0 15px rgba(255, 255, 255, 0.5), 
            0 0 30px rgba(255, 255, 255, 0.3);
    }

    /* Sayaç (Tasarımı silindi, sadece sağa hizalı yazı) */
    .syn-selection-count {
        position: absolute;
        right: 0; top: 0;
        font-size: 10px;
        color: #ddd;
        /* Background, border vb. tüm tasarımlar silindi */
    }

    /* Liste Kutusu */
    .synastry-list {
        flex: 1; 
        overflow-y: auto; 
        padding: 2px;
    }

    /* Scrollbar */
    .synastry-list::-webkit-scrollbar { width: 4px; }
    .synastry-list::-webkit-scrollbar-thumb { 
        background: rgba(255,255,255,0.2) !important;
        border-radius: 5px !important;
    }

    /* --- SAĞ PANEL (SEÇENEKLER) --- */
    .syn-right-panel {
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        gap: 15px;
    }

    /* =========================================
       5. LİSTE ÖĞELERİ (Sadece Bu Modal İçin)
       ========================================= */
    #synastryModal .chart-select-item {
        display: grid; 
        grid-template-columns: 2fr 1.3fr 0.9fr; 
        align-items: center; 
        padding: 12px 10px;
        margin-bottom: 4px; 
        font-size: 11px;
        
        /* Normal Görünüm */
        background: rgba(194, 253, 255, 0.404) !important; 
        backdrop-filter: blur(10px) !important; 
        -webkit-backdrop-filter: blur(10px) !important; 
        border: 1px solid rgba(255, 255, 255, 0.226) !important; 
        color: rgba(1, 13, 19, 0.87) !important;
        
        cursor: pointer; 
        transition: all 0.2s ease;
    }

    /* 1. HOVER DURUMU (Üzerine Gelince) */
    #synastryModal .chart-select-item:hover {
        background-color: rgba(7, 44, 68, 0.705) !important;
        border: 1px solid rgba(56, 189, 248, 0.5) !important;
        color: white !important;
        box-shadow: inset 3px 0 0 #38bdf8 !important;
    }
    
    /* 2. SEÇİLİ DURUMU (Tıklanınca) */
    /* Hem .selected sınıfı hem de içinde seçili input varsa çalışır */
    #synastryModal .chart-select-item.selected,
    #synastryModal .chart-select-item:has(input:checked) {
        background-color: rgba(7, 44, 68, 0.705) !important;
        border: 1px solid rgba(56, 189, 248, 0.5) !important;
        color: white !important;
        
        /* Sol tarafındaki mavi çizgi */
        box-shadow: inset 3px 0 0 #38bdf8 !important;
    }

    /* Seçili Durumda Metin Parlaması */
    #synastryModal .chart-select-item.selected .item-name,
    #synastryModal .chart-select-item:has(input:checked) .item-name {
        color: rgb(233, 233, 233) !important; 
        text-shadow: 0 0 2px rgba(255, 255, 255, 0.596);
    }

    /* =========================================
       6. SAĞ PANEL SEÇENEK KUTULARI
       ========================================= */
    .syn-options-box {
        /* Sağ Çapraz Alta Doğru Gradient (Geçiş) */
        /* Sol üstten (hafif açık) sağ alta (koyu) doğru akar */
        background: rgba(0, 0, 0, 0) !important;
        
        padding: 15px; 
        backdrop-filter: blur(5px);
    }

    .syn-options-label {
        font-size: 11px; font-weight: 800; color: #e7e7e7 !important;
        display: block; margin-bottom: 12px; padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.295);  
    }

    /* Radio Buton Kutuları */
    .calc-type-item {
        display: flex; align-items: center;
        padding: 10px; margin-bottom: 8px;
        
        background: rgba(184, 94, 25, 0.356) !important;
        backdrop-filter: blur(5px) !important;        
        -webkit-backdrop-filter: blur(5px) !important;
        border: 1px solid rgba(59, 29, 6, 0.123) !important;
        
        cursor: pointer; transition: 0.2s;
    }
    
    /* Hover ve Seçili (Turuncu) */
    .calc-type-item:hover, 
    .calc-type-item:has(input:checked) {
        background-color: rgba(180, 83, 9, 0.3) !important;
        border: 1px solid rgba(245, 158, 11, 0.5) !important;
        box-shadow: inset 1px 0 0 #f59e0b !important;
        color: white;
    }
    
    .calc-type-item input { display: none; }
    .calc-type-item span { font-size: 11px; color: #ddd; }
    
    /* Seçili Radyo Buton Metin Gölgesi EKLENDİ */
    .calc-type-item:has(input:checked) span {
        color: rgb(233, 233, 233) !important; 
        text-shadow: 0 0 2px rgba(255, 255, 255, 0.596);
    }
    /* =========================================
       8. HESAPLA BUTONU (GÜNCELLENEN YEŞİL)
       Yeşil Gradient Buton
       ========================================= */
    #btnSynCalc {
        width: 100%; 
        padding: 10px; 
        
        /* Pasif Hali (Disabled) */
        background: rgba(55, 59, 54, 0.658) !important;  
        color: rgba(184, 184, 184, 0.658) !important;  
        border: 1px solid rgba(92, 94, 92, 0.658) !important;   
        
        border-radius: 0px; 
        font-weight: 600; 
        cursor: not-allowed; 
        transition: all 0.3s ease; 
        font-size: 11px; 
        letter-spacing: 1px;
        text-transform: uppercase;
    }
    
    /* Aktif Hali (Enabled - YEŞİL) */
    #btnSynCalc:enabled {
        /* Canlı Yeşil Gradient */
        background: linear-gradient(135deg, #15803d 0%, #16a34a 100%) !important; 
        border: 1px solid #22c55e !important; 
        color: rgb(255, 255, 255) !important; 
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4);
    }

    #btnSynCalc:enabled:hover { 
        background: linear-gradient(135deg, #16a34a 0%, #4ade80 100%) !important;
        box-shadow: 0 6px 20px rgba(22, 163, 74, 0.6) !important; 
        transform: translateY(-1px);
        color: #ffffff !important; 
    }

    /* Scrollbar Tasarımı */
    .synastry-list::-webkit-scrollbar { width: 4px; }
    .synastry-list::-webkit-scrollbar-thumb { 
        background: rgba(255,255,255,0.2) !important;
        border-radius: 5px !important;
    }
    .synastry-list::-webkit-scrollbar-track { background: transparent; }

    /* Seçili olduğunda arka plan değişimi */
    .chart-select-item.selected {
        background-color: rgba(7, 44, 68, 0.705) !important;
        border: 1px solid rgba(56, 189, 248, 0.5) !important;
        box-shadow: inset 3px 0 0 #38bdf8 !important;
        color: white !important;
    }
</style>

<div id="synastryModal" class="modal-overlay">
    <div class="synastry-modal-box">
        
        <div class="synastry-header">
            <span class="synastry-header-title"><i class="fas fa-layer-group"></i> Karşılaştırmalı Analiz</span>
            <span class="synastry-close-btn" onclick="closeSynastryModal()">✕</span>
        </div>

        <div class="synastry-body">
            
            <div class="syn-left-panel">
    
    <div class="syn-list-header">
        <span class="syn-col-header">İSİM</span>
        <span class="syn-col-header">TARİH</span>
        <span class="syn-col-header">TİP</span>
        
        <span id="selectionCount" class="syn-selection-count" style="font-size:10px; color:#ddd; margin-left:auto;">0/2</span>
    </div>

    <div class="synastry-list">
    {% if active_charts %}
        {% for chart in active_charts %}
            
            {# --- FİLTRE GÜNCELLENDİ: İkili/Grup haritalarını gizle --- #}
            {% if chart.type not in ['synastry', 'synastri', 'event'] %}
            
            <div class="chart-select-item" onclick="toggleChartSelection(this, {{ loop.index0 }})">
                <input type="checkbox" value="{{ loop.index0 }}" style="display:none;" class="chart-checkbox">
                <div class="item-name">{{ chart.name }}</div>
                <div class="item-date">{{ chart.day }}.{{ chart.month }}.{{ chart.year }}</div>
                <div style="text-align:center;">
                    <span class="zodiac-badge">{{ chart.zodiac_type|truncate(4, True, '') }}</span>
                </div>
            </div>
            
            {% endif %} {# --- FİLTRE SONU --- #}

            {% endfor %}
        {% else %}
        <div style="padding:20px; text-align:center; color:#666; font-size:11px;">Aktif harita yok.</div>
    {% endif %}
    </div>
</div>

            <div class="syn-right-panel">
                <div class="syn-options-box">
                    <label class="syn-options-label">HESAPLAMA TÜRÜ</label>
                    
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        
                        <label class="calc-type-item">
                            <input type="radio" name="s_type" value="Sinastri" checked>
                            <span>Sinastri (Halkalı Görünüm)</span>
                        </label>

                        <label class="calc-type-item">
                            <input type="radio" name="s_type" value="Kompozit">
                            <span>Kompozit (Tek Harita)</span>
                        </label>

                    </div>
                </div>
                
                <div style="margin-top:auto;">
                    <button type="button" id="btnSynCalc" onclick="submitSynastry()" disabled>
                        HESAPLA & KAYDET
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let selectedIndices = [];
    const requiredChartCount = 2;

    const SYN_RADII = {
        OUTER: { ICON: 305, DEG: 293, SIGN: 280, MIN: 267, RETRO: 258 },
        INNER: { ICON: 240, DEG: 228, SIGN: 215, MIN: 202, RETRO: 193 },
        ZODIAC_BG: 350, DIVIDER: 255, HOUSES: 180
    };

    function openSynastryModal() { document.getElementById('synastryModal').style.display = 'flex'; }
    function closeSynastryModal() { document.getElementById('synastryModal').style.display = 'none'; selectedIndices = []; updateSynBtn(); resetSelectionUI(); }
    
    function resetSelectionUI() {
        document.querySelectorAll('#synastryModal .chart-select-item').forEach(div => {
            div.style.backgroundColor = 'transparent';
            const inp = div.querySelector('input'); if(inp) inp.checked = false;
        });
        document.getElementById('selectionCount').innerText = "0/2";
    }

    function toggleChartSelection(el, idx) { 
        const chk = el.querySelector('input'); 
        if(selectedIndices.includes(idx)) { 
            selectedIndices.splice(selectedIndices.indexOf(idx), 1);
            chk.checked = false; el.style.backgroundColor = 'transparent';
        } else { 
            if(selectedIndices.length < requiredChartCount) { 
                selectedIndices.push(idx); chk.checked = true; el.style.backgroundColor = '#2563eb1a';
            } else { alert("En fazla 2 harita seçebilirsiniz."); } 
        } 
        document.getElementById('selectionCount').innerText = selectedIndices.length + "/2";
        updateSynBtn(); 
    }
    
    function updateSynBtn() { 
        const btn = document.getElementById('btnSynCalc'); 
        const isReady = (selectedIndices.length === requiredChartCount);
        btn.disabled = !isReady;
        btn.style.background = isReady ? "#2563eb" : "#94a3b8";
        btn.style.cursor = isReady ? "pointer" : "not-allowed";
    }

    function submitSynastry() { 
        const id1 = selectedIndices[0];
        const id2 = selectedIndices[1];
        if (id1 === undefined || id2 === undefined) return;
        
        const calcType = document.querySelector('input[name="s_type"]:checked').value;
        const btn = document.getElementById('btnSynCalc');
        const oldText = btn.innerText;
        btn.innerText = "HESAPLANIYOR..."; btn.disabled = true;

        fetch('/api/get_synastry_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id1: id1, id2: id2, calc_type: calcType })
        })
        .then(r => r.json())
        .then(resp => {
            if(resp.success) {
                saveResultToSession(resp, calcType, btn, oldText);
            } else {
                alert("Hata: " + resp.error);
                btn.innerText = oldText; btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Bağlantı hatası.");
            btn.innerText = oldText; btn.disabled = false;
        });
    }

    function saveResultToSession(data, type, btn, oldText) {
        fetch('/api/register_synastry_session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                data: data, 
                type: type  
            })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                window.location.href = "/set_active_chart/" + res.new_index; 
            } else {
                alert("Kayıt hatası!");
                btn.innerText = oldText; btn.disabled = false;
            }
        });
    }

    // Not: Çizim işlemleri layout.html'de yapılıyor (tekrarlama önlendi)
</script>
