<div id="synastryModal" class="modal-overlay" style="display:none; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div class="synastry-modal-box" style="width: 900px; height: 580px; max-width: 95%; display:flex; flex-direction:column; background:white; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2); font-family: 'Segoe UI', sans-serif;">
        
        <div class="synastry-header" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); padding:12px 15px; color:white; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:700; font-size:13px; letter-spacing:0.5px;"><i class="fas fa-layer-group"></i> Karşılaştırmalı Analiz</span>
            <span style="cursor:pointer; font-size:16px;" onclick="closeSynastryModal()">✕</span>
        </div>

        <div class="synastry-body" style="display:flex; flex:1; padding:15px; gap:15px; overflow:hidden;">
            
            <div style="flex:1.8; display:flex; flex-direction:column; border-right:1px solid #eee; padding-right:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 id="chartSelectionTitle" style="font-size:11px; color:#1565c0; margin:0; font-weight:800; text-transform:uppercase;">2 HARİTA SEÇİN</h4>
                    <span id="selectionCount" style="font-size:10px; background:#eff6ff; color:#1e40af; padding:3px 8px; border-radius:10px; font-weight:bold; border:1px solid #dbeafe;">0/2</span>
                </div>
                
                <div style="display:grid; grid-template-columns: 30px 2fr 1.3fr 0.9fr; padding:0 8px 5px 8px; border-bottom:1px solid #eee; margin-bottom:5px; padding-right: 22px;">
                    <span></span> 
                    <span style="font-size:9px; font-weight:bold; color:#999;">İSİM</span>
                    <span style="font-size:9px; font-weight:bold; color:#999; text-align:center;">TARİH</span>
                    <span style="font-size:9px; font-weight:bold; color:#999; text-align:center;">TİP</span>
                </div>

                <div class="synastry-list" style="flex:1; overflow-y:auto; border:1px solid #cce0f5; background-color: #f8fbff; border-radius:4px; padding:2px;">
                    {% if active_charts %}
                        {% for chart in active_charts %}
                            {% if chart.type == 'natal' or chart.type == 'transit' %}
                            <div class="chart-select-item" 
                                 onclick="toggleChartSelection(this, {{ loop.index0 }})" 
                                 style="display:grid; grid-template-columns: 30px 2fr 1.3fr 0.9fr; align-items:center; padding:8px 8px; margin-bottom:2px; border-bottom:1px solid rgba(0,0,0,0.03); cursor:pointer; transition:0.1s;">
                                
                                <div style="display:flex; justify-content:center;">
                                    <input type="checkbox" value="{{ loop.index0 }}" style="pointer-events:none;">
                                </div>
                                <div style="font-weight:700; font-size:11px; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:5px;">
                                    {{ chart.name }}
                                </div>
                                <div style="font-size:10px; color:#666; text-align:center;">
                                    {{ chart.day }}.{{ chart.month }}.{{ chart.year }}
                                </div>
                                <div style="text-align:center;">
                                    <span class="zodiac-badge" style="font-size:9px; background:#fff; border:1px solid #bfdbfe; color:#1e40af; padding:0px 4px; border-radius:3px; font-weight:600; display:inline-block;">
                                        {{ chart.zodiac_type|truncate(4, True, '') }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div style="padding:20px; text-align:center; color:#777; font-size:11px;">Aktif harita yok.</div>
                    {% endif %}
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; gap:15px;">
                <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #e2e8f0;">
                    <label style="font-size:11px; font-weight:800; color:#475569; display:block; margin-bottom:10px; border-bottom:1px solid #e2e8f0; padding-bottom:5px;">HESAPLAMA TÜRÜ</label>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; padding:5px;">
                            <input type="radio" name="s_type" value="Sinastri" checked> <span style="color:#333;">Sinastri (Halkalı Görünüm)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; padding:5px;">
                            <input type="radio" name="s_type" value="Kompozit"> <span style="color:#333;">Kompozit (Tek Harita)</span>
                        </label>
                    </div>
                </div>
                <div style="margin-top:auto;">
                    <button type="button" id="btnSynCalc" onclick="submitSynastry()" disabled 
                            style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:4px; font-weight:bold; cursor:not-allowed; box-shadow:none; transition:0.3s; font-size:12px; letter-spacing:0.5px;">
                        HESAPLA & KAYDET
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedIndices = [];
    const requiredChartCount = 2;

    const SYN_RADII = {
        OUTER: { ICON: 305, DEG: 293, SIGN: 280, MIN: 267, RETRO: 258 },
        INNER: { ICON: 240, DEG: 228, SIGN: 215, MIN: 202, RETRO: 193 },
        ZODIAC_BG: 350, DIVIDER: 255, HOUSES: 180
    };

    function openSynastryModal() { document.getElementById('synastryModal').style.display = 'flex'; }
    function closeSynastryModal() { document.getElementById('synastryModal').style.display = 'none'; selectedIndices = []; updateSynBtn(); resetSelectionUI(); }
    
    function resetSelectionUI() {
        document.querySelectorAll('#synastryModal .chart-select-item').forEach(div => {
            div.style.backgroundColor = 'transparent';
            const inp = div.querySelector('input'); if(inp) inp.checked = false;
        });
        document.getElementById('selectionCount').innerText = "0/2";
    }

    function toggleChartSelection(el, idx) { 
        const chk = el.querySelector('input'); 
        if(selectedIndices.includes(idx)) { 
            selectedIndices.splice(selectedIndices.indexOf(idx), 1);
            chk.checked = false; el.style.backgroundColor = 'transparent';
        } else { 
            if(selectedIndices.length < requiredChartCount) { 
                selectedIndices.push(idx); chk.checked = true; el.style.backgroundColor = '#2563eb1a';
            } else { alert("En fazla 2 harita seçebilirsiniz."); } 
        } 
        document.getElementById('selectionCount').innerText = selectedIndices.length + "/2";
        updateSynBtn(); 
    }
    
    function updateSynBtn() { 
        const btn = document.getElementById('btnSynCalc'); 
        const isReady = (selectedIndices.length === requiredChartCount);
        btn.disabled = !isReady;
        btn.style.background = isReady ? "#2563eb" : "#94a3b8";
        btn.style.cursor = isReady ? "pointer" : "not-allowed";
    }

    function submitSynastry() { 
        const id1 = selectedIndices[0];
        const id2 = selectedIndices[1];
        if (id1 === undefined || id2 === undefined) return;
        
        const calcType = document.querySelector('input[name="s_type"]:checked').value;
        const btn = document.getElementById('btnSynCalc');
        const oldText = btn.innerText;
        btn.innerText = "HESAPLANIYOR..."; btn.disabled = true;

        fetch('/api/get_synastry_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id1: id1, id2: id2, calc_type: calcType })
        })
        .then(r => r.json())
        .then(resp => {
            if(resp.success) {
                saveResultToSession(resp, calcType, btn, oldText);
            } else {
                alert("Hata: " + resp.error);
                btn.innerText = oldText; btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Bağlantı hatası.");
            btn.innerText = oldText; btn.disabled = false;
        });
    }

    function saveResultToSession(data, type, btn, oldText) {
        fetch('/api/register_synastry_session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                data: data, 
                type: type  
            })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                window.location.href = "/set_active_chart/" + res.new_index; 
            } else {
                alert("Kayıt hatası!");
                btn.innerText = oldText; btn.disabled = false;
            }
        });
    }

    // Not: Çizim işlemleri layout.html'de yapılıyor (tekrarlama önlendi)
</script>
