<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli - AstroFire</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- GENEL STİL --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #ffffff; margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .main-header { height: 60px; flex: 0 0 60px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .logo-container { display: flex; align-items: center; }
        .logo-icon { font-size: 24px; color: #1565c0; margin-right: 10px; }
        .logo-title { line-height: 1; font-weight: 800; color: #1565c0; font-size: 20px; letter-spacing: 0.5px; }
        .logo-subtitle { font-family: 'Garamond', serif; font-size: 12px; color: #555; letter-spacing: 1px; }
        
        /* TAB MENÜSÜ */
        .admin-nav { display: flex; height: 100%; }
        .nav-tab { 
            margin-left: 25px; cursor: pointer; color: #556677; font-size: 13px; font-weight: 600; 
            height: 100%; display: flex; align-items: center; border-bottom: 3px solid transparent; 
            text-transform: uppercase; transition: all 0.2s;
        }
        .nav-tab:hover { color: #1565c0; }
        .nav-tab.active { color: #1565c0; border-bottom-color: #1565c0; }
        
        /* İÇERİK ALANI */
        .admin-content { flex: 1; padding: 30px; overflow-y: auto; background-color: #f8f9fa; display: flex; justify-content: center; }
        .content-section { display: none; width: 100%; max-width: 1000px; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KART TASARIMI */
        .admin-card { background: #fff; border: 1px solid #e1e8ed; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .card-title { font-size: 16px; font-weight: 700; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .card-title i { color: #f39c12; }

        /* FORM ELEMANLARI */
        .admin-form input, .admin-form textarea, .admin-form select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #dfe6e9; border-radius: 6px; font-size: 13px; font-family: inherit; background-color: #fcfcfc; }
        .admin-form input:focus, .admin-form textarea:focus { border-color: #3498db; outline: none; background-color: #fff; }
        
        /* BUTONLAR */
        .btn-primary { background: #1565c0; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-primary:hover { background: #0d47a1; }
        
        .btn-danger { background: #fff; color: #e74c3c; border: 1px solid #e74c3c; padding: 4px 10px; border-radius: 4px; font-size: 11px; text-decoration: none; font-weight: bold; cursor: pointer; }
        .btn-danger:hover { background: #e74c3c; color: white; }
        
        .btn-edit { background: #fff; color: #f39c12; border: 1px solid #f39c12; padding: 4px 10px; border-radius: 4px; font-size: 11px; text-decoration: none; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .btn-edit:hover { background: #f39c12; color: white; }

        .btn-search { background: #27ae60; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer; font-weight: bold; height: 38px; font-size: 12px; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .btn-search:hover { background: #219150; }

        /* TABLOLAR */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #7f8c8d; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #f5f5f5; color: #2c3e50; }
        tr:hover td { background-color: #fcfcfc; }
        
        .btn-logout { color: #e74c3c; text-decoration: none; font-weight: bold; font-size: 13px; border: 1px solid #e74c3c; padding: 6px 15px; border-radius: 20px; transition: 0.2s; }
        .btn-logout:hover { background: #e74c3c; color: white; }

        /* --- MODAL STİLİ --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .location-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        .location-item:hover { background-color: #e3f2fd; }
        .badge-tz { background: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
        .close-btn { margin-top:15px; width:100%; padding:10px; background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
        .close-modal-icon { position: absolute; top: 15px; right: 20px; font-size: 20px; cursor: pointer; color: #999; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <i class="fas fa-user-shield logo-icon"></i>
            <div class="logo-text-wrapper">
                <span class="logo-title">YÖNETİCİ PANELİ</span>
                <span class="logo-subtitle">AstroFire Web</span>
            </div>
        </div>
        
        <nav class="admin-nav">
            <div class="nav-tab active" onclick="showSection('data')">DATA (Haritalar)</div>
            <div class="nav-tab" onclick="showSection('egitimler')">EĞİTİMLER</div>
            <div class="nav-tab" onclick="showSection('iletisim')">İLETİŞİM</div>
            <div class="nav-tab" onclick="showSection('kullanicilar')">KULLANICILAR</div>
        </nav>
        
        <div>
            <a href="{{ url_for('home') }}" style="margin-right: 15px; text-decoration: none; color: #1565c0; font-weight: bold; font-size: 13px;">Siteye Dön <i class="fas fa-external-link-alt"></i></a>
            <a href="{{ url_for('admin_logout') }}" class="btn-logout">Çıkış Yap</a>
        </div>
    </header>

    <div class="admin-content">

        <div id="data" class="content-section active">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-database"></i> Yeni Kişi / Harita Ekle</div>
                </div>
                
                <div style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; padding:15px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:#1e40af; font-size:14px;"><i class="fas fa-magic"></i> Hızlı Ekle (Smart Import)</h4>
                        <span style="font-size:11px; color:#1e40af;">Format: <b>İsim, Tarih Saat, Şehir, UTC, Kategori</b></span>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="smartInput" 
                               placeholder="Örn: Atatürk, 19.05.1881 12:00, Selanik, 1.58, Liderler" 
                               style="flex:1; padding:8px; border:1px solid #93c5fd; border-radius:4px; font-size:13px;">
                        <button type="button" onclick="smartParse()" 
                                style="background:#2563eb; color:white; border:none; padding:0 15px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:12px;">
                            OTOMATİK DOLDUR
                        </button>
                    </div>

                    <div style="border-top:1px solid #bfdbfe; padding-top:10px; margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:12px; font-weight:bold; color:#1e40af;">Veya Dosyadan Yükle (.sfch / .txt):</span>
                            <input type="file" id="chartFile" style="font-size:11px; color:#555;">
                            <button onclick="uploadChartFile()" style="background:#16a34a; color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:11px;">
                                <i class="fas fa-upload"></i> OKU VE DOLDUR
                            </button>
                        </div>
                        
                        <button onclick="autoClassifyByAsc()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-purple-700 shadow-sm flex items-center gap-2" style="background:#9333ea; border:none;">
                            <i class="fas fa-sort-amount-down"></i> OTOMATİK GRUPLA (YÜKSELEN)
                        </button>
                    </div>
                </div>

                <div style="background:#e3f2fd; color:#1565c0; padding:12px; border-radius:6px; margin-bottom:20px; font-size:13px; display:flex; gap:10px; align-items:center;">
                    <i class="fas fa-info-circle" style="font-size:18px;"></i> 
                    <div>
                        <strong>Otomatik Sınıflandırma:</strong> Dosyadan yüklenen haritalar "Bütün Haritalar" klasörüne eklenir. "Otomatik Grupla" butonu ile hepsini Yükselen Burçlarına göre ayırabilirsiniz.
                    </div>
                </div>
                
                <form action="/admin/add_chart" method="POST" enctype="multipart/form-data" class="admin-form" style="display:grid; grid-template-columns: 1fr 2fr; gap:25px;">
                    <div>
                        <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px;">Profil Fotoğrafı</label>
                        <input type="file" name="chart_image" accept="image/*" style="background:white; padding:5px;">
                        <label style="font-weight:bold; font-size:12px; margin-top:15px; display:block;">İsim Soyisim</label>
                        <input type="text" name="name" placeholder="Örn: Mustafa Kemal Atatürk" required>
                        <label style="font-weight:bold; font-size:12px; margin-top:10px; display:block;">Ek Etiket (Opsiyonel)</label>
                        <input type="text" name="category" placeholder="Örn: Siyasetçiler">
                    </div>
                    <div>
                        <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px;">Doğum Tarihi ve Saati</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="number" id="day" name="day" placeholder="Gün" required style="flex:1;">
                            <input type="number" id="month" name="month" placeholder="Ay" required style="flex:1;">
                            <input type="number" id="year" name="year" placeholder="Yıl" required style="flex:1.5;">
                            <input type="number" id="hour" name="hour" placeholder="Saat" required style="flex:1;">
                            <input type="number" id="minute" name="minute" placeholder="Dk" required style="flex:1;">
                        </div>
                        <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px;">Doğum Yeri ve Zaman Dilimi</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px; align-items: flex-start;">
                            <div style="flex-grow:1;">
                                <input type="text" id="city_search_input" placeholder="Şehir adı girin..." style="margin-bottom:0;">
                                <input type="hidden" id="location_name" name="location_name"> </div>
                            <button type="button" onclick="searchLocationAndTZ()" class="btn-search">BUL <i class="fas fa-search"></i></button>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
                            <div><label style="font-size:11px;">Enlem</label><input type="number" step="any" id="lat" name="lat" required style="background:#fff;"></div>
                            <div><label style="font-size:11px;">Boylam</label><input type="number" step="any" id="lon" name="lon" required style="background:#fff;"></div>
                            <div><label style="font-size:11px; color:#e67e22;">UTC</label><input type="number" step="0.01" id="tz_offset" name="tz" required style="background:#fff; border-color:#f39c12;"></div>
                        </div>
                        
                        <label style="font-weight:bold; font-size:12px; margin-top:15px; display:block;">Biyografi</label>
                        <textarea name="bio" rows="4" placeholder="Hayat hikayesi..."></textarea>
                        
                        <label style="font-weight:bold; font-size:12px; margin-top:10px; display:block;">Biyografi İçin Ekstra Fotoğraflar (İsteğe Bağlı)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="file" name="bio_image_1" accept="image/*" style="font-size:11px;">
                            <input type="file" name="bio_image_2" accept="image/*" style="font-size:11px;">
                            <input type="file" name="bio_image_3" accept="image/*" style="font-size:11px;">
                        </div>

                        <div style="grid-column: 1/-1; background:#fffbe6; padding:15px; border:1px solid #ffe58f; border-radius:6px; margin-top:15px;">
                            <h4 style="margin:0 0 10px 0; font-size:13px; color:#d48806; font-weight:bold;">
                                <i class="fas fa-question-circle"></i> Analiz Cevapları (Toplu Giriş)
                            </h4>
                            <p style="font-size:11px; color:#666; margin-bottom:5px;">
                                Lütfen 12 evin cevabını sırasıyla aşağıya yapıştırın. Her cevabın arasında <strong>1 SATIR BOŞLUK</strong> bırakın.
                            </p>
                            <textarea name="answers_bulk" rows="10" placeholder="1. Ev Cevabı...

2. Ev Cevabı...

3. Ev Cevabı..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-family: 'Segoe UI', sans-serif; font-size:12px; line-height:1.5;"></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="width:100%; margin-top:15px;">KAYDET VE HESAPLA</button>
                    </div>
                </form>
                
                <div style="margin-top:40px;">
                    <h4 style="border-bottom:1px solid #eee; padding-bottom:10px; color:#555;">Sistemdeki Kayıtlar</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>Foto</th><th>İsim</th><th>Sınıflandırma</th><th>İşlem</th></tr></thead>
                            <tbody>
                                {% for c in public_charts %}
                                <tr>
                                    <td>{% if c.image %}<img src="{{ url_for('static', filename='uploads/charts/' + c.image) }}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">{% else %}<i class="fas fa-user-circle" style="font-size:30px; color:#ccc;"></i>{% endif %}</td>
                                    <td><b>{{ c.name }}</b><br><span style="font-size:10px; color:#666;">{{ c.day }}.{{ c.month }}.{{ c.year }}</span></td>
                                    <td>
                                        <span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-size:11px;">Asc {{ c.asc_sign }}</span>
                                        <span style="background:#fff3e0; color:#ef6c00; padding:2px 6px; border-radius:4px; font-size:11px;">Güneş {{ c.sun_sign }}</span>
                                        <span style="background:#f3e5f5; color:#7b1fa2; padding:2px 6px; border-radius:4px; font-size:11px; display:block; margin-top:2px;">{{ c.category }}</span>
                                    </td>
                                    <td>
                                        <button onclick='openEditChartModal({{ c | tojson | safe }})' class="btn-edit">Düzenle</button>
                                        <a href="/admin/delete_chart/{{ c.id }}" class="btn-danger" onclick="return confirm('Silmek istiyor musunuz?')">Sil</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="egitimler" class="content-section">
            <div class="admin-card">
                <div class="card-header"><div class="card-title"><i class="fas fa-graduation-cap"></i> Eğitim Yönetimi</div></div>
                <form action="/admin/add_course" method="POST" enctype="multipart/form-data" class="admin-form" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div><label>Başlık</label><input type="text" name="title" required><input type="text" name="date" placeholder="Tarih" required><input type="text" name="link" placeholder="Link"></div>
                    <div><label>Görsel & Detay</label><input type="file" name="course_image"><textarea name="description" rows="3"></textarea></div>
                    <button type="submit" class="btn-primary" style="grid-column: 1/-1;">KAYDET</button>
                </form>
                <table>
                    <thead><tr><th>Görsel</th><th>Başlık</th><th>Tarih</th><th>İşlem</th></tr></thead>
                    <tbody>{% for c in courses %}<tr><td><img src="{{ url_for('static', filename='uploads/courses/' + c.image) }}" style="height:40px;"></td><td>{{ c.title }}</td><td>{{ c.date }}</td><td><a href="/admin/delete_course/{{ c.id }}" class="btn-danger">SİL</a></td></tr>{% endfor %}</tbody>
                </table>
            </div>
        </div>

        <div id="iletisim" class="content-section">
            <div class="admin-card">
                <div class="card-header"><div class="card-title"><i class="fas fa-address-card"></i> İletişim</div></div>
                <form action="/admin/update_contact" method="POST" enctype="multipart/form-data" class="admin-form">
                    <input type="text" name="email" value="{{ contact.get('email', '') }}" placeholder="E-posta"><input type="text" name="phone" value="{{ contact.get('phone', '') }}" placeholder="Telefon">
                    <textarea name="bio" rows="4">{{ contact.get('bio', '') }}</textarea>
                    <button type="submit" class="btn-primary">GÜNCELLE</button>
                </form>
            </div>
        </div>

        <div id="kullanicilar" class="content-section">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-users"></i> Üyeler ve Bilgileri</div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>İsim</th>
                                <th>Email</th>
                                <th>Telefon</th> <th>Şifre</th>   <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td><b>{{ user.name }}</b></td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.phone }}</td> <td style="font-family: monospace; color: #d35400;">{{ user.password }}</td> <td>
                                    <a href="/admin/delete_user/{{ user.email }}" class="btn-danger" onclick="return confirm('{{ user.name }} isimli kullanıcıyı silmek istediğinize emin misiniz?')">SİL</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="locationModal" class="modal-overlay">
        <div class="modal-content" style="max-width:400px;">
            <h4 style="margin-top:0;">Sonuçlar</h4>
            <div id="locationResultsList"></div>
            <button type="button" class="close-btn" onclick="closeLocationModal()">Kapat</button>
        </div>
    </div>

    <div id="editChartModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal-icon" onclick="closeEditChartModal()">✕</span>
            <h3 style="margin-top:0; color:#1565c0;"><i class="fas fa-edit"></i> Haritayı Düzenle</h3>
            
            <form id="editChartForm" method="POST" enctype="multipart/form-data" class="admin-form" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                
                <div>
                    <label style="font-weight:bold; font-size:12px;">İsim Soyisim</label>
                    <input type="text" id="edit_name" name="name" required>
                    
                    <label style="font-weight:bold; font-size:12px; margin-top:10px;">Kategori</label>
                    <input type="text" id="edit_category" name="category">
                    
                    <label style="font-weight:bold; font-size:12px; margin-top:10px;">Ana Profil Fotoğrafı</label>
                    <input type="file" name="chart_image" accept="image/*">
                </div>

                <div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="edit_day" name="day" placeholder="Gün" required><input type="number" id="edit_month" name="month" placeholder="Ay" required><input type="number" id="edit_year" name="year" placeholder="Yıl" required>
                    </div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="number" id="edit_hour" name="hour" placeholder="Sa" required><input type="number" id="edit_minute" name="minute" placeholder="Dk" required>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:10px;">
                        <input type="number" step="any" id="edit_lat" name="lat" placeholder="Lat" required>
                        <input type="number" step="any" id="edit_lon" name="lon" placeholder="Lon" required>
                        <input type="number" step="0.01" id="edit_tz" name="tz" placeholder="UTC" required>
                    </div>
                    <input type="text" id="edit_location_name" name="location_name" placeholder="Konum Adı" style="margin-top:5px;">
                </div>

                <div style="grid-column: 1/-1;">
                    <label style="font-weight:bold; font-size:12px;">Biyografi</label>
                    <textarea id="edit_bio" name="bio" rows="4"></textarea>
                    
                    <div style="background:#fffbe6; padding:10px; border:1px solid #ffe58f; border-radius:6px; margin-top:10px; margin-bottom:10px;">
                        <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px; color:#d48806;">Analiz Cevapları (Düzenle):</label>
                        <textarea id="edit_answers_bulk" name="answers_bulk" rows="6" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;"></textarea>
                    </div>

                    <label style="font-weight:bold; font-size:12px; margin-top:10px; display:block;">Biyografi Fotoğrafları (Değiştirmek İçin Seçin)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="file" name="bio_image_1" accept="image/*" style="font-size:11px; width:30%;">
                        <input type="file" name="bio_image_2" accept="image/*" style="font-size:11px; width:30%;">
                        <input type="file" name="bio_image_3" accept="image/*" style="font-size:11px; width:30%;">
                    </div>

                    <button type="submit" class="btn-primary" style="width:100%; margin-top:15px;">GÜNCELLE VE YENİDEN HESAPLA</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            const tabs = document.querySelectorAll('.nav-tab');
            if(sectionId === 'data') tabs[0].classList.add('active');
            if(sectionId === 'egitimler') tabs[1].classList.add('active');
            if(sectionId === 'iletisim') tabs[2].classList.add('active');
            if(sectionId === 'kullanicilar') tabs[3].classList.add('active');
            document.getElementById(sectionId).classList.add('active');
        }

        function closeLocationModal() { document.getElementById('locationModal').style.display = 'none'; }

        function searchLocationAndTZ() {
            const city = document.getElementById('city_search_input').value;
            const year = document.getElementById('year').value || 2000;
            const month = document.getElementById('month').value || 1;
            const day = document.getElementById('day').value || 1;

            fetch('/api/search_location', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ city: city, year: year, month: month, day: day })
            }).then(r=>r.json()).then(data => {
                if(data.success){
                    const list = document.getElementById('locationResultsList'); list.innerHTML='';
                    data.results.forEach(loc => {
                        const div = document.createElement('div'); div.className='location-item';
                        div.innerHTML = `<b>${loc.address}</b> UTC ${loc.tz_offset}`;
                        div.onclick = () => {
                            document.getElementById('lat').value=loc.lat; document.getElementById('lon').value=loc.lon;
                            document.getElementById('tz_offset').value=loc.tz_offset; document.getElementById('location_name').value=loc.address;
                            closeLocationModal();
                        };
                        list.appendChild(div);
                    });
                    document.getElementById('locationModal').style.display='flex';
                }
            });
        }

        function smartParse() {
            const text = document.getElementById('smartInput').value;
            if(!text) return;
            const btn = document.querySelector('button[onclick="smartParse()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            fetch('/api/admin/smart_parse', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: text}) })
            .then(r => r.json()).then(res => {
                btn.innerHTML = 'OTOMATİK DOLDUR';
                if(res.success) {
                    const d = res.data;
                    if(d.name) document.getElementsByName('name')[0].value = d.name;
                    if(d.year) document.getElementsByName('year')[0].value = d.year;
                    if(d.month) document.getElementsByName('month')[0].value = d.month;
                    if(d.day) document.getElementsByName('day')[0].value = d.day;
                    if(d.hour !== undefined) document.getElementsByName('hour')[0].value = d.hour;
                    if(d.minute !== undefined) document.getElementsByName('minute')[0].value = d.minute;
                    if(d.location_name) document.getElementsByName('location_name')[0].value = d.location_name;
                    if(d.lat) document.getElementsByName('lat')[0].value = d.lat;
                    if(d.lon) document.getElementsByName('lon')[0].value = d.lon;
                    if(d.tz !== undefined) document.getElementsByName('tz')[0].value = d.tz;
                    if(d.category) document.getElementsByName('category')[0].value = d.category;
                    alert("Bilgiler ayrıştırıldı!");
                } else { alert("Hata: " + res.error); }
            }).catch(err => { btn.innerHTML = 'OTOMATİK DOLDUR'; console.error(err); });
        }

        function uploadChartFile() {
            const fileInput = document.getElementById('chartFile');
            const file = fileInput.files[0];
            if (!file) { alert("Lütfen bir dosya seçin!"); return; }
            const formData = new FormData(); formData.append('file', file);
            const btn = document.querySelector('button[onclick="uploadChartFile()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 200+ Kişi İşleniyor...';
            btn.disabled = true;
            fetch('/api/admin/upload_sfch', { method: 'POST', body: formData }).then(r => r.json()).then(res => {
                btn.innerHTML = originalText; btn.disabled = false;
                if (res.success) { alert(res.message); location.reload(); } else { alert("Hata: " + res.error); }
            }).catch(e => { btn.innerHTML = originalText; btn.disabled = false; alert("Hata oluştu."); });
        }

        function autoClassifyByAsc() {
            if(!confirm("Tüm haritalar Yükselen Burçlarına göre klasörlenecek. Emin misiniz?")) return;
            const btn = document.querySelector('button[onclick="autoClassifyByAsc()"]');
            const oldText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...'; btn.disabled = true;
            fetch('/api/admin/auto_classify', { method: 'POST', headers: {'Content-Type': 'application/json'} })
            .then(r => r.json()).then(res => {
                if(res.success) { alert(res.message); location.reload(); } else { alert("Hata: " + res.error); }
            }).catch(err => alert("Hata oluştu.")).finally(() => { btn.innerHTML = oldText; btn.disabled = false; });
        }

        function openEditChartModal(chartData) {
            document.getElementById('editChartForm').action = "/admin/edit_chart/" + chartData.id;
            document.getElementById('edit_name').value = chartData.name;
            document.getElementById('edit_category').value = chartData.category;
            document.getElementById('edit_bio').value = chartData.bio;
            
            // CEVAPLARI DOLDUR (Buraya Eklendi)
            if (chartData.answers && Array.isArray(chartData.answers)) {
                document.getElementById('edit_answers_bulk').value = chartData.answers.join('\n\n');
            } else {
                document.getElementById('edit_answers_bulk').value = "";
            }

            document.getElementById('edit_day').value = chartData.day;
            document.getElementById('edit_month').value = chartData.month;
            document.getElementById('edit_year').value = chartData.year;
            document.getElementById('edit_hour').value = chartData.hour;
            document.getElementById('edit_minute').value = chartData.minute;
            document.getElementById('edit_lat').value = chartData.lat;
            document.getElementById('edit_lon').value = chartData.lon;
            document.getElementById('edit_tz').value = chartData.tz;
            document.getElementById('edit_location_name').value = chartData.location_name;
            document.getElementById('editChartModal').style.display = 'flex';
        }

        function closeEditChartModal() {
            document.getElementById('editChartModal').style.display = 'none';
        }
    </script>
</body>

</html>
