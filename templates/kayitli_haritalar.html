{% extends "layout.html" %}

{% block content %}
<div style="padding: 20px; max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', sans-serif;"> 
    
    <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 1.4em; font-weight: 600; color: #2c3e50; margin: 0; display: flex; align-items: center;">
            <i class="fas fa-archive" style="color: #f39c12; margin-right: 10px;"></i> Kayıtlı Haritalar
        </h3>
        
        <div style="display: flex; gap: 10px;">
            <button type="button" onclick="document.getElementById('createFolderModal').style.display='flex'" 
                    class="btn-secondary" 
                    style="background-color: #95a5a6; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; color: white; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                <i class="fas fa-folder-plus"></i> Klasör Ekle
            </button>
            
            <a href="{{ url_for('home', tab='natal') }}" 
               class="btn-primary" 
               style="background-color: #3498db; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; text-decoration: none; color: white; font-size: 12px; transition: background 0.2s; display: inline-flex; align-items: center;">
                <i class="fas fa-plus" style="margin-right:5px;"></i> Yeni Harita
            </a>
        </div>
    </div>

    {% if not is_logged_in %}
        <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; color: #856404; text-align: center; font-size: 14px;">
            <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
            <strong>Kayıtlı haritalarınızı görmek için lütfen giriş yapın.</strong>
            <br><br>
            <a href="/login" style="text-decoration: underline; color: #856404; font-weight: bold;">Giriş Yapmak İçin Tıklayın</a>
        </div>
    {% else %}
        
        {% if not saved_charts %}
            <div style="text-align: center; padding: 60px 20px; color: #999; background: #f9f9f9; border-radius: 10px; border: 2px dashed #eee;">
                <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
                <p style="font-size: 16px; margin-bottom: 5px; font-weight: 500;">Henüz kayıtlı hiçbir haritanız bulunmuyor.</p>
                <p style="font-size: 13px;">Harita ekranında <b>"Arşive Kaydet"</b> butonunu kullanarak buraya ekleyebilirsiniz.</p>
            </div>
        {% else %}
            
            {% if saved_charts is mapping %}
                {% for category_name, charts_in_category in saved_charts.items() %}
                    
                    <div style="font-size: 13px; font-weight: 700; color: #34495e; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 2px solid #e1e8ed; text-transform: uppercase; display: flex; align-items: center;">
                        <i class="fas fa-folder" style="color: #f39c12; margin-right: 8px; font-size: 16px;"></i>
                        {{ category_name }} 
                        <span style="font-weight: normal; font-size: 11px; color: #7f8c8d; margin-left: 10px; background: #f0f2f5; padding: 2px 8px; border-radius: 10px;">
                            {{ charts_in_category|length }} Harita
                        </span>
                    </div>

                    {% if not charts_in_category %}
                        <p style="font-size: 13px; color: #bdc3c7; font-style: italic; padding-left: 15px;">Bu klasör boş.</p>
                    {% else %}
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px;"> 
                        {% for chart in charts_in_category %}
                            
                            <div class="chart-card" style="background-color: #ffffff; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                                
                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 0; margin-right: 10px;">
                                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        {{ chart.name | default('İsimsiz', true) }}
                                    </div>
                                    <div style="font-size: 12px; color: #7f8c8d; display: flex; flex-direction: column; gap: 3px;">
                                        <span><i class="far fa-calendar-alt" style="color: #3498db; width: 14px; text-align: center;"></i> {{ chart.day }}.{{ chart.month }}.{{ chart.year }} {{ "%02d:%02d"|format(chart.hour, chart.minute) }}</span>
                                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><i class="fas fa-map-marker-alt" style="color: #e74c3c; width: 14px; text-align: center;"></i> {{ chart.location_name | default('Konum Yok', true) }}</span>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                    <a href="{{ url_for('load_chart_to_active', category=category_name, chart_id=chart.id) }}" title="Haritayı Aç" style="background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: 0.2s;">
                                        <i class="fas fa-play" style="font-size: 10px;"></i>
                                    </a>
                                    
                                    <button type="button" onclick="openMoveModal('{{ chart.id }}', '{{ category_name }}')" title="Klasöre Taşı" style="background-color: #e8f8f5; color: #16a085; border: 1px solid #a3e4d7; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;">
                                        <i class="fas fa-exchange-alt" style="font-size: 10px;"></i>
                                    </button>

                                    <a href="{{ url_for('edit_chart', category=category_name, chart_id=chart.id) }}" title="Düzenle" style="background-color: #f3e5f5; color: #8e44ad; border: 1px solid #e1bee7; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: 0.2s;">
                                        <i class="fas fa-pen" style="font-size: 10px;"></i>
                                    </a>

                                    <a href="{{ url_for('delete_saved_chart', category=category_name, chart_id=chart.id) }}" 
                                       onclick="return confirmDeletion('{{ chart.name }}');" 
                                       title="Sil" 
                                       style="background-color: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: 0.2s;">
                                        <i class="fas fa-trash" style="font-size: 10px;"></i>
                                    </a>
                                </div>

                            </div>
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<div id="createFolderModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h4 style="margin-top: 0; color: #2c3e50;">Yeni Klasör Oluştur</h4>
        <form action="/create_folder" method="POST">
            <input type="text" name="folder_name" placeholder="Klasör Adı (Örn: Aile)" required style="width:100%; padding:8px; margin:10px 0; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">
            <div style="display:flex; justify-content:flex-end; gap:5px;">
                <button type="button" onclick="document.getElementById('createFolderModal').style.display='none'" style="padding:6px 12px; background:#ccc; border:none; border-radius:4px; cursor:pointer;">İptal</button>
                <button type="submit" style="padding:6px 12px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;">Oluştur</button>
            </div>
        </form>
    </div>
</div>

<div id="moveChartModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h4 style="margin-top: 0; color: #2c3e50;">Haritayı Taşı</h4>
        <form action="/move_chart" method="POST">
            <input type="hidden" name="chart_id" id="move_chart_id">
            <input type="hidden" name="old_folder" id="move_old_folder">
            
            <label style="font-size:12px; font-weight: bold; display: block; margin-bottom: 5px;">Hedef Klasör:</label>
            <select name="new_folder" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
                {% for folder in user_folders %}
                    <option value="{{ folder }}">{{ folder }}</option>
                {% endfor %}
            </select>
            
            <div style="display:flex; justify-content:flex-end; gap:5px;">
                <button type="button" onclick="document.getElementById('moveChartModal').style.display='none'" style="padding:6px 12px; background:#ccc; border:none; border-radius:4px; cursor:pointer;">İptal</button>
                <button type="submit" style="padding:6px 12px; background:#16a085; color:white; border:none; border-radius:4px; cursor:pointer;">Taşı</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Silme Onayı İçin Fonksiyon
    function confirmDeletion(chartName) {
        return confirm('"' + chartName + '" haritasını silmek istediğinize emin misiniz?');
    }

    // Modal Açma Fonksiyonları
    function openMoveModal(chartId, oldFolder) {
        document.getElementById('move_chart_id').value = chartId;
        document.getElementById('move_old_folder').value = oldFolder;
        document.getElementById('moveChartModal').style.display = 'flex';
    }
    
    // Modal Dışına Tıklayınca Kapatma
    window.onclick = function(event) {
        if (event.target.className === 'modal-overlay') {
            event.target.style.display = "none";
        }
    }
</script>
{% endblock %}