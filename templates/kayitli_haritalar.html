{% extends "layout.html" %}

{% block content %}
<style>
    /* --- MODERN & KOMPAKT KAYITLI HARİTALAR STİLİ --- */
    .saved-container {
        /* ÜST BOŞLUK SIFIRLANDI */
        padding: 0 15px 20px 15px; 
        background-color: #f8f9fa;
        min-height: 100vh;
        font-family: 'Segoe UI', sans-serif;
    }

    /* Üst Bar (Header) - Daha İnce ve Yapışık */
    .saved-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: #fff;
        padding: 10px 15px; /* İç boşluk azaltıldı */
        border-bottom: 1px solid #e2e8f0;
        /* Köşeli yapıldı ve üst kenarlığı kaldırıldı (Tavana yapışması için) */
        border-radius: 0 0 8px 8px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .header-left h3 {
        margin: 0;
        /* BAŞLIK BOYUTU KÜÇÜLTÜLDÜ (20px -> 16px) */
        font-size: 16px; 
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
    }

    .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Arama Kutusu - Daha Kompakt */
    .search-wrapper {
        position: relative;
        margin-right: 10px;
    }
    .search-wrapper input {
        padding: 6px 12px 6px 30px; /* Daha ince */
        border: 1px solid #cbd5e1;
        border-radius: 4px; /* Yuvarlak yerine hafif köşeli */
        font-size: 12px;
        width: 200px;
        outline: none;
        transition: 0.3s;
        background: #f8fafc;
    }
    .search-wrapper input:focus { border-color: #3b82f6; background: #fff; }
    .search-wrapper i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 11px; }

    /* Butonlar - Daha Küçük */
    .btn-modern {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px; /* Yazı küçüldü */
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        transition: all 0.2s;
    }
    .btn-new-folder { background: #64748b; color: white; }
    .btn-new-folder:hover { background: #475569; }
    
    .btn-new-chart { background: #2563eb; color: white; }
    .btn-new-chart:hover { background: #1d4ed8; }

    /* Klasör Başlıkları - Küçültüldü */
    .folder-title {
        font-size: 13px; /* 14px -> 13px */
        font-weight: 700;
        color: #334155;
        margin: 20px 0 10px 0;
        padding-bottom: 5px;
        border-bottom: 1px solid #e2e8f0;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        letter-spacing: 0.5px;
    }
    .badge-count {
        background: #e2e8f0;
        color: #475569;
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 4px;
        margin-left: 8px;
    }

    /* Grid Yapısı */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
    }

    /* Kart Tasarımı - Daha Derli Toplu */
    .chart-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
    }
    .chart-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.08);
        border-color: #93c5fd;
    }

    .card-main {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }
    
    .card-icon {
        width: 38px;
        height: 38px;
        background: #eff6ff;
        color: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .card-info h4 { margin: 0 0 2px 0; font-size: 13px; color: #1e293b; font-weight: 700; }
    .card-details { font-size: 11px; color: #64748b; display: flex; flex-direction: column; gap: 1px; }
    .card-details i { width: 12px; text-align: center; color: #94a3b8; }

    /* Kart Alt Butonlar */
    .card-actions {
        display: flex;
        gap: 5px;
        padding-top: 8px;
        border-top: 1px solid #f1f5f9;
    }
    .action-btn {
        flex: 1;
        height: 26px; /* Buton yüksekliği azaltıldı */
        border-radius: 3px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        transition: 0.2s;
        text-decoration: none;
    }
    .btn-open { background: #e0f2fe; color: #0284c7; }
    .btn-open:hover { background: #bae6fd; }
    
    .btn-move { background: #f0fdf4; color: #16a34a; }
    .btn-move:hover { background: #dcfce7; }
    
    .btn-edit { background: #fff7ed; color: #ea580c; }
    .btn-edit:hover { background: #ffedd5; }
    
    .btn-delete { background: #fef2f2; color: #dc2626; }
    .btn-delete:hover { background: #fee2e2; }

    /* Modal Stili */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #1e293b; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .modal-form input, .modal-form select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; }
</style>

<div class="saved-container">
    
    <div class="saved-header">
        <div class="header-left">
            <h3><i class="fas fa-archive" style="color: #f59e0b; font-size: 16px;"></i> Kayıtlı Haritalar</h3>
        </div>
        <div class="header-actions">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="chartSearchInput" placeholder="Harita ara..." onkeyup="filterCharts()">
            </div>
            
            <button onclick="document.getElementById('createFolderModal').style.display='flex'" class="btn-modern btn-new-folder">
                <i class="fas fa-folder-plus"></i> Klasör
            </button>
            
            <a href="{{ url_for('home', tab='natal') }}" class="btn-modern btn-new-chart">
                <i class="fas fa-plus"></i> Yeni
            </a>
        </div>
    </div>

    {% if not is_logged_in %}
        <div style="padding: 30px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 6px; color: #92400e; text-align: center; font-size: 13px;">
            <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
            <h3>Giriş Yapmalısınız</h3>
            <p>Kayıtlı haritalarınızı görmek için lütfen giriş yapın.</p>
            <a href="/login" class="btn-modern btn-new-chart" style="display:inline-flex; margin-top:10px;">Giriş Yap</a>
        </div>
    {% else %}

        {% if not saved_charts %}
            <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 15px; color: #cbd5e1;"></i>
                <h3 style="font-size: 16px;">Henüz kayıtlı haritanız yok.</h3>
                <p style="font-size: 12px;">Harita ekranında "Arşive Kaydet" butonunu kullanarak ekleme yapabilirsiniz.</p>
            </div>
        {% else %}
            
            {% if saved_charts is mapping %}
                {% for category_name, charts_in_category in saved_charts.items() %}
                    
                    <div class="folder-section">
                        <div class="folder-title">
                            <i class="fas fa-folder" style="color: #f59e0b; margin-right: 8px;"></i>
                            {{ category_name }}
                            <span class="badge-count">{{ charts_in_category|length }}</span>
                        </div>

                        {% if not charts_in_category %}
                            <p style="color:#94a3b8; font-style:italic; padding-left:10px; font-size: 12px;">Bu klasör boş.</p>
                        {% else %}
                            
                            <div class="charts-grid">
                                {% for chart in charts_in_category %}
                                <div class="chart-card" data-name="{{ chart.name|lower }}" data-location="{{ chart.location_name|lower }}">
                                    
                                    <div class="card-main">
                                        <div class="card-icon">
                                            <i class="fas fa-user-astronaut"></i>
                                        </div>
                                        <div class="card-info">
                                            <h4>{{ chart.name | default('İsimsiz', true) }}</h4>
                                            <div class="card-details">
                                                <span><i class="far fa-calendar-alt"></i> {{ chart.day }}.{{ chart.month }}.{{ chart.year }} {{ "%02d:%02d"|format(chart.hour, chart.minute) }}</span>
                                                <span><i class="fas fa-map-marker-alt"></i> {{ chart.location_name | default('Konum Yok', true) }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-actions">
                                        <a href="{{ url_for('load_chart_to_active', category=category_name, chart_id=chart.id) }}" class="action-btn btn-open" title="Haritayı Aç">
                                            <i class="fas fa-play"></i>
                                        </a>
                                        
                                        <button onclick="openMoveModal('{{ chart.id }}', '{{ category_name }}')" class="action-btn btn-move" title="Klasöre Taşı">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>

                                        <a href="{{ url_for('edit_chart', category=category_name, chart_id=chart.id) }}" class="action-btn btn-edit" title="Düzenle">
                                            <i class="fas fa-pen"></i>
                                        </a>

                                        <a href="{{ url_for('delete_saved_chart', category=category_name, chart_id=chart.id) }}" class="action-btn btn-delete" onclick="return confirm('{{ chart.name }} haritasını silmek istediğinize emin misiniz?')" title="Sil">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>

                                </div>
                                {% endfor %}
                            </div>

                        {% endif %}
                    </div>

                {% endfor %}
            {% endif %}

        {% endif %}
    {% endif %}
</div>

<div id="createFolderModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">Yeni Klasör Oluştur</div>
        <form action="/create_folder" method="POST" class="modal-form">
            <input type="text" name="folder_name" placeholder="Klasör Adı (Örn: Aile)" required>
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('createFolderModal').style.display='none'" class="btn-modern" style="background:#e2e8f0; color:#475569;">İptal</button>
                <button type="submit" class="btn-modern btn-new-chart">Oluştur</button>
            </div>
        </form>
    </div>
</div>

<div id="moveChartModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">Haritayı Başka Klasöre Taşı</div>
        <form action="/move_chart" method="POST" class="modal-form">
            <input type="hidden" name="chart_id" id="move_chart_id">
            <input type="hidden" name="old_folder" id="move_old_folder">
            
            <label style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px; display:block;">Hedef Klasör:</label>
            <select name="new_folder">
                {% for folder in user_folders %}
                    <option value="{{ folder }}">{{ folder }}</option>
                {% endfor %}
            </select>
            
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('moveChartModal').style.display='none'" class="btn-modern" style="background:#e2e8f0; color:#475569;">İptal</button>
                <button type="submit" class="btn-modern btn-move">Taşı</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Canlı Arama Filtresi
    function filterCharts() {
        const input = document.getElementById('chartSearchInput');
        const filter = input.value.toLowerCase();
        const cards = document.getElementsByClassName('chart-card');

        for (let i = 0; i < cards.length; i++) {
            const name = cards[i].getAttribute('data-name');
            const loc = cards[i].getAttribute('data-location');
            if (name.includes(filter) || loc.includes(filter)) {
                cards[i].style.display = "flex";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    // Modal Açma
    function openMoveModal(chartId, oldFolder) {
        document.getElementById('move_chart_id').value = chartId;
        document.getElementById('move_old_folder').value = oldFolder;
        document.getElementById('moveChartModal').style.display = 'flex';
    }
    
    // Dışarı Tıklayınca Kapat
    window.onclick = function(event) {
        if (event.target.className === 'modal-overlay') {
            event.target.style.display = "none";
        }
    }
</script>

{% endblock %}
