<style>

    /* GENEL FORM KUTULARI VE YAZI BOYUTU (13px) */
    .form-group input, 
    .form-group select, 
    .form-control, 
    .form-select,
    .modal-city-input,
    #name, #day, #month, #year, #hour, #minute {
        font-size: 11px !important;
        padding: 5px 8px !important; /* Kutularƒ± daraltan kritik ayar */
        height: 30px !important;    /* Kutu y√ºksekliƒüini sabitledik */
        border-radius: 0px !important;
        background: rgba(255, 255, 255, 0.295) !important;
        color: rgb(24, 24, 24) !important;                    
        border: 1px solid rgba(48, 48, 48, 0.2) !important;
        width: 100%;
        box-sizing: border-box;
    }
    /* Validasyon Renkleri */
    .valid-utc {
        border: 2px solid #27ae60 !important;
        background-color: rgba(255, 255, 255, 0.2); 
        color: #27ae60 !important;
        font-weight: bold;
    }
    .invalid-utc {
        border: 2px solid #c0392b !important;
        background-color: rgba(255, 255, 255, 0.2); 
        color: #c0392b !important;
        font-weight: bold;
    }
    .utc-error-text {
        display: none;
        font-size: 9px;
        color: #c0392b;
        font-weight: bold;
        margin-top: 2px;
    }

    /* UTC Validasyon: Doƒüru Giri≈ü (Ye≈üil Kenarlƒ±klƒ± Cam) */
.valid-utc {
    border: 2px solid #27ae60 !important;
    background-color: rgba(255, 255, 255, 0.4) !important;
    color: #1e462f !important;
    font-weight: bold !important;
}

/* UTC Validasyon: Hatalƒ± Giri≈ü (Kƒ±rmƒ±zƒ± Kenarlƒ±klƒ± Cam) */
.invalid-utc {
    border: 2px solid #c0392b !important;
    background-color: rgba(255, 255, 255, 0.4) !important;
    color: #5c1b14 !important;
    font-weight: bold !important;
}

/* Hata Mesajƒ± Metni */
.utc-error-text {
    display: none;
    font-size: 10px;
    color: #c0392b;
    font-weight: bold;
    margin-top: 2px;
}

/* =========================================
   SAƒû KONUM MODAL (WHITE & BLUE VERSION)
   ========================================= */

/* 1. Dƒ±≈ü Ta≈üƒ±yƒ±cƒ± (Karartan ve Bulanƒ±kla≈ütƒ±ran Katman) */
#locationModal {
    z-index: 999999 !important;
    background: rgba(0, 0, 0, 0.4) !important; /* Arka planƒ± %40 siyah yapar */
    backdrop-filter: blur(4px) !important;      /* Arka planƒ± bulanƒ±kla≈ütƒ±rƒ±r */
    -webkit-backdrop-filter: blur(4px) !important;
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    align-items: center; 
    justify-content: center;
}

/* 2. Kutu Tasarƒ±mƒ± (170px Sabit - Beyaz Tema) */
#locationModal .modal-content, #locationModal .modal-box {
    position: absolute !important;
    width: 220px !important;
    background: rgba(42, 115, 145, 0.384) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(175, 175, 175, 0.644); /* ƒ∞nce gri √ßer√ßeve */
    box-shadow: 5px 5px 20px rgba(255, 255, 255, 0.15);
    margin: 0 !important;
    border-radius: 0px;
    padding: 10px !important;
    box-sizing: border-box !important;
}

/* Kapatma Butonu */
#locationModal .modal-close {
    position: absolute !important;
    top: 2px !important;
    right: 5px !important;
    font-size: 16px !important;
    color: #031724 !important; /* Gri √ßarpƒ± */
    background: none !important;
    border: none !important;
    cursor: pointer;
}

#locationModal .modal-close:hover {
    color: #05202c !important;
    /* Parlama Efekti */
    text-shadow: 0 0 8px rgba(13, 138, 187, 0.8), 
                 0 0 15px rgba(13, 138, 187, 0.4);
    
    /* Etkile≈üim: Hafif b√ºy√ºme ve d√∂nme */
    transform: scale(1.2) rotate(90deg);
    
    /* Ge√ßi≈ü hƒ±zƒ± */
    transition: all 0.3s ease-in-out;
    
    opacity: 1 !important;
}

/* Ba≈ülƒ±k (Mavi) */
#locationModal h4 {
    font-size: 14px !important;
    color: #072235 !important; /* Gri √ßarpƒ± */
    margin: 0 0 8px 0 !important;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 15px;
    padding-bottom: 3px;
    font-weight: bold;
    border-bottom: 1px solid rgba(13, 138, 187, 0.15); /* Hafif mavi alt √ßizgi */
}

/* Arama Alanƒ± Kapsayƒ±cƒ±sƒ± */
#locationModal .modal-content > div:not(#locationResultsList),
#locationModal .modal-box > div {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 1px !important;
    width: 100% !important;
}

/* BUL Butonu (Mavi) */
#locationModal button:not(.modal-close) {
    width: 35px !important;
    flex-shrink: 0 !important;
    font-size: 10px !important;
    height: 24px !important;
    padding: 0 !important;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #0d8abb !important; /* Mavi Buton */
    color: white !important;
    border: none !important;
    cursor: pointer;
}

#locationModal button:not(.modal-close):hover {
    background: #12a5df !important; /* Daha a√ßƒ±k mavi hover */
    box-shadow: 0 0 10px rgba(13, 138, 187, 0.3);
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Sonu√ß Listesi */
#locationResultsList, #locationResultList {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 1px !important;
    padding: 0;
    list-style: none;
}

/* Liste Elemanlarƒ± (Beyaz Tema √úst√º Siyah/Mavi Yazƒ±) */
.location-item, #locationResultList li {
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-start !important;
    padding: 5px 6px !important;
    cursor: pointer !important;
    border-bottom: 1px solid #eee !important;
    width: 100% !important;
    box-sizing: border-box !important;
    transition: all 0.2s ease;
}

/* ≈ûehir ƒ∞smi (Siyah) */
.loc-name {
    font-weight: bold !important;
    font-size: 11px !important;
    color: #17263d !important; /* Siyah isimler */
    line-height: 1.1 !important;
}

/* Alt Detaylar (Gri) */
.loc-details {
    display: flex !important;
    gap: 5px !important;
    font-size: 10px !important;
    color: #2b4264 !important; /* Siyah isimler */
}

/* UTC Vurgusu (Mavi) */
.loc-utc {
    color: #3e829c !important;
    font-weight: bold !important;
}

/* Liste Hover */
.location-item:hover, #locationResultList li:hover {
    background: rgba(13, 138, 187, 0.08) !important; /* √áok hafif mavi hover */
    padding-left: 8px !important;
}

/* Scrollbar Ayarƒ± */
#locationResultsList::-webkit-scrollbar { width: 5px; }
#locationResultsList::-webkit-scrollbar-thumb { background: #f4f5f5; }

</style>

<div class="form-group">
    <label for="name">ƒ∞sim (√ñrn: Atat√ºrk)</label>
    <input type="text" id="name" name="name" value="{{ current_chart_data.name if current_chart_data else 'Misafir' }}" required>
</div>

<div class="form-row three-col">
    <div class="form-group">
        <label for="day">G√ºn</label>
        <input type="number" id="day" name="day" min="1" max="31" value="{{ current_chart_data.day if current_chart_data else '19' }}" required>
    </div>
    <div class="form-group">
        <label for="month">Ay</label>
        <input type="number" id="month" name="month" min="1" max="12" value="{{ current_chart_data.month if current_chart_data else '5' }}" required>
    </div>
    <div class="form-group">
        <label for="year">Yƒ±l</label>
        <input type="number" id="year" name="year" min="-4000" max="3000" value="{{ current_chart_data.year if current_chart_data else '1881' }}" required placeholder="YYYY">
    </div>
</div>

<div class="form-row two-col">
    <div class="form-group">
        <label for="hour">Saat</label>
        <input type="number" id="hour" name="hour" min="0" max="23" value="{{ current_chart_data.hour if current_chart_data else '12' }}" required>
    </div>
    <div class="form-group">
        <label for="minute">Dakika</label>
        <input type="number" id="minute" name="minute" min="0" max="59" value="{{ current_chart_data.minute if current_chart_data else '0' }}" required>
    </div>
</div>

<div class="form-group">
    <label style="color: rgb(24, 24, 24); font-weight: bold; font-size: 11px;">üåç Konum ve Saat Dilimi Bul</label>
    
    <div style="display: flex; align-items: center; gap: 6px;">
        <input type="text" id="city_search_input" placeholder="≈ûehir adƒ± (√ñrn: Berlin)..." 
               style="flex-grow: 1; margin-bottom: 0; height: 28px; background: rgba(255, 255, 255, 0.295); color: rgb(24, 24, 24); border: 1px solid rgba(48, 48, 48, 0.2); border-radius: 0px; padding: 0 10px;">
        
        <button type="button" onclick="searchLocationAndTZ()" 
                style="width: auto; height: 28px; white-space: nowrap; background: rgba(3, 112, 27, 0.8); color: white; border: none; border-radius: 0px; padding: 0 8px; cursor: pointer; font-weight: bold; font-size: 10px; transition: 0.3s;">
            BUL <i class="fas fa-search"></i>
        </button>
    </div>
    
    <small class="form-text text-muted" style="font-size: 9px; color: rgb(60, 60, 60);">≈ûehri bulunca Enlem, Boylam ve UTC otomatik dolar.</small>
    
    <div id="selected_location_display" style="font-size: 11px; margin-top: 5px; color: #27ae60; font-weight: bold;">
        {% if current_chart_data and current_chart_data.location_name %}
            <i class="fas fa-check-circle"></i> {{ current_chart_data.location_name }}
        {% endif %}
    </div>
</div>

<div class="form-row three-col" style="margin-top: 10px;">
    <div class="form-group">
        <label for="lat" style="font-size: 10px; color: rgb(24, 24, 24);">Enlem</label>
        <input type="number" step="any" id="lat" name="lat" placeholder="Lat" 
               value="{{ current_chart_data.lat if current_chart_data else '' }}" required 
               style="background: rgba(255, 255, 255, 0.295); color: rgb(24, 24, 24); border: 1px solid rgba(48, 48, 48, 0.2); font-size: 11px; border-radius: 0px; width: 100%; padding: 8px;">
    </div>
    <div class="form-group">
        <label for="lon" style="font-size: 10px; color: rgb(24, 24, 24);">Boylam</label>
        <input type="number" step="any" id="lon" name="lon" placeholder="Lon" 
               value="{{ current_chart_data.lon if current_chart_data else '' }}" required 
               style="background: rgba(255, 255, 255, 0.295); color: rgb(24, 24, 24); border: 1px solid rgba(48, 48, 48, 0.2); font-size: 11px; border-radius: 0px; width: 100%; padding: 8px;">
    </div>
    
    <div class="form-group">
        <label for="tz_offset" style="font-size: 10px; color: rgb(24, 24, 24); font-weight: bold;">UTC </label>
        <input type="number" step="0.01" id="tz_offset" name="tz_offset" placeholder="3.0" 
               value="{{ current_chart_data.tz_offset if current_chart_data else '' }}" required 
               oninput="validateUtcInput(this)"
               style="background: rgba(255, 255, 255, 0.295); color: rgb(24, 24, 24); border: 1px solid rgba(48, 48, 48, 0.2); font-size: 11px; border-radius: 0px; width: 100%; padding: 8px;">
        <span id="utc_error" class="utc-error-text" style="display: none; font-size: 9px; color: #c0392b; font-weight: bold;">Hatalƒ± Deƒüer!</span>
    </div>
</div>

<input type="hidden" id="location_name" name="location_name" value="{{ current_chart_data.location_name if current_chart_data else '' }}">

<div class="form-row two-col">
    <div class="form-group">
        <label for="zodiac_type">Zodyak Tipi</label>
        <select id="zodiac_type" name="zodiac_type" class="form-select">
            <option value="Tropical" {% if not current_chart_data or current_chart_data.zodiac_type == 'Tropical' %}selected{% endif %}>Tropikal (Batƒ±)</option>
            
            <option value="Astronomik" {% if current_chart_data and current_chart_data.zodiac_type == 'Astronomik' %}selected{% endif %}>Astronomik (Ger√ßek G√∂ky√ºz√º)</option>
            
            <option value="Drakonik 0" {% if current_chart_data and current_chart_data.zodiac_type == 'Drakonik 0' %}selected{% endif %}>Drakonik (Klasik - 0¬∞ Ko√ß)</option>
            
            <option value="Drakonik 28" {% if current_chart_data and current_chart_data.zodiac_type == 'Drakonik 28' %}selected{% endif %}>Drakonik (Yƒ±ldƒ±zsal - 29¬∞ Ko√ß)</option>
        </select>
    </div>
    <div class="form-group">
        <label for="house_system_name">Ev Sistemi</label>
        <select id="house_system_name" name="house_system_name" class="form-select">
            {% for hs_name in motor.HOUSE_SYSTEMS.keys() %}
                <option value="{{ hs_name }}" {% if current_chart_data and current_chart_data.house_system == hs_name %}selected{% endif %}>
                    {{ hs_name }}
                </option>
            {% endfor %}
        </select>
    </div>
</div>

<div id="locationModal" class="modal-overlay">
    <div class="modal-content">
        <h4 style="margin-top:0;">Sonu√ßlar</h4>
        <div id="locationResultsList"></div>
        <button class="modal-close" onclick="closeLocationModal()">&times;</button>
    </div>
</div>

<script>
    // UTC Deƒüerini Doƒürulama
    function validateUtcInput(input) {
        if (input.value.includes(',')) input.value = input.value.replace(',', '.');
        const val = parseFloat(input.value);
        const errorMsg = document.getElementById('utc_error');
        if (!isNaN(val) && val >= -14 && val <= 14) {
            input.classList.remove('invalid-utc'); input.classList.add('valid-utc');
            if(errorMsg) errorMsg.style.display = 'none';
        } else {
            input.classList.remove('valid-utc'); input.classList.add('invalid-utc');
            if(errorMsg) errorMsg.style.display = 'block';
        }
    }

    // G√ºncellenmi≈ü Modal Fonksiyonu
function closeLocationModal(event) { 
    if (event) {
        event.preventDefault();    // Formun g√∂nderilmesini (y√∂nlendirmeyi) durdurur
        event.stopPropagation();   // Tƒ±klamanƒ±n arkadaki elementlere ge√ßmesini engelle
    }
    document.getElementById('locationModal').style.display = 'none'; 
}

    // Backend'e gidip ≈ûehri ve UTC'yi soran fonksiyon
    function searchLocationAndTZ() {
        const city = document.getElementById('city_search_input').value;
        const year = document.getElementById('year').value || new Date().getFullYear();
        const month = document.getElementById('month').value || new Date().getMonth() + 1;
        const day = document.getElementById('day').value || new Date().getDate();

        if (city.length < 3) { alert("L√ºtfen en az 3 harf girin."); return; }

        const btn = document.querySelector('#city_search_btn');
        // ƒ∞konu y√ºkleniyor yapabiliriz ama basit kalsƒ±n
        
        fetch('/api/search_location', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ city: city, year: year, month: month, day: day })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                const list = document.getElementById('locationResultsList');
                list.innerHTML = '';
                data.results.forEach(loc => {
                    const div = document.createElement('div');
                    div.className = 'location-item';
                    const tzSign = loc.tz_offset >= 0 ? '+' : '';
                    div.innerHTML = `<strong>${loc.address}</strong> <br> 
                                     <span class="badge-tz">UTC ${tzSign}${loc.tz_offset}</span> 
                                     <span style="font-size:0.8em; color:#666;">(Lat: ${loc.lat.toFixed(2)}, Lon: ${loc.lon.toFixed(2)})</span>`;
                    
                    div.onclick = function() {
                        document.getElementById('lat').value = loc.lat;
                        document.getElementById('lon').value = loc.lon;
                        document.getElementById('location_name').value = loc.address;
                        document.getElementById('tz_offset').value = loc.tz_offset;
                        document.getElementById('selected_location_display').innerHTML = `<i class="fas fa-check-circle"></i> ${loc.address}`;
                        validateUtcInput(document.getElementById('tz_offset'));
                        closeLocationModal();
                    };
                    list.appendChild(div);
                });
                document.getElementById('locationModal').style.display = 'flex';
            } else {
                alert("Konum bulunamadƒ±!");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Bir hata olu≈ütu.");
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        const utcInput = document.getElementById('tz_offset');
        if(utcInput && utcInput.value !== "") {
            validateUtcInput(utcInput);
        }
    });
</script>
