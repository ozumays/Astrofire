<div id="progressionModal" class="modal-overlay" style="display:none; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div class="synastry-modal-box" style="width: 800px; height: 620px; max-width: 95%; display:flex; flex-direction:column; background:white; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2); font-family: 'Segoe UI', sans-serif;">
        
        <div class="synastry-header" style="background: linear-gradient(135deg, #7c3aed, #a855f7); padding:12px 15px; color:white; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:700; font-size:13px; letter-spacing:0.5px;"><i class="fas fa-forward"></i> İlerletilmiş Haritalar</span>
            <span style="cursor:pointer; font-size:16px;" onclick="closeProgressionModal()">✕</span>
        </div>

        <div class="synastry-body" style="display:flex; flex:1; padding:15px; gap:15px; overflow:hidden;">
            
            <div style="flex:1.5; display:flex; flex-direction:column; border-right:1px solid #eee; padding-right:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="font-size:11px; color:#7c3aed; margin:0; font-weight:800; text-transform:uppercase;">HARİTA SEÇİN (NATAL)</h4>
                    <span id="progSelectionCount" style="font-size:10px; background:#f3e8ff; color:#7c3aed; padding:3px 8px; border-radius:10px; font-weight:bold; border:1px solid #e9d5ff;">0/1</span>
                </div>
                
                <div style="display:grid; grid-template-columns: 30px 2fr 1fr 0.8fr; padding:0 8px 5px 8px; border-bottom:1px solid #eee; margin-bottom:5px;">
                    <span></span> 
                    <span style="font-size:9px; font-weight:bold; color:#999;">İSİM</span>
                    <span style="font-size:9px; font-weight:bold; color:#999; text-align:center;">TARİH</span>
                    <span style="font-size:9px; font-weight:bold; color:#999; text-align:center;">ZODİAK</span>
                </div>

                <div class="synastry-list" style="flex:1; overflow-y:auto; border:1px solid #e9d5ff; background-color: #faf5ff; border-radius:4px; padding:2px;">
                    {% if active_charts %}
                        {% for chart in active_charts %}
                            {% if chart.type == 'natal' %}
                            <div class="prog-chart-item" 
                                 onclick="toggleProgChartSelection(this, {{ loop.index0 }})" 
                                 style="display:grid; grid-template-columns: 30px 2fr 1fr 0.8fr; align-items:center; padding:8px; margin-bottom:2px; border-bottom:1px solid rgba(0,0,0,0.03); cursor:pointer; transition:0.1s;">
                                
                                <div style="display:flex; justify-content:center;">
                                    <input type="checkbox" value="{{ loop.index0 }}" style="pointer-events:none;">
                                </div>
                                <div style="font-weight:700; font-size:11px; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                    {{ chart.name }}
                                </div>
                                <div style="font-size:10px; color:#666; text-align:center;">
                                    {{ chart.day }}.{{ chart.month }}.{{ chart.year }}
                                </div>
                                <div style="font-size:9px; color:#7c3aed; text-align:center; font-weight:600;">
                                    {{ chart.zodiac_type|default('Astronomik') }}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div style="padding:20px; text-align:center; color:#777; font-size:11px;">Aktif natal harita yok.</div>
                    {% endif %}
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; gap:12px; overflow-y:auto; max-height:100%; padding-right:5px;">
                
                <div style="background:#f8fafc; padding:12px; border-radius:6px; border:1px solid #e2e8f0;">
                    <label style="font-size:11px; font-weight:800; color:#475569; display:block; margin-bottom:8px; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">İLERLETİM TEKNİĞİ</label>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_technique" value="secondary" checked onchange="updateDateInputLabel()"> 
                            <span style="color:#333;"><b>İkincil İlerletim</b> (Secondary - 1 Gün=1 Yıl)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_technique" value="solar_arc" onchange="updateDateInputLabel()"> 
                            <span style="color:#333;"><b>Güneş Yayı</b> (Solar Arc - 1°=1 Yıl)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_technique" value="transit" onchange="updateDateInputLabel()"> 
                            <span style="color:#333;"><b>Transit</b> (Anlık Gökyüzü)</span>
                        </label>
                    </div>
                </div>

                <div id="progDateSection" style="background:#ecfdf5; padding:12px; border-radius:6px; border:1px solid #a7f3d0;">
                    <label id="dateInputLabel" style="font-size:11px; font-weight:800; color:#047857; display:block; margin-bottom:8px; border-bottom:1px solid #a7f3d0; padding-bottom:4px;">HEDEF TARİH (BUGÜN)</label>
                    
                    <div style="display:flex; gap:5px;">
                        <input type="datetime-local" id="progTargetDate" 
                               style="flex:1; padding:8px; border:1px solid #6ee7b7; border-radius:4px; font-size:12px; background:white; font-weight:bold; color:#064e3b;">
                        <button onclick="setNow()" style="background:#34d399; color:white; border:none; border-radius:4px; font-size:10px; font-weight:bold; cursor:pointer; padding:0 8px;">ŞİMDİ</button>
                    </div>

                    <p style="font-size:10px; color:#065f46; margin:5px 0 0 0; line-height:1.3;">
                        <i class="far fa-calendar-check"></i> Seçilen tekniğe göre bu tarih baz alınır.
                    </p>
                </div>

                <div style="background:#fef3c7; padding:12px; border-radius:6px; border:1px solid #fde68a;">
                    <label style="font-size:11px; font-weight:800; color:#92400e; display:block; margin-bottom:8px; border-bottom:1px solid #fde68a; padding-bottom:4px;">GÖRÜNTÜLEME TİPİ</label>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_mode" value="single" checked> 
                            <span style="color:#333;">Tekli Harita (Sadece İlerletilmiş)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_mode" value="dual"> 
                            <span style="color:#333;">İkili (Natal + İlerletilmiş)</span>
                        </label>
                    </div>
                </div>

                <div style="background:#fef3f2; padding:12px; border-radius:6px; border:1px solid #fecaca;">
                    <label style="font-size:11px; font-weight:800; color:#991b1b; display:block; margin-bottom:8px; border-bottom:1px solid #fecaca; padding-bottom:4px;">ZODYAK TİPİ</label>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_zodiac" value="Tropical"> 
                            <span style="color:#333;">Tropikal</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer; padding:4px;">
                            <input type="radio" name="prog_zodiac" value="Astronomik" checked> 
                            <span style="color:#333;">Astronomik</span>
                        </label>
                        </div>
                </div>

                <div style="margin-top:auto;">
                    <button type="button" id="btnProgCalc" onclick="submitProgression()" disabled 
                            style="width:100%; padding:11px; background:#94a3b8; color:white; border:none; border-radius:4px; font-weight:bold; cursor:not-allowed; box-shadow:none; transition:0.3s; font-size:11px; letter-spacing:0.5px;">
                        HESAPLA & KAYDET
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedProgIndex = null;

    // --- MODAL AÇILINCA ÇALIŞIR ---
    function openProgressionModal() { 
        document.getElementById('progressionModal').style.display = 'flex';
        setNow(); // Açılışta bugünün tarihini ayarla
        updateDateInputLabel();
    }
    
    function closeProgressionModal() { 
        document.getElementById('progressionModal').style.display = 'none'; 
        selectedProgIndex = null; 
        updateProgBtn(); 
        resetProgSelectionUI();
    }

    // --- TARİHİ "ŞİMDİ" YAPMA ---
    function setNow() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000; 
        const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
        document.getElementById('progTargetDate').value = localISOTime;
    }
    
    // --- ETİKET GÜNCELLEME ---
    function updateDateInputLabel() {
        const technique = document.querySelector('input[name="prog_technique"]:checked').value;
        const label = document.getElementById('dateInputLabel');
        
        if (technique === 'secondary') {
            label.innerText = "İKİNCİL İLERLETİM TARİHİ (HEDEF)";
            setNow(); // Her geçişte bugüne dönsün
        } else if (technique === 'solar_arc') {
            label.innerText = "SOLAR ARC HEDEF TARİHİ (1 Yıl = 1 Derece)";
            setNow();
        } else {
            label.innerText = "TRANSİT ZAMANI (ANLIK)";
            setNow();
        }
    }
    
    function resetProgSelectionUI() {
        document.querySelectorAll('#progressionModal .prog-chart-item').forEach(div => {
            div.style.backgroundColor = 'transparent';
            const inp = div.querySelector('input'); 
            if(inp) inp.checked = false;
        });
        document.getElementById('progSelectionCount').innerText = "0/1";
    }

    function toggleProgChartSelection(el, idx) { 
        const chk = el.querySelector('input'); 
        
        document.querySelectorAll('#progressionModal .prog-chart-item').forEach(item => {
            item.style.backgroundColor = 'transparent';
            const checkbox = item.querySelector('input');
            if(checkbox) checkbox.checked = false;
        });
        
        if(selectedProgIndex === idx) {
            selectedProgIndex = null;
            chk.checked = false;
            el.style.backgroundColor = 'transparent';
        } else {
            selectedProgIndex = idx;
            chk.checked = true;
            el.style.backgroundColor = '#7c3aed1a';
        }
        
        document.getElementById('progSelectionCount').innerText = (selectedProgIndex !== null ? "1" : "0") + "/1";
        updateProgBtn(); 
    }
    
    function updateProgBtn() { 
        const btn = document.getElementById('btnProgCalc'); 
        const isReady = (selectedProgIndex !== null);
        btn.disabled = !isReady;
        btn.style.background = isReady ? "#7c3aed" : "#94a3b8";
        btn.style.cursor = isReady ? "pointer" : "not-allowed";
    }

    // --- HESAPLAMA GÖNDER ---
    function submitProgression() { 
        if (selectedProgIndex === null) {
            alert("Lütfen bir harita seçin!");
            return;
        }
        
        const technique = document.querySelector('input[name="prog_technique"]:checked').value;
        const mode = document.querySelector('input[name="prog_mode"]:checked').value;
        const zodiac = document.querySelector('input[name="prog_zodiac"]:checked').value;
        
        // Hedef Tarihi Al
        const targetDateVal = document.getElementById('progTargetDate').value;
        if (!targetDateVal) { alert("Lütfen hedef tarih seçin!"); return; }

        const btn = document.getElementById('btnProgCalc');
        const oldText = btn.innerText;
        btn.innerText = "HESAPLANIYOR..."; 
        btn.disabled = true;

        const payload = { 
            chart_index: selectedProgIndex, 
            technique: technique,
            mode: mode,
            zodiac_type: zodiac,
            target_date: targetDateVal 
        };

        fetch('/api/calculate_progression', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(resp => {
            if(resp.success) {
                window.location.href = "/?tab=aktif";
            } else {
                alert("Hata: " + (resp.error || "Bilinmeyen hata"));
                btn.innerText = oldText; 
                btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Bağlantı hatası: " + err.message);
            btn.innerText = oldText; 
            btn.disabled = false;
        });
    }
</script>