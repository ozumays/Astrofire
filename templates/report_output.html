<style>
    /* --- MEVCUT STİLLERİN (Değişmedi) --- */
    .report-grid { display: flex; flex-direction: row; gap: 20px; width: 100%; align-items: flex-start; padding: 10px 5px; box-sizing: border-box; }
    .report-column-left, .report-column-right { flex: 1; background-color: #f0f7ff; border: 1px solid #cce0f5; border-radius: 8px; padding: 15px; min-width: 300px; box-shadow: 0 2px 5px rgba(21, 101, 192, 0.1); }
    .report-title { font-size: 11px; font-weight: 800; color: #1565c0; text-transform: uppercase; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px dotted #a6c8e6; display: block; letter-spacing: 0.5px; }
    .report-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; background-color: #ffffff; border-radius: 4px; overflow: hidden; border: 1px solid #cce0f5; }
    .report-table th { text-align: left; background-color: #dbe9f6; color: #1565c0; font-weight: 700; padding: 6px 8px; border-bottom: 1px solid #cce0f5; border-right: 1px solid #cce0f5; }
    .report-table td { padding: 6px 8px; color: #444; border-bottom: 1px solid #e1e8ed; border-right: 1px solid #e1e8ed; vertical-align: middle; }
    .report-table td:first-child { font-weight: 600; color: #1565c0; background-color: #fafcff; }
    .report-table tbody tr:hover td { background-color: #eef6fc; }
    
    /* İKON VE HÜCRE STİLLERİ */
    .cell-flex { display: flex; align-items: center; gap: 6px; } 
    .p-icon { width: 18px; height: 18px; object-fit: contain; display: block; filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.1)); }
    .compact-info { display: flex; align-items: center; font-size: 11px; }
    .deg-text { font-weight: bold; color: #222; margin-right: 2px; }
    .constellation-tag { font-family: monospace; color: #666; font-size: 10px; background: #eee; padding: 1px 4px; border-radius: 3px; margin-left: 4px; }
    .distance-val { font-weight: bold; color: #333; font-size: 11px; }

    /* DURUM ETİKETLERİ */
    .status-exact { color: #fff; background-color: #f1c40f; font-weight: bold; padding: 2px 5px; border-radius: 3px; font-size: 10px; } 
    .status-app { color: #27ae60; font-weight: bold; background-color: #eafaf1; padding: 2px 5px; border-radius: 3px; font-size: 10px; } 
    .status-sep { color: #c0392b; font-style: italic; background-color: #fdedec; padding: 2px 5px; border-radius: 3px; font-size: 10px; } 

    /* YENİ: TRANSİT TAHMİN STİLİ */
    .forecast-days { color: #d35400; font-weight: 800; font-size: 11px; }
    .forecast-retro { color: #c0392b; font-weight: bold; font-size: 10px; background: #fadbd8; padding: 2px 6px; border-radius: 4px; }
</style>

{% set planet_icons = { 
    'Güneş': 'gunes.svg', 
    'Ay': 'ay.svg', 
    'Merkür': 'merkur.svg', 
    'Venüs': 'venus.svg', 
    'Mars': 'mars.svg', 
    'Jüpiter': 'jupiter.svg', 
    'Satürn': 'saturn.svg', 
    'Uranüs': 'uranus.svg', 
    'Neptün': 'neptun.svg', 
    'Plüton': 'pluton.svg', 
    'Kuzey Düğümü': 'kuzey_dugumu.svg', 
    'Güney Düğümü': 'guney_dugumu.svg', 
    'Chiron': 'chiron.svg', 
    'Ceres': 'ceres.svg',
    'Pallas': 'pallas.svg',
    'Juno': 'juno.svg',
    'Vesta': 'vesta.svg',
    'Eris': 'eris.svg',
    'Makemake': 'makemake.svg',
    'Haumea': 'haumea.svg',
    'Lilith': 'lilith.svg', 
    'Şans Noktası': 'sans_noktasi.svg' 
} %}

{% if last_chart %}
    
    {# SİNASTRİ KONTROLÜ #}
    {% if last_chart.chart1 and last_chart.chart2 %}
        {# ============ SİNASTRİ RAPORU ============ #}
        <div class="report-grid">
            <div class="report-column-left">
                <span class="report-title">{{ last_chart.chart1.name or "Harita 1" }} - Gezegen Konumları</span>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="border-top-left-radius: 4px;">Gök Cismi</th>
                            <th>Burç</th>
                            <th>Konum</th>
                            <th>R</th>
                            <th style="border-top-right-radius: 4px;">Ev</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p_name in motor.PLANET_IDS.keys() %}
                            {% set p_data = last_chart.chart1.planets.get(p_name) %}
                            {% if p_data and p_data|length > 5 %}
                                <tr>
                                    <td>
                                        <div class="cell-flex">
                                            {% if p_name in planet_icons %}
                                                <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p_name]) }}" class="p-icon" alt="{{ p_name }}">
                                            {% endif %}
                                            <span>{{ p_name }}</span>
                                        </div>
                                    </td>
                                    <td>{{ p_data[3] }}</td>
                                    <td style="font-family: monospace;">{{ p_data[4] }}</td>
                                    <td style="color:red; font-weight: bold; text-align:center;">{{ p_data[5] }}</td>
                                    <td style="text-align:center;">{{ p_data[6] }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="report-column-right">
                <span class="report-title">{{ last_chart.chart2.name or "Harita 2" }} - Gezegen Konumları</span>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="border-top-left-radius: 4px;">Gök Cismi</th>
                            <th>Burç</th>
                            <th>Konum</th>
                            <th>R</th>
                            <th style="border-top-right-radius: 4px;">Ev</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p_name in motor.PLANET_IDS.keys() %}
                            {% set p_data = last_chart.chart2.planets.get(p_name) %}
                            {% if p_data and p_data|length > 5 %}
                                <tr>
                                    <td>
                                        <div class="cell-flex">
                                            {% if p_name in planet_icons %}
                                                <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p_name]) }}" class="p-icon" alt="{{ p_name }}">
                                            {% endif %}
                                            <span>{{ p_name }}</span>
                                        </div>
                                    </td>
                                    <td>{{ p_data[3] }}</td>
                                    <td style="font-family: monospace;">{{ p_data[4] }}</td>
                                    <td style="color:red; font-weight: bold; text-align:center;">{{ p_data[5] }}</td>
                                    <td style="text-align:center;">{{ p_data[6] }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <span class="report-title">İKİ HARİTA ARASINDAKİ AÇILAR (ASPECT HESAPLARI)</span>
            <table class="report-table">
                <thead>
                    <tr>
                        <th style="width:40%">{{ last_chart.chart1.name or "Harita 1" }}</th>
                        <th style="width:40%">{{ last_chart.chart2.name or "Harita 2" }}</th>
                        <th style="width:12%">Mesafe</th>
                        <th style="width:8%">Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p1_name, p1_data in last_chart.chart1.planets.items() %}
                        {% for p2_name, p2_data in last_chart.chart2.planets.items() %}
                            {% set diff = (p1_data[0]|float - p2_data[0]|float)|abs %}
                            {% if diff > 180 %}{% set diff = 360 - diff %}{% endif %}
                            
                            <tr>
                                <td>
                                    <div class="cell-flex">
                                        {% if p1_name in planet_icons %}
                                            <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p1_name]) }}" class="p-icon">
                                        {% endif %}
                                        <div class="compact-info">
                                            <span style="font-weight:bold; color:#1565c0; margin-right:4px;">{{ p1_name }}</span>
                                            {{ p1_data[4] }}
                                            <span class="constellation-tag">{{ p1_data[3]|upper }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="cell-flex">
                                        {% if p2_name in planet_icons %}
                                            <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p2_name]) }}" class="p-icon">
                                        {% endif %}
                                        <div class="compact-info">
                                            <span style="font-weight:bold; color:#1565c0; margin-right:4px;">{{ p2_name }}</span>
                                            {{ p2_data[4] }}
                                            <span class="constellation-tag">{{ p2_data[3]|upper }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="distance-val">{{ "%.1f"|format(diff) }}°</span></td>
                                <td>
                                    {% if diff < 1 %}<span class="status-exact">TAM</span>
                                    {% elif diff < 10 %}<span class="status-app">YAKIN</span>
                                    {% else %}<span class="status-sep">UZAK</span>{% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
    {% elif last_chart.planets %}
        {# ============ TEKLİ HARİTA RAPORU (ESKİ MANTIK) ============ #}
        <div class="report-grid">
        <div class="report-column-left">
            <span class="report-title">Gezegen Konumları</span>
            <table class="report-table">
                <thead>
                    <tr>
                        <th style="border-top-left-radius: 4px;">Gök Cismi</th>
                        <th>Burç</th>
                        <th>Konum</th>
                        <th>R</th>
                        <th style="border-top-right-radius: 4px;">Ev</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p_name in motor.PLANET_IDS.keys() %}
                        {% set p_data = last_chart.planets.get(p_name) %}
                        {% if p_data and p_data|length > 5 %}
                            <tr>
                                <td>
                                    <div class="cell-flex">
                                        {% if p_name in planet_icons %}
                                            <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p_name]) }}" class="p-icon" alt="{{ p_name }}">
                                        {% endif %}
                                        <span>{{ p_name }}</span>
                                    </div>
                                </td> 
                                <td>{{ p_data[3] }}</td> 
                                <td style="font-family: monospace;">{{ p_data[4] }}</td> 
                                <td style="color:red; font-weight: bold; text-align:center;">{{ p_data[5] }}</td>
                                <td style="text-align:center;">{{ p_data[6] }}</td> 
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="report-column-right">
            <span class="report-title">Ev Girişleri</span>
            <table class="report-table">
                <thead>
                    <tr><th style="border-top-left-radius: 4px;">Ev</th><th>Burç</th><th>Konum</th></tr>
                </thead>
                <tbody>
                    {% for i in range(1, 13) %}
                        {% set cusp_name = 'CUSP' ~ i %}
                        {% set cusp_deg = last_chart.houses.get(cusp_name) %}
                        {% if cusp_deg is not none %}
                            {% set cusp_info = get_relative_degree(cusp_deg, last_chart.get('zodiac_type', 'Astronomik')) %}
                            <tr>
                                <td>{{ i }}. Ev</td>
                                <td>{{ cusp_info[0] }}</td> 
                                <td style="font-family: monospace;">{{ cusp_info[2] }}</td> 
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <span class="report-title">MEVCUT AÇILAR VE YAKINLAŞMA DURUMU</span>
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width:35%">1. Gezegen</th>
                    <th style="width:35%">2. Gezegen</th>
                    <th style="width:15%">Mesafe</th>
                    <th style="width:15%">Durum</th>
                </tr>
            </thead>
            <tbody>
                {% set speed_order = ['Şans Noktası', 'Ay', 'Merkür', 'Venüs', 'Güneş', 'Mars', 'Jüpiter', 'Satürn'] %}
                {% set p_list = [] %}
                {% for pid in speed_order %}{% if last_chart.planets.get(pid) %}{% set _ = p_list.append(pid) %}{% endif %}{% endfor %}
                {% for pid in motor.PLANET_IDS.keys() %}{% if last_chart.planets.get(pid) and pid not in p_list %}{% set _ = p_list.append(pid) %}{% endif %}{% endfor %}

                {% for i in range(p_list|length) %}
                    {% for j in range(i + 1, p_list|length) %}
                        {% set p1 = p_list[i] %}
                        {% set p2 = p_list[j] %}
                        {% set d1 = last_chart.planets.get(p1) %}
                        {% set d2 = last_chart.planets.get(p2) %}
                        {% set diff = (d1[0]|float - d2[0]|float)|abs %}
                        {% if diff > 180 %}{% set diff = 360 - diff %}{% endif %}

                        <tr>
                            <td>
                                <div class="cell-flex">
                                    {% if p1 in planet_icons %}<img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p1]) }}" class="p-icon">{% endif %}
                                    <div class="compact-info"><span style="font-weight:bold; color:#1565c0; margin-right:4px;">{{ p1 }}</span> {{ d1[4] }} <span class="constellation-tag">{{ d1[3]|upper }}</span></div>
                                </div>
                            </td>
                            <td>
                                <div class="cell-flex">
                                    {% if p2 in planet_icons %}<img src="{{ url_for('static', filename='images/semboller/' + planet_icons[p2]) }}" class="p-icon">{% endif %}
                                    <div class="compact-info"><span style="font-weight:bold; color:#1565c0; margin-right:4px;">{{ p2 }}</span> {{ d2[4] }} <span class="constellation-tag">{{ d2[3]|upper }}</span></div>
                                </div>
                            </td>
                            <td><span class="distance-val">{{ "%.1f"|format(diff) }}°</span></td>
                            <td>
                                {% if diff < 1 %}<span class="status-exact">TAM</span>
                                {% elif diff < 10 %}<span class="status-app">YAKIN</span>
                                {% else %}<span class="status-sep">UZAK</span>{% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if transit_forecasts %}
    <div style="margin-top: 20px;">
        <span class="report-title">KESİN VARIŞ ZAMANLARI (TRANSİT MOTORU HESAPLAMASI)</span>
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width:25%">Hareketli (Hızlı)</th>
                    <th style="width:25%">Hedef Konum</th>
                    <th style="width:50%">Tahmini Varış Süresi</th>
                </tr>
            </thead>
            <tbody>
                {% for item in transit_forecasts %}
                <tr>
                    <td>
                        <div class="cell-flex">
                            {% if item.mover in planet_icons %}
                                <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[item.mover]) }}" class="p-icon">
                            {% endif %}
                            <span style="font-weight:bold; color:#1565c0;">{{ item.mover }}</span>
                        </div>
                    </td>

                    <td>
                        <div class="cell-flex">
                            {% if item.target in planet_icons %}
                                <img src="{{ url_for('static', filename='images/semboller/' + planet_icons[item.target]) }}" class="p-icon">
                            {% endif %}
                            <div class="compact-info">
                                <span class="deg-text">{{ "%.1f"|format(item.target_deg) }}°</span>
                                <span class="constellation-tag">{{ item.target_sign|upper }}</span>
                            </div>
                        </div>
                    </td>

                    <td>
                        {% if item.is_retro %}
                            <span class="forecast-retro">RETRO HAREKETLİ</span>
                        {% else %}
                            <span class="forecast-days">➔ {{ item.days_later }} GÜN SONRA</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% endif %}

{% else %}
    <p style="color: #777; padding: 10px;">Veri yok.</p>
{% endif %}
